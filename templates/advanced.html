<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hybrid Motor Analysis - Motor Analysis Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(42, 82, 152, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(42, 82, 152, 0.3); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(42, 82, 152, 0); }
        }
        
        .navbar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar h1 {
            font-size: 24px;
            font-weight: 300;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            transition: background 0.3s;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background: rgba(255,255,255,0.2);
        }
        
        .container { max-width: 1600px; margin: 20px auto; padding: 0 20px; }
        
        .panel { 
            background: white; 
            margin: 15px 0; 
            padding: 25px; 
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #2a5298;
            width: 100%;
            box-sizing: border-box;
            overflow: visible;
        }
        .panel h2 { 
            color: #1e3c72; 
            font-size: 20px; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #e9ecef; 
            padding-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .panel h2:before {
            content: "▶";
            margin-right: 10px;
            color: #2a5298;
        }
        
        /* Tooltip Styles */
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
        }
        
        .tooltip-icon {
            width: 16px;
            height: 16px;
            background: #6c757d;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            transition: background 0.3s;
        }
        
        .tooltip-icon:hover {
            background: #2a5298;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background: #2c3e50;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .form-group label {
            display: flex;
            align-items: center;
        }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 5px; 
            color: #495057;
        }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #e9ecef; 
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            border-color: #2a5298; 
            outline: none;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }
        .form-group .unit { 
            font-size: 12px; 
            color: #6c757d; 
            margin-left: 5px;
        }
        .form-group .help-text {
            font-size: 11px;
            color: #6c757d;
            margin-top: 3px;
        }
        
        .btn { 
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%); 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px;
            cursor: pointer; 
            margin: 8px; 
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.3);
        }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); }
        .btn-small { padding: 8px 16px; font-size: 12px; }
        
        .results { display: none; }
        .results-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 0 10px;
            }
            .panel {
                padding: 15px;
                margin: 10px 0;
            }
            .plot-container {
                min-height: 300px;
            }
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }
        .metric-value { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .metric-label { font-size: 14px; opacity: 0.9; }
        
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .data-table th { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white;
            padding: 12px; 
            text-align: left;
            font-weight: 600;
        }
        .data-table td { 
            padding: 12px; 
            border-bottom: 1px solid #e9ecef;
        }
        .data-table tr:nth-child(even) { background: #f8f9fa; }
        
        .plot-container { 
            min-height: 500px; 
            border: 2px solid #e9ecef; 
            border-radius: 8px;
            margin: 20px 0; 
            background: white;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow: visible;
            position: relative;
            z-index: 1;
            clear: both;
        }
        
        .plot-container .plotly {
            width: 100% !important;
            height: 100% !important;
        }
        
        #motor_3d_plot {
            min-height: 600px;
            margin: 20px 0;
            clear: both;
        }
        
        #injector_plot {
            min-height: 800px;
            width: 100%;
            background: white;
        }
        
        /* Fix overlapping issues */
        .panel + .panel {
            margin-top: 30px;
        }
        
        /* Ensure Export STL button is properly styled */
        #exportSTLBtn {
            cursor: pointer;
        }
        
        #exportSTLBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Improve plot visibility */
        .js-plotly-plot {
            width: 100% !important;
            height: 100% !important;
        }
        
        .main-svg {
            overflow: visible !important;
        }
        
        /* Panel styling for better separation */
        .panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .panel h2 {
            margin-top: 0;
            color: #2a5298;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        /* Export grid styles */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .export-section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            margin: 30px 0;
            clear: both;
            position: relative;
            z-index: 1;
        }
        
        .export-section h3 {
            margin-bottom: 15px;
            color: #2a5298;
            font-size: 18px;
        }
        
        .export-section button {
            width: 100%;
            margin: 10px 0;
        }
        
        .btn-group-export {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .btn-group-export button {
            width: auto;
            min-width: 160px;
            margin: 5px;
        }
        
        .status-message {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            min-height: 20px;
        }
        
        .cad-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }
        
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Configuration panel styles */
        .tab-content {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .tab-content.active {
            display: block !important;
        }
        
        #analysis_panel .tab-content {
            display: none !important;
        }
        
        #analysis_panel .tab-content.active {
            display: block !important;
        }
        
        .tab-content h3 {
            margin-bottom: 20px;
            color: #2a5298;
        }
        
        .alert { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 6px;
            border-left: 4px solid;
        }
        .alert-warning { 
            background: #fff3cd; 
            border-left-color: #ffc107; 
            color: #856404; 
        }
        .alert-danger { 
            background: #f8d7da; 
            border-left-color: #dc3545; 
            color: #721c24; 
        }
        .alert-success { 
            background: #d1edff; 
            border-left-color: #28a745; 
            color: #155724; 
        }
        .alert-info { 
            background: #cce7ff; 
            border-left-color: #17a2b8; 
            color: #0c5460; 
        }
        
        .chart-explanation {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .chart-explanation p {
            margin: 0 0 10px 0;
            font-weight: 500;
            color: #2a5298;
        }
        
        .chart-explanation ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .chart-explanation li {
            margin-bottom: 5px;
            color: #495057;
        }
        
        .chart-explanation li strong {
            color: #2a5298;
            font-weight: 600;
        }
        
        /* Safety Analysis Styles */
        .safety-analysis-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        
        .safety-tabs {
            display: flex;
            background: #e9ecef;
            border-radius: 6px;
            padding: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .safety-tab {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 13px;
            margin: 2px;
        }
        
        .safety-tab:hover {
            background: rgba(42, 82, 152, 0.1);
        }
        
        .safety-tab.active {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .safety-tab-content {
            display: none;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .safety-tab-content.active {
            display: block;
        }
        
        .risk-level-critical {
            color: #dc3545;
            font-weight: bold;
        }
        
        .risk-level-high {
            color: #fd7e14;
            font-weight: bold;
        }
        
        .risk-level-medium {
            color: #ffc107;
            font-weight: bold;
        }
        
        .risk-level-low {
            color: #28a745;
            font-weight: bold;
        }
        
        .safety-metric {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .safety-metric.safe {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .safety-metric.marginal {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .safety-metric.unsafe {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading { 
            text-align: center; 
            padding: 40px;
            color: #6c757d;
        }
        .spinner { 
            display: inline-block; 
            width: 30px; 
            height: 30px; 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #2a5298; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin-bottom: 10px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 10px 15px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            z-index: 1;
        }
        .tab:hover {
            background: rgba(42, 82, 152, 0.1);
        }
        .tab.active {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
        }
        .tab.active:hover {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
        }

        .altitude-profile {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .composition-editor {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .composition-row {
            display: grid;
            grid-template-columns: 2fr 1fr 60px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .database-status {
            font-size: 11px;
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 10px;
        }
        .status-connected { background: #d4edda; color: #155724; }
        .status-disconnected { background: #f8d7da; color: #721c24; }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="/static/js/app.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="navbar">
        <h1>MOTOR ANALYSIS - Hybrid Propellant</h1>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/hybrid" class="active">Hybrid</a>
            <a href="/solid">Solid</a>
            <a href="/liquid">Liquid</a>
            <a href="/formulas">Formulas</a>
        </div>
    </div>
    
    <div class="container">
        <script>
            // Disable HTML5 validation on all inputs
            document.addEventListener('DOMContentLoaded', function() {
                const inputs = document.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('invalid', function(e) {
                        e.preventDefault();
                    });
                });
            });
        </script>
        <!-- Motor Info Panel -->
        <div class="panel">
            <h2>Motor Information</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Motor Name
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Unique identifier for your motor design. Use a systematic naming convention including your organization/project code, motor type, and version number for proper documentation and tracking.</span>
                        </div>
                    </label>
                    <input type="text" id="motor_name" placeholder="e.g., UZAYTEK-HRM-001" title="Any characters allowed">
                </div>
                <div class="form-group">
                    <label>
                        Description
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Brief technical description of the motor design including purpose, key features, and intended application. This helps document design objectives and requirements for future reference.</span>
                        </div>
                    </label>
                    <textarea id="motor_description" rows="3" placeholder="Brief description of the motor..."></textarea>
                </div>
            </div>
        </div>

        <!-- Flight Environment Panel -->
        <div class="panel">
            <h2>Flight Environment</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchEnvironmentTab('single')">Single Altitude</button>
                <button class="tab" onclick="switchEnvironmentTab('profile')">Altitude Profile</button>
            </div>
            
            <div id="single_env" class="tab-content active">
                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            Altitude (m) <span class="unit">above sea level</span>
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Flight altitude above sea level in meters. Affects ambient pressure and nozzle performance. Sea level: 0m, Commercial aviation: 10000m, Space edge: 100000m. Higher altitude reduces ambient pressure, improving vacuum performance.</span>
                            </div>
                        </label>
                        <input type="number" id="single_altitude" value="0" min="0" max="50000" onchange="updateSinglePressure()">
                        <div class="help-text">Sea level = 0m, typical rocket: 0-10000m</div>
                    </div>
                    <div class="form-group">
                        <label>Ambient Pressure (bar) <span class="unit">calculated</span></label>
                        <input type="number" id="single_pressure" value="1.013" step="0.001" readonly>
                        <div class="help-text">Automatically calculated from altitude</div>
                    </div>
                </div>
            </div>
            
            <div id="profile_env" class="tab-content">
                <div class="altitude-profile">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>
                                Initial Altitude (m)
                                <div class="tooltip">
                                    <div class="tooltip-icon">?</div>
                                    <span class="tooltip-text">Starting altitude for trajectory analysis. Usually ground level (0m) for vertical launches or current altitude for air-launched systems. Analysis will calculate performance changes during ascent.</span>
                                </div>
                            </label>
                            <input type="number" id="alt_start" value="0" min="0" max="50000">
                        </div>
                        <div class="form-group">
                            <label>
                                Final Altitude (m)
                                <div class="tooltip">
                                    <div class="tooltip-icon">?</div>
                                    <span class="tooltip-text">Maximum altitude for trajectory analysis. Should represent apogee or desired analysis ceiling. Performance will be calculated at various altitudes between initial and final values.</span>
                                </div>
                            </label>
                            <input type="number" id="alt_end" value="10000" min="0" max="50000">
                        </div>
                        <div class="form-group">
                            <label>
                                Number of Points
                                <div class="tooltip">
                                    <div class="tooltip-icon">?</div>
                                    <span class="tooltip-text">Number of calculation points between initial and final altitude. More points provide smoother performance curves but require more computation time. 10-20 points typically sufficient for most analyses.</span>
                                </div>
                            </label>
                            <input type="number" id="alt_points" value="10" min="3" max="100">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-small" onclick="previewAltProfile()">Preview Profile</button>
                        </div>
                    </div>
                    <div id="altitude_preview" class="plot-container" style="min-height: 200px; display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Basic Parameters Panel -->
        <div class="panel">
            <h2>Basic Parameters</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchDesignTab('thrust_time')">Thrust & Time</button>
                <button class="tab" onclick="switchDesignTab('total_impulse')">Total Impulse</button>
            </div>
            
            <div id="thrust_time_design" class="tab-content active">
                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            Thrust (N) <span class="unit">Newton</span>
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">The force generated by the rocket motor in Newtons. This is the primary output parameter that determines how much acceleration the rocket will experience.</span>
                            </div>
                        </label>
                        <input type="number" id="thrust" value="1000" step="0.1" min="1">
                        <div class="help-text">Target thrust level for the motor</div>
                    </div>
                    <div class="form-group">
                        <label>
                            Burn Time (s) <span class="unit">seconds</span>
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">The duration of motor operation in seconds. Longer burn times typically mean lower thrust levels for the same total impulse.</span>
                            </div>
                        </label>
                        <input type="number" id="burn_time" value="10" step="0.1" min="0.1">
                        <div class="help-text">Total motor burn duration</div>
                    </div>
                </div>
                <div class="help-text" style="margin-top: 10px; background: #e7f3ff; padding: 10px; border-radius: 4px;">
                    <strong>Calculated Total Impulse:</strong> <span id="calculated_impulse">10,000 N⋅s</span>
                </div>
            </div>
            
            <div id="total_impulse_design" class="tab-content">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Total Impulse (N⋅s) <span class="unit">Newton⋅seconds</span></label>
                        <input type="number" id="total_impulse" value="10000" min="1000" max="1000000" step="100">
                        <div class="help-text">Total impulse that the motor should deliver</div>
                    </div>
                    <div class="form-group">
                        <label>Thrust (N) <span class="unit">optional - leave empty for auto</span></label>
                        <input type="number" id="thrust_impulse" placeholder="Auto calculated" min="100" max="100000" step="10">
                        <div class="help-text">Leave empty to auto-calculate optimal thrust</div>
                    </div>
                    <div class="form-group">
                        <label>Burn Time (s) <span class="unit">optional - leave empty for auto</span></label>
                        <input type="number" id="burn_time_impulse" placeholder="Auto calculated" min="1" max="300" step="0.1">
                        <div class="help-text">Leave empty to auto-calculate burn time</div>
                    </div>
                </div>
                <div class="help-text" style="margin-top: 10px; background: #fff3cd; padding: 10px; border-radius: 4px;">
                    <strong>Mode:</strong> Specify total impulse (N⋅s) and optionally thrust or burn time. The system will calculate the missing parameter.
                </div>
            </div>
                <div class="form-group">
                    <label>
                        O/F Ratio <span class="unit">oxidizer/fuel</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">The mass ratio of oxidizer to fuel. This critical parameter affects combustion efficiency, chamber temperature, and specific impulse. Typical values: 2-6 for N2O/HTPB systems.</span>
                        </div>
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="of_ratio" value="2.5" step="0.1" min="0.1" style="flex: 1;">
                        <button class="btn btn-small" onclick="findOptimumOF()" style="background: #28a745; color: white;">
                            Find Optimum
                        </button>
                    </div>
                    <div id="optimum_of_result" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
                </div>
                <div class="form-group">
                    <label>
                        Chamber Pressure (bar) <span class="unit">absolute</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">The combustion chamber pressure in bar. Higher pressures generally increase specific impulse but require stronger structures. Typical values: 10-50 bar for amateur motors, 100+ bar for commercial motors.</span>
                        </div>
                    </label>
                    <input type="number" id="chamber_pressure" value="20" step="0.1" min="1" onchange="validatePressures()">
                </div>
                <div class="form-group">
                    <label>
                        Tank Pressure (bar) <span class="unit">absolute</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">The oxidizer tank pressure required to inject oxidizer into the combustion chamber. Must be higher than chamber pressure to overcome injection pressure losses.</span>
                        </div>
                    </label>
                    <input type="number" id="tank_pressure" value="50" step="0.1" min="1" onchange="validatePressures()">
                    <div id="pressure_warning" style="color: #d63384; font-size: 12px; margin-top: 5px; display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Advanced Parameters Panel -->
        <div class="panel">
            <h2>Advanced Parameters</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        L* Value (m) <span class="unit">characteristic length</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Characteristic length - ratio of combustion chamber volume to throat area. Determines residence time for complete combustion. HTPB typically requires 0.8-1.5m. Higher values ensure complete combustion but increase motor weight.</span>
                        </div>
                    </label>
                    <input type="number" id="l_star" value="1.0" step="0.1" min="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Ae/At Ratio <span class="unit">expansion ratio, 0=auto</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Nozzle exit area to throat area ratio. Higher ratios provide better performance at altitude but increase nozzle size. Sea level: 4-8, High altitude: 15-25. Set to 0 for automatic optimization.</span>
                        </div>
                    </label>
                    <input type="number" id="expansion_ratio" value="0" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <label>
                        Nozzle Type
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Nozzle geometry type. Conical: simple to manufacture, 15° half-angle typical, 1-2% Isp penalty. Bell: optimized contour, maximum performance, more complex manufacturing. Bell nozzles provide higher efficiency.</span>
                        </div>
                    </label>
                    <select id="nozzle_type">
                        <option value="conical">Conical Nozzle</option>
                        <option value="bell">Bell Nozzle</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        Combustion Type
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Combustion chamber model. Infinite Area: assumes perfect mixing, simpler analysis. Finite Area: considers chamber geometry effects, more accurate for real motors with limited mixing length.</span>
                        </div>
                    </label>
                    <select id="combustion_type" onchange="updateCombustionParams()">
                        <option value="infinite">Infinite Area Combustion</option>
                        <option value="finite">Finite Area Combustion</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        Chamber Diameter (mm) <span class="unit">0=auto</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Inner diameter of combustion chamber. Determines fuel grain outer diameter and chamber volume. Auto-calculation uses L* and throat area. Manual entry allows custom chamber sizing.</span>
                        </div>
                    </label>
                    <input type="number" id="chamber_diameter_input" value="0" step="0.1" min="0">
                </div>
                
                <!-- Finite Combustion Parameters -->
                <div id="finite_combustion_params" style="display: none;">
                    <div class="form-group">
                        <label>
                            Contraction Ratio <span class="unit">Ac/At</span>
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Ratio of combustion chamber cross-sectional area to throat area. Higher ratios reduce oxidizer velocity in chamber, affecting mixing and combustion efficiency. Typical values: 2-8. Set to 0 for automatic calculation.</span>
                            </div>
                        </label>
                        <input type="number" id="contraction_ratio" value="0" step="0.1" min="0" max="10" 
                               onchange="updateFiniteParams('contraction')">
                        <div class="help-text">Chamber area to throat area ratio (leave 0 to calculate from mass flux)</div>
                    </div>
                    <div class="form-group">
                        <label>
                            Mass Flux (kg/m²⋅s) <span class="unit">Gox in chamber</span>
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Oxidizer mass flow rate per unit area in the combustion chamber. Affects fuel regression rate and combustion efficiency. Higher flux increases regression but may cause incomplete combustion. Typical: 50-500 kg/m²⋅s.</span>
                            </div>
                        </label>
                        <input type="number" id="mass_flux_chamber" value="0" step="10" min="0" max="1000"
                               onchange="updateFiniteParams('mass_flux')">
                        <div class="help-text">Oxidizer mass flux through chamber (leave 0 to calculate from contraction ratio)</div>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 4px; font-size: 12px;">
                        <strong>Note:</strong> Fill only ONE parameter. The other will be calculated automatically.
                    </div>
                </div>
            </div>
        </div>

        <!-- Fuel Configuration Panel -->
        <div class="panel">
            <h2>Fuel Configuration 
                <span class="database-status status-connected" id="cea_status">NASA CEA Connected</span>
            </h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Fuel Type
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Solid fuel material for hybrid rocket. HTPB: professional grade, excellent performance. Paraffin: high regression rate, good for small motors. PMMA/Plastics: readily available, moderate performance. Aluminum: metal additive for increased thrust.</span>
                        </div>
                    </label>
                    <select id="fuel_type" onchange="updateFuelConfig()">
                        <option value="htpb">HTPB (Hydroxyl-terminated polybutadiene)</option>
                        <option value="pe">Polyethylene</option>
                        <option value="pmma">PMMA (Polymethyl methacrylate)</option>
                        <option value="paraffin">Paraffin Wax</option>
                        <option value="abs">ABS Plastic</option>
                        <option value="pla">PLA Plastic</option>
                        <option value="carbon">Carbon (Graphite)</option>
                        <option value="aluminum">Aluminum Powder</option>
                        <option value="al2o3">Aluminum Oxide (Al2O3)</option>
                        <option value="mixture">Custom Mixture</option>
                        <option value="custom">Custom Fuel Composition</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        Fuel Density (kg/m³)
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Mass density of solid fuel. Affects regression rate and motor mass. HTPB: ~920 kg/m³, PMMA: ~1180 kg/m³, Paraffin: ~900 kg/m³. Higher density usually means more total impulse per unit volume.</span>
                        </div>
                    </label>
                    <input type="number" id="fuel_density" value="920" step="1" min="100">
                </div>
                <div class="form-group">
                    <label>
                        Regression Rate Coefficient (a) <span class="unit">m/s/(kg/m²·s)ⁿ</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Empirical constant in regression rate equation r = a × G^n, where G is oxidizer mass flux. Material-specific value obtained from ballistic testing. Higher values indicate faster-burning fuels.</span>
                        </div>
                    </label>
                    <input type="number" id="regression_a" value="0.0003" step="0.0001" min="0.0001" max="0.01">
                    <div class="help-text">Empirical coefficient for r = a × G^n</div>
                </div>
                <div class="form-group">
                    <label>
                        Regression Rate Exponent (n) <span class="unit">dimensionless</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Power law exponent in regression rate equation r = a × G^n. Determines sensitivity to oxidizer mass flux. Lower values (0.3-0.5) provide more stable combustion, higher values (0.6-0.8) are more mass flux sensitive.</span>
                        </div>
                    </label>
                    <input type="number" id="regression_n" value="0.5" step="0.1" min="0.1" max="1.0">
                    <div class="help-text">Typical values: HTPB=0.5, PE=0.8, PMMA=0.65</div>
                </div>
            </div>
            
            <div id="custom_fuel_mixture" style="display: none;">
                <div class="mixture-editor">
                    <h4>Custom Fuel Mixture</h4>
                    <div class="help-text">Enter mass percentages for each component. Total must equal 100%.</div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Paraffin (%) <span class="unit">mass fraction</span></label>
                            <input type="number" id="mixture_paraffin" value="70" min="0" max="100" step="1" onchange="updateMixtureDensity()">
                        </div>
                        <div class="form-group">
                            <label>Carbon/Graphite (%) <span class="unit">mass fraction</span></label>
                            <input type="number" id="mixture_carbon" value="10" min="0" max="100" step="1" onchange="updateMixtureDensity()">
                        </div>
                        <div class="form-group">
                            <label>Aluminum Oxide (%) <span class="unit">mass fraction</span></label>
                            <input type="number" id="mixture_al2o3" value="20" min="0" max="100" step="1" onchange="updateMixtureDensity()">
                        </div>
                        <div class="form-group">
                            <label>Aluminum Powder (%) <span class="unit">mass fraction</span></label>
                            <input type="number" id="mixture_aluminum" value="0" min="0" max="100" step="1" onchange="updateMixtureDensity()">
                        </div>
                        <div class="form-group">
                            <label>HTPB Binder (%) <span class="unit">mass fraction</span></label>
                            <input type="number" id="mixture_htpb" value="0" min="0" max="100" step="1" onchange="updateMixtureDensity()">
                        </div>
                        <div class="form-group">
                            <label>Other Additives (%) <span class="unit">mass fraction</span></label>
                            <input type="number" id="mixture_other" value="0" min="0" max="100" step="1" onchange="updateMixtureDensity()">
                        </div>
                    </div>
                    
                    <div class="mixture-summary" style="margin-top: 15px; padding: 10px; background: #f0f4f8; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>Total Mass Fraction:</strong>
                            <span id="mixture_total" style="font-weight: bold;">100%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>Calculated Density:</strong>
                            <span id="mixture_density_calc">1050 kg/m³</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <strong>Estimated Regression Rate:</strong>
                            <span id="mixture_regression_est">Higher than pure paraffin</span>
                        </div>
                        <div id="mixture_warning" style="color: #d63384; margin-top: 10px; display: none;">
                            Total must equal 100%!
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="custom_fuel_config" style="display: none;">
                <div class="composition-editor">
                    <h4>Custom Fuel Composition</h4>
                    <div class="help-text">Enter the chemical composition of your fuel. Data will be validated against NASA CEA database.</div>
                    
                    <div id="composition_rows">
                        <div class="composition-row">
                            <input type="text" placeholder="Chemical formula (e.g., C4H6)" class="compound">
                            <input type="number" placeholder="Mass %" class="percentage" min="0" max="100" step="0.1">
                            <button class="btn btn-small" onclick="removeCompositionRow(this)">Remove</button>
                        </div>
                    </div>
                    
                    <button class="btn btn-small" onclick="addCompositionRow()">Add Component</button>
                    <button class="btn btn-small btn-warning" onclick="validateComposition()">Validate with CEA</button>
                    
                    <div id="composition_validation" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- Oxidizer Configuration Panel -->
        <div class="panel">
            <h2>Oxidizer Configuration
                <span class="database-status status-connected" id="nist_status">NIST WebBook Connected</span>
            </h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Oxidizer Type
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Oxidizing agent for combustion. N2O: self-pressurizing, safe handling, moderate performance. LOX: highest performance, cryogenic storage. H2O2: green propellant, good performance. Air: simple but lowest performance.</span>
                        </div>
                    </label>
                    <select id="oxidizer_type" onchange="updateOxidizerProperties()">
                        <option value="n2o">Nitrous Oxide (N2O)</option>
                        <option value="lox">Liquid Oxygen (LOX)</option>
                        <option value="h2o2">Hydrogen Peroxide (H2O2)</option>
                        <option value="air">Compressed Air</option>
                        <option value="custom">Custom Oxidizer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        Phase
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Physical state of oxidizer during injection. Liquid: higher density, requires pressurization. Gas: lower density, simpler feed system. Phase affects injection system design and motor performance.</span>
                        </div>
                    </label>
                    <select id="oxidizer_phase">
                        <option value="liquid">Liquid</option>
                        <option value="gas">Gas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        Density (kg/m³)
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Mass density of oxidizer at storage conditions. Affects tank sizing, injection system design, and mixture ratio calculations. Liquid N2O: ~1220 kg/m³, LOX: ~1140 kg/m³. Auto-updated from NIST database.</span>
                        </div>
                    </label>
                    <input type="number" id="oxidizer_density" value="1004" step="0.1">
                    <div class="help-text">Auto-updated from NIST data based on temperature</div>
                </div>
                <div class="form-group">
                    <label>
                        Viscosity (Pa·s)
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Dynamic viscosity affecting flow through injection system. Lower viscosity reduces pressure losses. N2O: ~0.0002 Pa·s, affects injector hole sizing and pressure drop calculations. Auto-updated from NIST database.</span>
                        </div>
                    </label>
                    <input type="number" id="oxidizer_viscosity" value="0.0002" step="0.0001">
                    <div class="help-text">Auto-updated from NIST data</div>
                </div>
                <div class="form-group">
                    <label>
                        Temperature (K)
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Oxidizer temperature at storage/injection conditions. Affects density, viscosity, and vapor pressure. Room temperature: 293K (20°C). Critical for accurate property calculations and system design.</span>
                        </div>
                    </label>
                    <input type="number" id="oxidizer_temp" value="293" step="1" min="100" max="1000" onchange="updateOxidizerDensityFromTemp()">
                    <div class="help-text">Temperature affects density and viscosity</div>
                </div>
            </div>
        </div>

        <!-- Injector Panel -->
        <div class="panel">
            <h2>Injector Configuration</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Injector Type
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Oxidizer injection method. Showerhead: simple multi-hole pattern, easy manufacturing. Pintle: single central injector, good mixing, throttleable. Swirl: tangential injection, improved atomization, complex manufacturing.</span>
                        </div>
                    </label>
                    <select id="injector_type" onchange="updateInjectorParams()">
                        <option value="showerhead">Showerhead</option>
                        <option value="impingement">Impingement</option>
                        <option value="pintle">Pintle</option>
                        <option value="swirl">Swirl</option>
                        <option value="coaxial">Coaxial</option>
                    </select>
                </div>
            </div>
            
            <!-- Dynamic Parameters -->
            <div id="dynamic_params">
                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            Target Velocity (m/s)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Target oxidizer velocity through injection holes. Higher velocities improve atomization and mixing but increase pressure drop. Optimal range: 20-50 m/s for balance of performance and pressure loss.</span>
                            </div>
                        </label>
                        <input type="number" id="target_velocity" value="30">
                    </div>
                    <div class="form-group">
                        <label>
                            Min Hole Diameter (mm)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Minimum manufacturable hole diameter. Smaller holes improve atomization but are harder to manufacture and more prone to clogging. Consider available drilling/machining capabilities.</span>
                            </div>
                        </label>
                        <input type="number" id="hole_diameter_min" value="0.3" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>
                            Max Hole Diameter (mm)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Maximum allowable hole diameter. Larger holes reduce pressure drop but worsen atomization. Trade-off between manufacturing simplicity and injection quality.</span>
                            </div>
                        </label>
                        <input type="number" id="hole_diameter_max" value="2.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>
                            Plate Thickness (mm)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Injector plate thickness affects flow characteristics and structural integrity. Thicker plates provide better strength but longer flow development length. Typical: 2-6mm for small motors.</span>
                            </div>
                        </label>
                        <input type="number" id="plate_thickness" value="3.0" step="0.1">
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Type Panel -->
        <div class="panel" id="analysis_panel">
            <h2>Analysis Type</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('single')">Single Point Analysis</button>
                <button class="tab" onclick="switchTab('parametric')">Parametric Analysis</button>
                <button class="tab" onclick="switchTab('trajectory')">Trajectory Analysis</button>
            </div>
            
            <div id="single_tab" class="tab-content active" style="display: block;">
                <div class="form-group">
                    <button type="button" class="btn" onclick="calculate()">Calculate</button>
                    <button type="button" class="btn btn-success" onclick="switchTab('parametric')">Parametric Analysis</button>
                    <button type="button" class="btn btn-warning" onclick="exportReport()" id="exportResultsBtn" disabled>Export Results</button>
                    <button type="button" class="btn btn-info" onclick="generate3DCAD()" id="cadButton" style="display:none;">3D CAD Design</button>
                </div>
            </div>
            
            <div id="parametric_tab" class="tab-content">
                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            Parameter Type
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Parameter to vary during sweep analysis. O/F Ratio: optimize mixture ratio for performance. Chamber Pressure: study pressure effects. Expansion Ratio: optimize nozzle design. Altitude: analyze altitude performance.</span>
                            </div>
                        </label>
                        <select id="param_type">
                            <option value="of_ratio">O/F Ratio</option>
                            <option value="chamber_pressure">Chamber Pressure</option>
                            <option value="expansion_ratio">Expansion Ratio</option>
                            <option value="altitude">Altitude</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            Start Value
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Initial value for parameter sweep. Choose a reasonable lower bound for the parameter being studied. Analysis will step from this value to the end value.</span>
                            </div>
                        </label>
                        <input type="number" id="param_start" value="1.5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>
                            End Value
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Final value for parameter sweep. Choose a reasonable upper bound for the parameter being studied. Analysis will step from start value to this value.</span>
                            </div>
                        </label>
                        <input type="number" id="param_end" value="4.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>
                            Number of Steps
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Number of calculation points between start and end values. More steps provide smoother curves but require more computation time. 10-20 steps typically sufficient for most analyses.</span>
                            </div>
                        </label>
                        <input type="number" id="param_steps" value="10" min="3" max="50">
                    </div>
                </div>
                <button type="button" class="btn" onclick="calculateParametric()">Run Parametric Analysis</button>
                <div class="chart-explanation">
                    <p><strong>What this shows:</strong> Parameter sensitivity analysis across specified ranges</p>
                    <ul>
                        <li><strong>X-axis:</strong> Selected parameter variation (chamber pressure, O/F ratio, etc.)</li>
                        <li><strong>Y-axis:</strong> Performance metrics (Thrust, Isp, chamber pressure)</li>
                        <li><strong>Multiple lines:</strong> Different output parameters color-coded</li>
                        <li><strong>Optimal points:</strong> Peak performance highlighted with markers</li>
                        <li><strong>Applications:</strong> Design optimization and sensitivity assessment</li>
                        <li><strong>Design envelope:</strong> Feasible operating range bounded by constraints</li>
                    </ul>
                </div>
                <div id="parametric_plot" class="plot-container"></div>
            </div>
            
            <div id="trajectory_tab" class="tab-content">
                <div class="alert alert-info">
                    🚀 Trajectory analysis will calculate motor performance throughout the flight profile, 
                    accounting for altitude-dependent ambient pressure changes.
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            Initial Altitude (m)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Starting altitude for trajectory analysis. Usually ground level (0m) for vertical launches or current altitude for air-launched systems.</span>
                            </div>
                        </label>
                        <input type="number" id="traj_alt_start" value="0" min="0" max="50000">
                    </div>
                    <div class="form-group">
                        <label>
                            Final Altitude (m)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Maximum altitude for trajectory analysis. Should represent apogee or desired analysis ceiling.</span>
                            </div>
                        </label>
                        <input type="number" id="traj_alt_end" value="10000" min="0" max="100000">
                    </div>
                    <div class="form-group">
                        <label>
                            Analysis Points
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Number of calculation points along the trajectory. More points provide smoother curves but require more computation time.</span>
                            </div>
                        </label>
                        <input type="number" id="traj_points" value="20" min="5" max="100">
                    </div>
                    <div class="form-group">
                        <label>
                            Initial Mass (kg)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Total vehicle mass at ignition including propellant, structure, and payload.</span>
                            </div>
                        </label>
                        <input type="number" id="initial_mass" value="50" min="1" max="10000" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>
                            Final Mass (kg)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Vehicle mass after propellant consumption (dry mass + payload).</span>
                            </div>
                        </label>
                        <input type="number" id="final_mass" value="25" min="1" max="10000" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>
                            Drag Coefficient
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Aerodynamic drag coefficient. Typical values: 0.3-0.5 for streamlined rockets, 0.5-0.8 for basic shapes.</span>
                            </div>
                        </label>
                        <input type="number" id="drag_coefficient" value="0.5" min="0.1" max="2.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>
                            Reference Area (m²)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Cross-sectional area used for drag calculations. Usually the maximum cross-sectional area of the vehicle.</span>
                            </div>
                        </label>
                        <input type="number" id="reference_area" value="0.1" min="0.001" max="10" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>
                            Launch Angle (degrees)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Initial launch angle from horizontal. 90° = vertical launch, 45° = maximum range trajectory.</span>
                            </div>
                        </label>
                        <input type="number" id="launch_angle" value="90" min="0" max="90" step="1">
                    </div>
                    <div class="form-group">
                        <label>
                            Wind Speed (m/s)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Horizontal wind speed affecting trajectory. Positive values represent tailwind.</span>
                            </div>
                        </label>
                        <input type="number" id="wind_speed" value="0" min="0" max="50" step="0.1">
                    </div>
                </div>
                
                <button type="button" class="btn" onclick="calculateTrajectory()">Calculate Trajectory Performance</button>
                <div class="chart-explanation">
                    <p><strong>What this shows:</strong> Motor performance during atmospheric flight trajectory</p>
                    <ul>
                        <li><strong>X-axis:</strong> Time (s) from motor ignition</li>
                        <li><strong>Y-axes:</strong> Multiple performance parameters vs time</li>
                        <li><strong>Blue line:</strong> Altitude (m) - vehicle height above ground</li>
                        <li><strong>Red line:</strong> Thrust (N) - motor thrust accounting for back pressure</li>
                        <li><strong>Green line:</strong> Velocity (m/s) - vehicle velocity</li>
                        <li><strong>Orange line:</strong> Atmospheric pressure (Pa) at current altitude</li>
                        <li><strong>Applications:</strong> Flight trajectory optimization and staging analysis</li>
                    </ul>
                </div>
                <div id="trajectory_plot" class="plot-container"></div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Calculating...</p>
        </div>

        <!-- Messages -->
        <div id="messages"></div>

        <!-- Results -->
        <div id="resultsPanel" class="results">
            <!-- AI Analysis Button -->
            <div style="text-align: center; margin: 20px 0;">
                <button type="button" class="btn btn-ai" onclick="askAI()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
                    <i class="fas fa-robot"></i> Ask AI to Analyze Results
                </button>
            </div>
            
            <!-- Performance Metrics -->
            <div class="panel">
                <h2>Performance Summary</h2>
                <div id="performanceMetrics"></div>
            </div>

            <!-- Results Grid -->
            <div class="results-grid">
                <!-- Motor Design -->
                <div class="panel">
                    <h2>Motor Design</h2>
                    <table class="data-table" id="motor_table">
                        <thead>
                            <tr><th>Parameter</th><th>Value</th><th>Unit</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <!-- Design Report -->
                <div class="panel">
                    <h2>Design Report</h2>
                    <div id="designReport"></div>
                </div>

                <!-- Injector Design -->
                <div class="panel">
                    <h2>Injector Design</h2>
                    <table class="data-table" id="injector_table">
                        <thead>
                            <tr><th>Parameter</th><th>Value</th><th>Unit</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Plots -->
            <div class="results-grid" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                <div class="panel" style="width: 100%;">
                    <h2>Motor Cross-Section</h2>
                    <div class="chart-explanation">
                        <p><strong>What this shows:</strong> 2D cross-sectional view of the hybrid rocket motor geometry</p>
                        <ul>
                            <li><strong>Blue area:</strong> Combustion chamber containing solid fuel grain</li>
                            <li><strong>Red area:</strong> Nozzle throat (minimum flow area)</li>
                            <li><strong>Green area:</strong> Nozzle expansion section</li>
                            <li><strong>Dimensions:</strong> All measurements in millimeters (mm)</li>
                            <li><strong>Reference:</strong> Optimized geometry based on thrust requirements and O/F ratio</li>
                        </ul>
                    </div>
                    <div id="motor_plot" class="plot-container" style="min-height: 500px;"></div>
                </div>

                <div class="panel" style="width: 100%;">
                    <h2>Performance Analysis Dashboard</h2>
                    <div class="chart-explanation">
                        <p><strong>What this shows:</strong> Comprehensive motor performance metrics</p>
                        <ul>
                            <li><strong>Mass Flow Rates:</strong> Total, oxidizer, and fuel flow rates (kg/s)</li>
                            <li><strong>Pressure Distribution:</strong> Chamber, tank, and injector pressure drop (bar)</li>
                            <li><strong>Regression Rate:</strong> Fuel grain burn rate over time (mm/s) with port diameter growth</li>
                            <li><strong>Injector Performance:</strong> Exit velocity gauge showing injection effectiveness (m/s)</li>
                            <li><strong>Design validation:</strong> All parameters optimized for stable combustion</li>
                        </ul>
                    </div>
                    <div id="injector_plot" class="plot-container" style="min-height: 800px; margin-bottom: 100px;"></div>
                </div>
                
                <div class="panel" style="width: 100%;">
                    <h2>Performance Analysis</h2>
                    <div class="chart-explanation">
                        <p><strong>What this shows:</strong> Multi-panel performance analysis over burn time</p>
                        <ul>
                            <li><strong>Top-left:</strong> Thrust vs Time (N) - Shows thrust profile and performance consistency</li>
                            <li><strong>Top-right:</strong> Specific Impulse vs Time (s) - Efficiency metric (higher = more efficient)</li>
                            <li><strong>Middle-left:</strong> Chamber Pressure vs Time (bar) - Internal pressure evolution</li>
                            <li><strong>Middle-right:</strong> Mass Flow Rate vs Time (kg/s) - Propellant consumption</li>
                            <li><strong>Bottom-left:</strong> O/F Ratio vs Time - Oxidizer/fuel ratio drift due to regression</li>
                            <li><strong>Bottom-right:</strong> Port Diameter vs Time (mm) - Fuel grain erosion pattern</li>
                            <li><strong>Optimal ranges:</strong> Isp > 200s, O/F = 6-8 for N2O/HTPB</li>
                        </ul>
                    </div>
                    <div id="performance_plots" class="plot-container" style="min-height: 800px; margin-bottom: 100px;"></div>
                </div>
            </div>
            
            <!-- Export/CAD Actions Panel -->
            <div id="exportActionsPanel" class="panel" style="display: none; margin-top: 150px; clear: both;">
                <h2>Export & CAD Options</h2>
                <div class="export-grid">
                    <div class="export-section">
                        <h3>3D CAD Design</h3>
                        <div class="btn-group-export">
                            <button class="btn btn-primary" onclick="showDesignConfig()">
                                <i class="fas fa-cog"></i> Configure Design
                            </button>
                            <button class="btn btn-primary" onclick="generateCAD()" id="generateCADBtn" disabled>
                                <i class="fas fa-cube"></i> Generate 3D Model
                            </button>
                        </div>
                        <div id="cadStatus" class="status-message"></div>
                    </div>
                    
                    <div class="export-section">
                        <h3>Regression Analysis</h3>
                        <div class="btn-group-export">
                            <button class="btn btn-info" onclick="performRegressionAnalysis()" id="regressionBtn" disabled>
                                <i class="fas fa-chart-line"></i> Analyze Regression Rate
                            </button>
                            <button class="btn btn-secondary" onclick="exportRegressionData()" id="exportRegressionBtn" disabled>
                                <i class="fas fa-download"></i> Export Analysis
                            </button>
                        </div>
                        <div id="regressionResults" class="analysis-results" style="display: none;">
                            <div id="regressionChart"></div>
                            <div id="regressionData"></div>
                        </div>
                    </div>
                    
                    <div class="export-section">
                        <h3>Motor Export</h3>
                        <div class="btn-group-export">
                            <button class="btn btn-primary" onclick="downloadEngFile()" id="downloadEngBtn" disabled>
                                <i class="fas fa-download"></i> Download Motor File (.eng)
                            </button>
                            <button class="btn btn-secondary" onclick="exportSTL()" id="exportSTLBtn" disabled>
                                <i class="fas fa-cube"></i> Export STL Files
                            </button>
                        </div>
                        <div id="openrocketStatus" class="status-message"></div>
                    </div>
                    
                    <div class="export-section">
                        <h3>Complete Package</h3>
                        <div class="btn-group-export">
                            <button class="btn btn-success" onclick="generateCompletePackage()">
                                <i class="fas fa-archive"></i> Generate All Files
                            </button>
                        </div>
                        <div id="packageStatus" class="status-message"></div>
                    </div>
                </div>
            </div>
            
            <!-- Design Configuration Panel -->
            <div id="designConfigPanel" class="panel" style="display: none;">
                <h2>Design Configuration</h2>
                <div class="tabs">
                    <button class="tab active" onclick="switchConfigTab('motor_config')">Motor Design</button>
                    <button class="tab" onclick="switchConfigTab('injector_config')">Injector Design</button>
                </div>
                
                <!-- Motor Configuration -->
                <div id="motor_config" class="tab-content active">
                    <h3>Motor Design Parameters</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>
                                Chamber Material
                                <div class="tooltip">
                                    <div class="tooltip-icon">?</div>
                                    <span class="tooltip-text">Material for combustion chamber construction. Steel 304: cost-effective, good strength. Aluminum 6061: lightweight, moderate strength. Inconel 718: high-temperature superalloy, expensive but excellent for extreme conditions.</span>
                                </div>
                            </label>
                            <select id="chamber_material" class="form-control">
                                <option value="steel_304">AISI 304 Stainless Steel</option>
                                <option value="aluminum_6061">Aluminum 6061-T6</option>
                                <option value="inconel_718">Inconel 718</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                Wall Thickness (mm)
                                <div class="tooltip">
                                    <div class="tooltip-icon">?</div>
                                    <span class="tooltip-text">Thickness of chamber wall. Must withstand internal pressure with safety factor. Thicker walls are stronger but heavier. Calculated based on hoop stress analysis and material yield strength.</span>
                                </div>
                            </label>
                            <input type="number" id="wall_thickness" class="form-control" value="5" min="2" max="20" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>
                                Safety Factor
                                <div class="tooltip">
                                    <div class="tooltip-icon">?</div>
                                    <span class="tooltip-text">Factor of safety for structural design. Ratio of ultimate strength to maximum expected stress. Amateur rockets: 4-6, Commercial: 2-4. Higher values increase safety but add weight.</span>
                                </div>
                            </label>
                            <input type="number" id="safety_factor" class="form-control" value="4.0" min="2" max="6" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Nozzle Material</label>
                            <select id="nozzle_material" class="form-control">
                                <option value="graphite">Graphite</option>
                                <option value="tungsten">Tungsten</option>
                                <option value="copper">Copper (Regeneratively Cooled)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Chamber Length Override (mm)</label>
                            <input type="number" id="chamber_length_override" class="form-control" placeholder="Auto-calculated" step="10">
                        </div>
                        <div class="form-group">
                            <label>Nozzle Contour</label>
                            <select id="nozzle_contour" class="form-control">
                                <option value="conical">15° Conical</option>
                                <option value="bell">80% Bell (Rao)</option>
                                <option value="parabolic">Parabolic</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Injector Configuration -->
                <div id="injector_config" class="tab-content" style="display: none;">
                    <h3>Injector Design Parameters</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Injector Material</label>
                            <select id="injector_material" class="form-control">
                                <option value="stainless_steel">AISI 316 Stainless Steel</option>
                                <option value="titanium">Titanium Grade 5</option>
                                <option value="brass">Brass (Low Pressure)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                Injection Velocity (m/s)
                                <div class="tooltip">
                                    <div class="tooltip-icon">?</div>
                                    <span class="tooltip-text">Target oxidizer velocity through injection holes. Higher velocities improve atomization and mixing but increase pressure drop. Optimal range: 20-50 m/s for good balance of performance and pressure loss.</span>
                                </div>
                            </label>
                            <input type="number" id="injection_velocity" class="form-control" value="30" min="10" max="100" step="5">
                        </div>
                        <div class="form-group">
                            <label>
                                Pressure Drop Override (%)
                                <div class="tooltip">
                                    <div class="tooltip-icon">?</div>
                                    <span class="tooltip-text">Percentage of chamber pressure lost across injector. Typical values: 15-30%. Higher drops improve atomization but require higher tank pressures. Critical for injection system sizing.</span>
                                </div>
                            </label>
                            <input type="number" id="pressure_drop_percent" class="form-control" value="20" min="10" max="50" step="5">
                        </div>
                        <div class="form-group">
                            <label>
                                Number of Holes Override
                                <div class="tooltip">
                                    <div class="tooltip-icon">?</div>
                                    <span class="tooltip-text">Override automatic hole count calculation. Leave empty for auto-calculation based on hole size constraints. Manual entry allows custom injector patterns but must satisfy flow and pressure requirements.</span>
                                </div>
                            </label>
                            <input type="number" id="n_holes_override" class="form-control" placeholder="Auto-calculated" min="1" max="200" step="1">
                        </div>
                        <div class="form-group">
                            <label>Hole Pattern</label>
                            <select id="hole_pattern" class="form-control">
                                <option value="circular">Circular Rings</option>
                                <option value="hexagonal">Hexagonal</option>
                                <option value="square">Square Grid</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Include Cooling Channels</label>
                            <select id="cooling_channels" class="form-control">
                                <option value="none">None</option>
                                <option value="radial">Radial Channels</option>
                                <option value="spiral">Spiral Channels</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="applyDesignConfig()">Apply Design Configuration</button>
                </div>
            </div>
            
            <!-- 3D Visualization Panel -->
            <div id="cad3DPanel" class="panel" style="display: none; margin-top: 20px; clear: both;">
                <h2>3D Motor Visualization</h2>
                <div class="chart-explanation">
                    <p><strong>What this shows:</strong> Interactive 3D model of the complete rocket motor assembly</p>
                    <ul>
                        <li><strong>Gray components:</strong> Motor case and structural elements</li>
                        <li><strong>Red/Orange:</strong> Fuel grain with internal port geometry</li>
                        <li><strong>Blue gradient:</strong> Nozzle throat and expansion cone</li>
                        <li><strong>Controls:</strong> Rotate (click+drag), Zoom (scroll), Pan (shift+drag)</li>
                        <li><strong>Scale:</strong> True proportional dimensions for manufacturing reference</li>
                    </ul>
                </div>
                <div id="motor_3d_plot" class="plot-container"></div>
                <div class="cad-controls">
                    <button class="btn btn-small" onclick="rotate3DView()">Rotate View</button>
                    <button class="btn btn-small" onclick="reset3DView()">Reset View</button>
                    <button class="btn btn-small" onclick="toggleWireframe()">Toggle Wireframe</button>
                </div>
            </div>
            
            <!-- CEA Style Results -->
            <div id="cea_results_panel" class="panel" style="display: none;">
                <h2>NASA CEA Style Analysis Results</h2>
                <div id="cea_output" style="background: #f8f9fa; padding: 15px; border-radius: 4px; max-height: 600px; overflow-y: auto;"></div>
            </div>
            
            <!-- Advanced Analysis Plots -->
            <div id="altitude_performance_panel" class="panel" style="display: none;">
                <h2>Altitude Performance Analysis</h2>
                <div class="chart-explanation">
                    <p><strong>What this shows:</strong> Motor performance variation with operating altitude</p>
                    <ul>
                        <li><strong>X-axis:</strong> Altitude (m) - from sea level to high altitude</li>
                        <li><strong>Y-axis:</strong> Performance metrics (Thrust, Isp, efficiency)</li>
                        <li><strong>Blue line:</strong> Thrust (N) - decreases with altitude due to back pressure</li>
                        <li><strong>Red line:</strong> Specific Impulse (s) - increases with altitude (vacuum performance)</li>
                        <li><strong>Critical points:</strong> Optimal altitude for maximum efficiency shown as markers</li>
                        <li><strong>Reference:</strong> Standard atmosphere model (ISA) used for calculations</li>
                    </ul>
                </div>
                <div id="altitude_performance_plot" class="plot-container"></div>
            </div>
            
            <div id="mass_fractions_panel" class="panel" style="display: none;">
                <h2>Mass Fractions Through Nozzle</h2>
                <div class="chart-explanation">
                    <p><strong>What this shows:</strong> Chemical species distribution along nozzle length</p>
                    <ul>
                        <li><strong>X-axis:</strong> Normalized nozzle position (0 = throat, 1 = exit)</li>
                        <li><strong>Y-axis:</strong> Mass fraction (0-1) of chemical species</li>
                        <li><strong>Different colors:</strong> Various combustion products (H2O, CO2, N2, etc.)</li>
                        <li><strong>Trends:</strong> Species concentration changes due to expansion cooling</li>
                        <li><strong>Applications:</strong> Nozzle design optimization and performance prediction</li>
                        <li><strong>Reference:</strong> Based on equilibrium thermodynamic calculations</li>
                    </ul>
                </div>
                <div id="mass_fractions_plot" class="plot-container"></div>
            </div>
            
            <div id="thrust_altitude_panel" class="panel" style="display: none;">
                <h2>Total Impulse Analysis - Thrust vs Altitude</h2>
                <div class="chart-explanation">
                    <p><strong>What this shows:</strong> Total impulse delivery capability across altitude range</p>
                    <ul>
                        <li><strong>X-axis:</strong> Altitude (km) - operational flight envelope</li>
                        <li><strong>Y-axis:</strong> Total Impulse (N·s) - integrated thrust over burn time</li>
                        <li><strong>Blue curve:</strong> Total impulse variation with altitude</li>
                        <li><strong>Peak point:</strong> Optimal altitude for maximum impulse delivery</li>
                        <li><strong>Applications:</strong> Mission trajectory optimization and staging analysis</li>
                        <li><strong>Reference:</strong> Accounts for atmospheric back-pressure effects</li>
                    </ul>
                </div>
                <div id="thrust_altitude_plot" class="plot-container"></div>
            </div>
            
            <!-- Heat Transfer Analysis -->
            <div id="heat_transfer_panel" class="panel" style="display: none;">
                <h2>Heat Transfer Analysis</h2>
                <div id="heat_transfer_results" style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 4px;"></div>
            </div>
            
            <!-- Structural Analysis -->
            <div id="structural_panel" class="panel" style="display: none;">
                <h2>Structural Analysis</h2>
                <div id="structural_results" style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 4px;"></div>
            </div>
            
            <!-- Comprehensive Safety Analysis -->
            <div id="safety_analysis_panel" class="panel" style="display: none;">
                <h2>Comprehensive Safety Analysis</h2>
                <div class="safety-analysis-container">
                    <div class="safety-controls" style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="performSafetyAnalysis()" style="margin-right: 10px;">
                            🛡️ Run Safety Analysis
                        </button>
                        <button class="btn btn-secondary" onclick="generateSafetyReport()" style="margin-right: 10px;">
                            📋 Generate Safety Report
                        </button>
                        <button class="btn btn-secondary" onclick="exportSafetyData()">
                            💾 Export Safety Data
                        </button>
                    </div>
                    
                    <div class="safety-tabs">
                        <button class="safety-tab active" onclick="showSafetyTab('overview')">Risk Overview</button>
                        <button class="safety-tab" onclick="showSafetyTab('structural')">Structural Safety</button>
                        <button class="safety-tab" onclick="showSafetyTab('thermal')">Thermal Safety</button>
                        <button class="safety-tab" onclick="showSafetyTab('explosive')">Explosive Hazards</button>
                        <button class="safety-tab" onclick="showSafetyTab('toxic')">Toxic Hazards</button>
                        <button class="safety-tab" onclick="showSafetyTab('procedures')">Safety Procedures</button>
                    </div>
                    
                    <div id="safety_overview_content" class="safety-tab-content active">
                        <div id="risk_assessment_summary"></div>
                        <div id="safety_recommendations"></div>
                    </div>
                    
                    <div id="safety_structural_content" class="safety-tab-content">
                        <div id="structural_safety_details"></div>
                    </div>
                    
                    <div id="safety_thermal_content" class="safety-tab-content">
                        <div id="thermal_safety_details"></div>
                    </div>
                    
                    <div id="safety_explosive_content" class="safety-tab-content">
                        <div id="explosive_hazards_details"></div>
                        <div id="blast_distances_chart" class="plot-container" style="height: 300px;"></div>
                    </div>
                    
                    <div id="safety_toxic_content" class="safety-tab-content">
                        <div id="toxic_hazards_details"></div>
                    </div>
                    
                    <div id="safety_procedures_content" class="safety-tab-content">
                        <div id="operational_procedures"></div>
                        <div id="emergency_procedures"></div>
                    </div>
                </div>
            </div>
            
            <!-- OpenRocket Integration -->
            <div id="openrocket_panel" class="panel" style="display: none;">
                <h2>OpenRocket Integration</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <h4>Motor Export</h4>
                        <button class="btn" onclick="exportEngFile()" style="background: #28a745; color: white; margin-right: 10px;">
                            Download .eng File
                        </button>
                        <button class="btn" onclick="exportSimulation()" style="background: #17a2b8; color: white;">
                            Export Simulation
                        </button>
                    </div>
                    <div class="form-group">
                        <h4>Flight Profile</h4>
                        <div id="flight_profile_summary" style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace;"></div>
                    </div>
                </div>
                <div id="openrocket_details" style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace;"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var currentResults = null;

        // Essential tab switching functions - defined early to avoid reference errors
        window.switchEnvironmentTab = function(tabName) {
            document.querySelectorAll('#single_env, #profile_env').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName + '_env').classList.add('active');
            
            // Update button states
            if (window.event && window.event.target) {
                window.event.target.parentElement.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                window.event.target.classList.add('active');
            }
        }

        window.switchDesignTab = function(tabName) {
            document.querySelectorAll('#thrust_time_design, #total_impulse_design').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName + '_design').classList.add('active');
            
            // Update button states
            if (window.event && window.event.target) {
                window.event.target.parentElement.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                window.event.target.classList.add('active');
            }
            
            // Update calculated impulse display
            if (typeof updateCalculatedImpulse === 'function') {
                updateCalculatedImpulse();
            }
        }

        window.switchTab = function(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all analysis tab contents
            const allTabs = ['single_tab', 'parametric_tab', 'trajectory_tab'];
            allTabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    tab.classList.remove('active');
                    tab.style.display = 'none';
                }
            });
            
            // Show the selected tab
            const targetTab = document.getElementById(tabName + '_tab');
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.style.display = 'block';
                targetTab.style.setProperty('display', 'block', 'important');
                console.log('Activated tab:', tabName + '_tab');
            } else {
                console.error('Target tab not found:', tabName + '_tab');
            }
            
            // Update button states
            const allButtons = document.querySelectorAll('#analysis_panel .tabs .tab');
            allButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Find and activate the clicked button with event delegation
            if (window.event && window.event.target) {
                window.event.target.classList.add('active');
                console.log('Activated clicked button');
            } else {
                // Fallback method
                const activeButton = document.querySelector(`#analysis_panel button[onclick*="switchTab('${tabName}')"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                    console.log('Activated button for:', tabName);
                }
            }
        }

        // Altitude to pressure conversion (standard atmosphere)
        function altitudeToPressure(altitude) {
            const P0 = 1.01325; // Sea level pressure in bar
            const T0 = 288.15;   // Sea level temperature in K
            const L = 0.0065;    // Temperature lapse rate in K/m
            const g = 9.80665;   // Gravitational acceleration
            const M = 0.0289644; // Molar mass of air
            const R = 8.31432;   // Universal gas constant
            
            if (altitude < 11000) {
                // Troposphere
                const T = T0 - L * altitude;
                const pressure = P0 * Math.pow(T / T0, (g * M) / (R * L));
                return pressure;
            } else {
                // Simplified stratosphere
                const T11 = T0 - L * 11000;
                const P11 = P0 * Math.pow(T11 / T0, (g * M) / (R * L));
                return P11 * Math.exp((-g * M * (altitude - 11000)) / (R * T11));
            }
        }

        function updateSinglePressure() {
            const altitude = parseFloat(document.getElementById('single_altitude').value);
            const pressure = altitudeToPressure(altitude);
            document.getElementById('single_pressure').value = pressure.toFixed(6);
        }



        // Initialize combustion parameters visibility
        document.addEventListener('DOMContentLoaded', function() {
            updateCombustionParams();
            updateOxidizerProperties(); // Initialize oxidizer form state
            
            // Add event listeners for thrust and burn time to auto-update calculated impulse
            const thrustInput = document.getElementById('thrust');
            const burnTimeInput = document.getElementById('burn_time');
            
            if (thrustInput) {
                thrustInput.addEventListener('input', updateCalculatedImpulse);
                thrustInput.addEventListener('change', updateCalculatedImpulse);
            }
            
            if (burnTimeInput) {
                burnTimeInput.addEventListener('input', updateCalculatedImpulse);
                burnTimeInput.addEventListener('change', updateCalculatedImpulse);
            }
            
            // Add event listeners for Total Impulse tab auto-calculation
            const totalImpulseInput = document.getElementById('total_impulse');
            const thrustImpulseInput = document.getElementById('thrust_impulse');
            const burnTimeImpulseInput = document.getElementById('burn_time_impulse');
            
            if (totalImpulseInput) {
                totalImpulseInput.addEventListener('input', () => updateTotalImpulseCalculation('total_impulse'));
                totalImpulseInput.addEventListener('change', () => updateTotalImpulseCalculation('total_impulse'));
            }
            
            if (thrustImpulseInput) {
                thrustImpulseInput.addEventListener('input', () => updateTotalImpulseCalculation('thrust_impulse'));
                thrustImpulseInput.addEventListener('change', () => updateTotalImpulseCalculation('thrust_impulse'));
            }
            
            if (burnTimeImpulseInput) {
                burnTimeImpulseInput.addEventListener('input', () => updateTotalImpulseCalculation('burn_time_impulse'));
                burnTimeImpulseInput.addEventListener('change', () => updateTotalImpulseCalculation('burn_time_impulse'));
            }
            
            // Initialize calculated impulse value
            updateCalculatedImpulse();
        });

        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showMessage('JavaScript Error: ' + event.error.message + '\nFile: ' + event.filename + '\nLine: ' + event.lineno, 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showMessage('Promise Error: ' + event.reason, 'error');
        });

        function updateCalculatedImpulse() {
            if (document.getElementById('thrust_time_design').classList.contains('active')) {
                const thrust = parseFloat(document.getElementById('thrust').value || 0);
                const burnTime = parseFloat(document.getElementById('burn_time').value || 0);
                const totalImpulse = thrust * burnTime;
                document.getElementById('calculated_impulse').textContent = totalImpulse.toLocaleString() + ' N⋅s';
            }
        }

        // Auto-calculate missing parameter in Total Impulse tab
        function updateTotalImpulseCalculation(changedFieldId) {
            const totalImpulse = parseFloat(document.getElementById('total_impulse').value || 0);
            const thrustImpulse = parseFloat(document.getElementById('thrust_impulse').value || 0);
            const burnTimeImpulse = parseFloat(document.getElementById('burn_time_impulse').value || 0);
            
            // Count how many fields have values
            const filledFields = [
                totalImpulse > 0 ? 'total_impulse' : null,
                thrustImpulse > 0 ? 'thrust_impulse' : null,
                burnTimeImpulse > 0 ? 'burn_time_impulse' : null
            ].filter(field => field !== null);
            
            if (filledFields.length >= 2) {
                // Calculate the missing third parameter
                if (changedFieldId === 'total_impulse' && thrustImpulse > 0 && burnTimeImpulse > 0) {
                    // Check consistency
                    const expectedTotalImpulse = thrustImpulse * burnTimeImpulse;
                    if (Math.abs(totalImpulse - expectedTotalImpulse) > 0.1) {
                        showValidationWarning('Total Impulse degeri tutarsiz! Beklenen: ' + expectedTotalImpulse.toFixed(1) + ' N⋅s');
                    }
                } else if (changedFieldId === 'thrust_impulse' && totalImpulse > 0) {
                    // Calculate burn time: burnTime = totalImpulse / thrust
                    if (thrustImpulse > 0) {
                        const calculatedBurnTime = totalImpulse / thrustImpulse;
                        if (!burnTimeImpulse || Math.abs(burnTimeImpulse - calculatedBurnTime) > 0.1) {
                            document.getElementById('burn_time_impulse').value = calculatedBurnTime.toFixed(2);
                            document.getElementById('burn_time_impulse').style.backgroundColor = '#e8f5e8';
                            setTimeout(() => {
                                document.getElementById('burn_time_impulse').style.backgroundColor = '';
                            }, 1500);
                        }
                    }
                } else if (changedFieldId === 'burn_time_impulse' && totalImpulse > 0) {
                    // Calculate thrust: thrust = totalImpulse / burnTime
                    if (burnTimeImpulse > 0) {
                        const calculatedThrust = totalImpulse / burnTimeImpulse;
                        if (!thrustImpulse || Math.abs(thrustImpulse - calculatedThrust) > 0.1) {
                            document.getElementById('thrust_impulse').value = calculatedThrust.toFixed(1);
                            document.getElementById('thrust_impulse').style.backgroundColor = '#e8f5e8';
                            setTimeout(() => {
                                document.getElementById('thrust_impulse').style.backgroundColor = '';
                            }, 1500);
                        }
                    }
                } else if (changedFieldId === 'total_impulse' && thrustImpulse > 0) {
                    // Calculate burn time
                    const calculatedBurnTime = totalImpulse / thrustImpulse;
                    document.getElementById('burn_time_impulse').value = calculatedBurnTime.toFixed(2);
                    document.getElementById('burn_time_impulse').style.backgroundColor = '#e8f5e8';
                    setTimeout(() => {
                        document.getElementById('burn_time_impulse').style.backgroundColor = '';
                    }, 1500);
                } else if (changedFieldId === 'total_impulse' && burnTimeImpulse > 0) {
                    // Calculate thrust
                    const calculatedThrust = totalImpulse / burnTimeImpulse;
                    document.getElementById('thrust_impulse').value = calculatedThrust.toFixed(1);
                    document.getElementById('thrust_impulse').style.backgroundColor = '#e8f5e8';
                    setTimeout(() => {
                        document.getElementById('thrust_impulse').style.backgroundColor = '';
                    }, 1500);
                }
            }
            
            hideValidationWarning();
        }

        function showValidationWarning(message) {
            let warningDiv = document.getElementById('validation_warning');
            if (!warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'validation_warning';
                warningDiv.style.cssText = 'background: #ffe6e6; color: #d63384; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #d63384;';
                document.getElementById('total_impulse_design').appendChild(warningDiv);
            }
            warningDiv.innerHTML = 'UYARI: ' + message;
            warningDiv.style.display = 'block';
        }

        function hideValidationWarning() {
            const warningDiv = document.getElementById('validation_warning');
            if (warningDiv) {
                warningDiv.style.display = 'none';
            }
        }
        
        // Validate tank and chamber pressures
        function validatePressures() {
            const chamberPressure = parseFloat(document.getElementById('chamber_pressure').value) || 0;
            const tankPressure = parseFloat(document.getElementById('tank_pressure').value) || 0;
            const warningDiv = document.getElementById('pressure_warning');
            
            if (chamberPressure <= 0 || tankPressure <= 0) {
                warningDiv.style.display = 'none';
                return;
            }
            
            if (tankPressure <= chamberPressure) {
                const minRequired = chamberPressure * 1.2;
                warningDiv.innerHTML = `HATA: Tank pressure (${tankPressure} bar) chamber pressure'dan (${chamberPressure} bar) yuksek olmali! Minimum gerekli: ${minRequired.toFixed(1)} bar`;
                warningDiv.style.display = 'block';
                warningDiv.style.color = '#d63384';
                
                // Also highlight the tank pressure input
                document.getElementById('tank_pressure').style.borderColor = '#d63384';
                document.getElementById('tank_pressure').style.backgroundColor = '#ffe6e6';
            } else if (tankPressure < chamberPressure * 1.2) {
                const minRecommended = chamberPressure * 1.2;
                warningDiv.innerHTML = `UYARI: Tank pressure en az chamber pressure'in %20 fazlasi olmali. Onerilen minimum: ${minRecommended.toFixed(1)} bar`;
                warningDiv.style.display = 'block';
                warningDiv.style.color = '#ff9800';
                
                document.getElementById('tank_pressure').style.borderColor = '#ff9800';
                document.getElementById('tank_pressure').style.backgroundColor = '#fff3e0';
            } else {
                // All good
                warningDiv.style.display = 'none';
                document.getElementById('tank_pressure').style.borderColor = '';
                document.getElementById('tank_pressure').style.backgroundColor = '';
            }
        }


        function testTabSwitching() {
            console.log('Testing tab elements...');
            console.log('single_tab:', document.getElementById('single_tab'));
            console.log('parametric_tab:', document.getElementById('parametric_tab'));
            console.log('trajectory_tab:', document.getElementById('trajectory_tab'));
            console.log('analysis_panel:', document.getElementById('analysis_panel'));
            
            // Force show parametric tab for testing
            const parametricTab = document.getElementById('parametric_tab');
            if (parametricTab) {
                parametricTab.style.display = 'block';
                parametricTab.classList.add('active');
                console.log('Forced parametric tab to show');
            }
        }
        
        // Alternative switchTab function for debugging
        function debugSwitchTab(tabName) {
            console.log('DEBUG: Switching to tab:', tabName);
            
            // Hide all tabs first
            ['single_tab', 'parametric_tab', 'trajectory_tab'].forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    tab.style.display = 'none';
                    tab.classList.remove('active');
                    console.log('Hidden:', tabId);
                }
            });
            
            // Show target tab
            const targetTab = document.getElementById(tabName + '_tab');
            if (targetTab) {
                targetTab.style.display = 'block';
                targetTab.classList.add('active');
                console.log('Showed:', tabName + '_tab');
            }
            
            // Update buttons
            document.querySelectorAll('#analysis_panel .tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`button[onclick*="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                console.log('Activated button');
            }
        }
        
        // Test when page loads
        document.addEventListener('DOMContentLoaded', function() {
            testTabSwitching();
            console.log('Page loaded, ready for tab switching');
            
            // Initialize tab states
            initializeTabs();
        });
        
        function initializeTabs() {
            // Ensure single tab is properly shown on load
            const singleTab = document.getElementById('single_tab');
            const parametricTab = document.getElementById('parametric_tab');
            const trajectoryTab = document.getElementById('trajectory_tab');
            
            if (singleTab) {
                singleTab.classList.add('active');
                singleTab.style.display = 'block';
            }
            if (parametricTab) {
                parametricTab.classList.remove('active');
                parametricTab.style.display = 'none';
            }
            if (trajectoryTab) {
                trajectoryTab.classList.remove('active');
                trajectoryTab.style.display = 'none';
            }
            
            console.log('Tabs initialized');
        }

        function previewAltProfile() {
            const previewDiv = document.getElementById('altitude_preview');
            
            // Toggle visibility
            if (previewDiv.style.display === 'block') {
                // Close if chart is visible
                previewDiv.style.display = 'none';
                // Clear Plotly chart
                Plotly.purge('altitude_preview');
                return;
            }
            
            const altStart = parseFloat(document.getElementById('alt_start').value);
            const altEnd = parseFloat(document.getElementById('alt_end').value);
            const points = parseInt(document.getElementById('alt_points').value);
            
            const altitudes = [];
            const pressures = [];
            
            for (let i = 0; i < points; i++) {
                const alt = altStart + (altEnd - altStart) * i / (points - 1);
                const pressure = altitudeToPressure(alt);
                altitudes.push(alt);
                pressures.push(pressure);
            }
            
            const trace = {
                x: altitudes,
                y: pressures,
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Pressure Profile',
                line: { color: '#2a5298', width: 3 }
            };
            
            const layout = {
                title: 'Altitude vs Ambient Pressure Profile',
                xaxis: { title: 'Altitude (m)' },
                yaxis: { title: 'Pressure (bar)' },
                margin: { t: 40, b: 40, l: 60, r: 20 }
            };
            
            // First clear existing chart
            Plotly.purge('altitude_preview');
            
            // Create new chart
            Plotly.newPlot('altitude_preview', [trace], layout, {responsive: true});
            previewDiv.style.display = 'block';
        }

        async function updateFuelConfig() {
            const fuelType = document.getElementById('fuel_type').value;
            const customConfig = document.getElementById('custom_fuel_config');
            const customMixture = document.getElementById('custom_fuel_mixture');
            const densityInput = document.getElementById('fuel_density');
            const regressionA = document.getElementById('regression_a');
            const regressionN = document.getElementById('regression_n');
            
            // Default fuel properties - matching backend values
            const fuelProperties = {
                'htpb': { density: 920, a: 0.0003, n: 0.5, description: 'Hydroxyl-terminated polybutadiene' },
                'pe': { density: 950, a: 0.00025, n: 0.62, description: 'Polyethylene' },
                'pmma': { density: 1180, a: 0.00015, n: 0.55, description: 'Polymethyl methacrylate' },
                'paraffin': { density: 900, a: 0.0005, n: 0.62, description: 'Paraffin wax - high regression rate' },
                'abs': { density: 1040, a: 0.00018, n: 0.58, description: 'ABS plastic' },
                'pla': { density: 1250, a: 0.00012, n: 0.52, description: 'PLA plastic' },
                'carbon': { density: 2200, a: 0.00008, n: 0.45, description: 'Carbon/Graphite' },
                'aluminum': { density: 2700, a: 0.00005, n: 0.4, description: 'Aluminum powder' },
                'al2o3': { density: 3950, a: 0.00003, n: 0.35, description: 'Aluminum oxide' },
                'mixture': { density: 920, a: 0.0003, n: 0.5, description: 'Custom mixture' },
                'custom': { density: 920, a: 0.0003, n: 0.5, description: 'Custom composition' }
            };
            
            // Hide all custom sections first
            customConfig.style.display = 'none';
            customMixture.style.display = 'none';
            
            if (fuelType === 'custom') {
                customConfig.style.display = 'block';
                return; // Don't update values for custom
            } else if (fuelType === 'mixture') {
                customMixture.style.display = 'block';
                updateMixtureDensity(); // Calculate initial mixture properties
                return; // Don't update values for mixture
            }
            
            // First set default values immediately (before any async operations)
            const defaultProps = fuelProperties[fuelType];
            if (defaultProps) {
                densityInput.value = defaultProps.density;
                regressionA.value = defaultProps.a;
                regressionN.value = defaultProps.n;
            }
            
            // Skip API call for now to avoid override issues
            return;
            
            try {
                // Try to fetch real properties from API
                const response = await fetch('/api/get-propellant-properties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        propellant_type: 'hybrid_fuel',
                        propellant_name: fuelType
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success' && result.properties) {
                        const props = result.properties;
                        
                        // Update all input fields with fetched data
                        if (props.density) densityInput.value = props.density;
                        if (props.regression_a) regressionA.value = props.regression_a;
                        if (props.regression_n) regressionN.value = props.regression_n;
                        
                        // Update additional fields if they exist
                        if (document.getElementById('combustion_temp') && props.combustion_temp) {
                            document.getElementById('combustion_temp').value = props.combustion_temp;
                        }
                        if (document.getElementById('molecular_weight') && props.molecular_weight) {
                            document.getElementById('molecular_weight').value = props.molecular_weight;
                        }
                        if (document.getElementById('specific_heat') && props.specific_heat) {
                            document.getElementById('specific_heat').value = props.specific_heat;
                        }
                        if (document.getElementById('thermal_conductivity') && props.thermal_conductivity) {
                            document.getElementById('thermal_conductivity').value = props.thermal_conductivity;
                        }
                        
                        showSuccess(`Loaded ${fuelType.toUpperCase()} properties from ${result.source}`);
                    } else {
                        showMessage(`Using default properties for ${fuelType.toUpperCase()}`, 'info');
                    }
                } else {
                    showMessage(`Using default properties for ${fuelType.toUpperCase()}`, 'info');
                }
            } catch (error) {
                console.error('Error fetching fuel properties:', error);
                showMessage(`Using default properties for ${fuelType.toUpperCase()}`, 'info');
            }
            
            // Hide all custom sections first
            customConfig.style.display = 'none';
            customMixture.style.display = 'none';
            
            if (fuelType === 'custom') {
                customConfig.style.display = 'block';
            } else if (fuelType === 'mixture') {
                customMixture.style.display = 'block';
                updateMixtureDensity(); // Calculate initial mixture properties
            }
        }

        function addCompositionRow() {
            const container = document.getElementById('composition_rows');
            const newRow = document.createElement('div');
            newRow.className = 'composition-row';
            newRow.innerHTML = `
                <input type="text" placeholder="Chemical formula (e.g., C4H6)" class="compound">
                <input type="number" placeholder="Mass %" class="percentage" min="0" max="100" step="0.1">
                <button class="btn btn-small" onclick="removeCompositionRow(this)">Remove</button>
            `;
            container.appendChild(newRow);
        }

        function removeCompositionRow(button) {
            button.parentElement.remove();
        }

        function updateMixtureDensity() {
            // Get all mixture percentages
            const paraffin = parseFloat(document.getElementById('mixture_paraffin').value) || 0;
            const carbon = parseFloat(document.getElementById('mixture_carbon').value) || 0;
            const al2o3 = parseFloat(document.getElementById('mixture_al2o3').value) || 0;
            const aluminum = parseFloat(document.getElementById('mixture_aluminum').value) || 0;
            const htpb = parseFloat(document.getElementById('mixture_htpb').value) || 0;
            const other = parseFloat(document.getElementById('mixture_other').value) || 0;
            
            const total = paraffin + carbon + al2o3 + aluminum + htpb + other;
            
            // Update total display
            document.getElementById('mixture_total').textContent = total.toFixed(1) + '%';
            
            // Show warning if not 100%
            const warningDiv = document.getElementById('mixture_warning');
            if (Math.abs(total - 100) > 0.1) {
                warningDiv.style.display = 'block';
                warningDiv.textContent = `Total must equal 100%! Current: ${total.toFixed(1)}%`;
            } else {
                warningDiv.style.display = 'none';
            }
            
            // Calculate weighted average density
            const densities = {
                paraffin: 900,
                carbon: 2200,
                al2o3: 3950,
                aluminum: 2700,
                htpb: 920,
                other: 1000
            };
            
            let weightedDensity = 0;
            if (total > 0) {
                weightedDensity = (paraffin * densities.paraffin + 
                                  carbon * densities.carbon + 
                                  al2o3 * densities.al2o3 + 
                                  aluminum * densities.aluminum + 
                                  htpb * densities.htpb + 
                                  other * densities.other) / total;
            }
            
            // Update density display and input
            document.getElementById('mixture_density_calc').textContent = weightedDensity.toFixed(0) + ' kg/m³';
            document.getElementById('fuel_density').value = weightedDensity.toFixed(0);
            
            // Estimate regression rate based on mixture
            let regressionA = 0.0003; // Default HTPB value
            let regressionN = 0.5;
            
            // Weighted average for regression parameters
            if (total > 0) {
                regressionA = (paraffin * 0.0008 + 
                              carbon * 0.00001 + 
                              al2o3 * 0.000001 + 
                              aluminum * 0.00005 + 
                              htpb * 0.0003 + 
                              other * 0.0002) / total;
                              
                regressionN = (paraffin * 0.5 + 
                              carbon * 0.3 + 
                              al2o3 * 0.2 + 
                              aluminum * 0.4 + 
                              htpb * 0.5 + 
                              other * 0.5) / total;
            }
            
            document.getElementById('regression_a').value = regressionA.toFixed(6);
            document.getElementById('regression_n').value = regressionN.toFixed(2);
            
            // Update regression estimate text
            let regressionText = 'Custom mixture properties';
            if (paraffin > 60) {
                regressionText = 'High regression rate (paraffin-rich)';
            } else if (al2o3 > 30 || aluminum > 20) {
                regressionText = 'Enhanced thrust (metal-rich)';
            } else if (carbon > 20) {
                regressionText = 'Stable combustion (carbon-rich)';
            }
            document.getElementById('mixture_regression_est').textContent = regressionText;
        }
        
        async function validateComposition() {
            showMessage('Validating composition with NASA CEA database...', 'info');
            
            // Collect composition data
            const rows = document.querySelectorAll('#composition_rows .composition-row');
            const composition = [];
            
            for (const row of rows) {
                const formula = row.querySelector('.compound').value.trim();
                const percentage = parseFloat(row.querySelector('.percentage').value);
                
                if (formula && !isNaN(percentage)) {
                    composition.push({ formula, percentage });
                }
            }
            
            if (composition.length === 0) {
                showMessage('❌ Please enter at least one composition component', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/validate-fuel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ composition })
                });
                
                const result = await response.json();
                const validation = document.getElementById('composition_validation');
                
                if (result.status === 'success') {
                    const props = result.mixture_properties;
                    validation.innerHTML = `
                        <div class="alert alert-success">
                            ✅ Composition validated successfully with NASA CEA database<br>
                            <strong>Calculated Properties:</strong><br>
                            • Molecular Weight: ${props.molecular_weight.toFixed(2)} g/mol<br>
                            • Heat of Formation: ${props.heat_of_formation.toFixed(1)} kJ/mol<br>
                            • Estimated Density: ${props.density.toFixed(0)} kg/m³<br>
                            • Specific Heat: ${props.specific_heat.toFixed(0)} J/kg·K
                        </div>
                    `;
                    
                    // Update density field
                    document.getElementById('fuel_density').value = props.density.toFixed(0);
                    
                    showMessage('✅ Fuel composition validated with NASA CEA', 'success');
                } else {
                    validation.innerHTML = `
                        <div class="alert alert-danger">
                            ❌ Validation failed: ${result.error}
                        </div>
                    `;
                    showMessage('❌ Validation failed: ' + result.error, 'error');
                }
                
            } catch (error) {
                showMessage('❌ Connection to NASA CEA failed: ' + error.message, 'error');
                const validation = document.getElementById('composition_validation');
                validation.innerHTML = `
                    <div class="alert alert-danger">
                        ❌ Connection to NASA CEA database failed
                    </div>
                `;
            }
        }

        function updateOxidizerDensityFromTemp() {
            // Make API call to get real NIST data when temperature changes
            updateOxidizerProperties();
        }

        async function updateOxidizerProperties() {
            const oxType = document.getElementById('oxidizer_type').value;
            const densityInput = document.getElementById('oxidizer_density');
            const viscosityInput = document.getElementById('oxidizer_viscosity');
            const temperature = parseFloat(document.getElementById('oxidizer_temp').value);
            
            console.log('updateOxidizerProperties called with:', oxType);
            console.log('densityInput found:', !!densityInput);
            console.log('viscosityInput found:', !!viscosityInput);
            
            if (oxType === 'custom') {
                console.log('CUSTOM OXIDIZER SELECTED - processing...');
                
                // Enable manual input for custom oxidizer
                densityInput.disabled = false;
                viscosityInput.disabled = false;
                densityInput.style.backgroundColor = '#fff3cd';
                viscosityInput.style.backgroundColor = '#fff3cd';
                
                console.log('Fields enabled, colors set');
                
                // Always set custom defaults when switching to custom
                densityInput.value = '1000';
                viscosityInput.value = '0.001';
                
                console.log('Default values set - density:', densityInput.value, 'viscosity:', viscosityInput.value);
                
                showMessage('Custom oxidizer selected - enter your own properties', 'info');
                return; // Don't fetch for custom oxidizers
            } else {
                // Disable manual input for predefined oxidizers  
                densityInput.disabled = true;
                viscosityInput.disabled = true;
                densityInput.style.backgroundColor = '#f8f9fa';
                viscosityInput.style.backgroundColor = '#f8f9fa';
            }
            
            showMessage('Fetching live oxidizer properties from NIST WebBook...', 'info');
            
            try {
                const response = await fetch('/api/oxidizer-properties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        oxidizer_type: oxType,
                        temperature: temperature 
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Adjusted according to response structure from backend
                    const properties = result.properties || result.data;
                    
                    if (properties.density) {
                        densityInput.value = properties.density.toFixed(1);
                        densityInput.style.backgroundColor = '#e8f5e8';
                        setTimeout(() => {
                            densityInput.style.backgroundColor = '';
                        }, 1500);
                    }
                    
                    if (properties.viscosity) {
                        viscosityInput.value = properties.viscosity.toExponential(6);
                        viscosityInput.style.backgroundColor = '#e8f5e8';
                        setTimeout(() => {
                            viscosityInput.style.backgroundColor = '';
                        }, 1500);
                    }
                    
                    // Update NIST status
                    const source = result.source || 'NIST WebBook';
                    const isRealTime = result.real_time ? '(Live)' : '(Cached)';
                    document.getElementById('nist_status').textContent = `${source} ${isRealTime}`;
                    document.getElementById('nist_status').className = 'database-status status-connected';
                    
                    showMessage(`Oxidizer properties updated from ${source} ${isRealTime}`, 'success');
                    
                } else {
                    showMessage('Using fallback oxidizer data: ' + (result.error || 'Unknown error'), 'warning');
                    
                    // Still update with fallback data if available
                    const fallbackData = result.properties || result.data;
                    if (fallbackData) {
                        if (fallbackData.density) {
                            densityInput.value = fallbackData.density.toFixed(1);
                        }
                        if (fallbackData.viscosity) {
                            viscosityInput.value = fallbackData.viscosity.toExponential(6);
                        }
                    }
                    
                    // Update status to show fallback
                    document.getElementById('nist_status').textContent = 'NIST Offline - Using Fallback';
                    document.getElementById('nist_status').className = 'database-status status-offline';
                }
                
            } catch (error) {
                console.error('NIST API Error:', error);
                showMessage('Failed to fetch from NIST WebBook: ' + error.message, 'error');
                
                // Update status to show error
                document.getElementById('nist_status').textContent = 'NIST Connection Failed';
                document.getElementById('nist_status').className = 'database-status status-error';
                
                // Use default values as fallback
                const defaults = {
                    'n2o': { density: 1004, viscosity: 0.000158 },
                    'lox': { density: 1141, viscosity: 0.000196 },
                    'h2o2': { density: 1430, viscosity: 0.00124 },
                    'air': { density: 1.204, viscosity: 0.0000182 }
                };
                
                const fallback = defaults[oxType];
                if (fallback) {
                    densityInput.value = fallback.density.toFixed(1);
                    viscosityInput.value = fallback.viscosity.toExponential(6);
                    showMessage(`Using default values for ${oxType.toUpperCase()}`, 'warning');
                }
            }
        }

        function updateCombustionParams() {
            const combustionType = document.getElementById('combustion_type').value;
            const finiteParams = document.getElementById('finite_combustion_params');
            
            if (combustionType === 'finite') {
                finiteParams.style.display = 'block';
            } else {
                finiteParams.style.display = 'none';
            }
        }

        function updateFiniteParams(changedParam) {
            const contractionInput = document.getElementById('contraction_ratio');
            const massFluxInput = document.getElementById('mass_flux_chamber');
            
            if (changedParam === 'contraction') {
                const contractionValue = parseFloat(contractionInput.value);
                if (contractionValue > 0) {
                    // If contraction ratio is set, clear and disable mass flux
                    massFluxInput.value = 0;
                    massFluxInput.disabled = true;
                    massFluxInput.style.opacity = '0.5';
                } else {
                    // If contraction ratio is cleared, enable mass flux
                    massFluxInput.disabled = false;
                    massFluxInput.style.opacity = '1';
                }
            } else if (changedParam === 'mass_flux') {
                const massFluxValue = parseFloat(massFluxInput.value);
                if (massFluxValue > 0) {
                    // If mass flux is set, clear and disable contraction ratio
                    contractionInput.value = 0;
                    contractionInput.disabled = true;
                    contractionInput.style.opacity = '0.5';
                } else {
                    // If mass flux is cleared, enable contraction ratio
                    contractionInput.disabled = false;
                    contractionInput.style.opacity = '1';
                }
            }
        }

        function updateInjectorParams() {
            const type = document.getElementById('injector_type').value;
            const paramsDiv = document.getElementById('dynamic_params');
            
            let html = '<div class="form-grid">';
            
            if (type === 'showerhead') {
                html += `
                    <div class="form-group">
                        <label>Target Velocity (m/s)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Injection velocity for proper atomization. Typical: 20-40 m/s</span>
                            </div>
                        </label>
                        <input type="number" id="target_velocity" value="30">
                    </div>
                    <div class="form-group">
                        <label>Min Hole Diameter (mm)</label>
                        <input type="number" id="hole_diameter_min" value="0.3" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Max Hole Diameter (mm)</label>
                        <input type="number" id="hole_diameter_max" value="2.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Plate Thickness (mm)</label>
                        <input type="number" id="plate_thickness" value="3.0" step="0.1">
                    </div>
                `;
            } else if (type === 'impingement') {
                html += `
                    <div class="form-group">
                        <label>Impingement Pattern
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Doublet: 2 jets, Triplet: 3 jets (F-O-F), Quadlet: 4 jets, Like-on-like: fuel on fuel + ox on ox</span>
                            </div>
                        </label>
                        <select id="impingement_pattern">
                            <option value="doublet">Doublet (2 jets)</option>
                            <option value="triplet">Triplet (F-O-F)</option>
                            <option value="quadlet">Quadlet (4 jets)</option>
                            <option value="like_on_like">Like-on-Like</option>
                            <option value="shear_coaxial">Shear Coaxial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Impingement Angle (degrees)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Total angle between impinging jets. Typical: 60-90°. Higher angles = better mixing, lower angles = better wall cooling</span>
                            </div>
                        </label>
                        <input type="number" id="impingement_angle" value="60" min="30" max="120" step="5">
                    </div>
                    <div class="form-group">
                        <label>Distance to Impingement (mm)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Distance from injector face to impingement point. Typical: 5-15mm. Affects atomization quality</span>
                            </div>
                        </label>
                        <input type="number" id="impingement_distance" value="10" min="2" max="30" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Orifice Diameter (mm)</label>
                        <input type="number" id="orifice_diameter" value="0.8" min="0.3" max="3" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Number of Element Pairs</label>
                        <input type="number" id="element_pairs" value="8" min="4" max="50" step="1">
                    </div>
                    <div class="form-group">
                        <label>Momentum Ratio (Fuel/Ox)</label>
                        <input type="number" id="momentum_ratio" value="1.0" min="0.5" max="2.0" step="0.1">
                    </div>
                `;
            } else if (type === 'pintle') {
                html += `
                    <div class="form-group">
                        <label>Pintle Tip Diameter (mm)</label>
                        <input type="number" id="pintle_diameter" value="25">
                    </div>
                    <div class="form-group">
                        <label>Annular Gap (mm)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Gap between pintle and sleeve for oxidizer flow. Typical: 1-3mm</span>
                            </div>
                        </label>
                        <input type="number" id="annular_gap" value="2" min="0.5" max="5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Spray Angle (degrees)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Cone angle of spray from pintle tip. Affects mixing and wall wetting. Typical: 30-60°</span>
                            </div>
                        </label>
                        <input type="number" id="pintle_spray_angle" value="45" min="20" max="90" step="5">
                    </div>
                    <div class="form-group">
                        <label>Skip Distance (mm)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Distance from pintle tip to first fuel port. Affects initial mixing</span>
                            </div>
                        </label>
                        <input type="number" id="skip_distance" value="15" min="5" max="50" step="1">
                    </div>
                    <div class="form-group">
                        <label>Secondary Holes</label>
                        <select id="secondary_holes">
                            <option value="none">None</option>
                            <option value="radial">Radial Holes</option>
                            <option value="tangential">Tangential Holes</option>
                        </select>
                    </div>
                `;
            } else if (type === 'swirl') {
                html += `
                    <div class="form-group">
                        <label>Number of Tangential Slots</label>
                        <input type="number" id="n_slots" value="6" min="2" max="12">
                    </div>
                    <div class="form-group">
                        <label>Swirl Chamber Diameter (mm)</label>
                        <input type="number" id="swirl_chamber_diameter" value="20" min="5" max="50" step="1">
                    </div>
                    <div class="form-group">
                        <label>Tangential Entry Angle (degrees)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Angle of tangential entry ports. 90° = pure tangential, lower angles add axial component</span>
                            </div>
                        </label>
                        <input type="number" id="swirl_angle" value="90" min="45" max="90" step="5">
                    </div>
                    <div class="form-group">
                        <label>Slot Width (mm)</label>
                        <input type="number" id="slot_width" value="1.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Slot Height (mm)</label>
                        <input type="number" id="slot_height" value="2.0" step="0.1">
                    </div>
                `;
            } else if (type === 'coaxial') {
                html += `
                    <div class="form-group">
                        <label>Inner Post Diameter (mm)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Central post diameter for fuel injection</span>
                            </div>
                        </label>
                        <input type="number" id="inner_diameter" value="5" min="2" max="20" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Outer Annulus Diameter (mm)</label>
                        <input type="number" id="outer_annulus_diameter" value="8" min="3" max="30" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Recess Length (mm)
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Post recess for enhanced mixing. Negative = protruding, Positive = recessed</span>
                            </div>
                        </label>
                        <input type="number" id="recess_length" value="0" min="-5" max="10" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Number of Elements</label>
                        <input type="number" id="n_elements" value="19" min="1" max="100" step="1">
                    </div>
                `;
            }
            
            html += '</div>';
            paramsDiv.innerHTML = html;
        }

        function getFormData() {
            // Get environment data
            const isProfileMode = document.getElementById('profile_env').classList.contains('active');
            let ambientPressure, altitudeProfile = null;
            
            if (isProfileMode) {
                const altStart = parseFloat(document.getElementById('alt_start').value || 0);
                const altEnd = parseFloat(document.getElementById('alt_end').value || 10000);
                const points = parseInt(document.getElementById('alt_points').value || 10);
                
                altitudeProfile = {
                    start: altStart,
                    end: altEnd,
                    points: points
                };
                ambientPressure = altitudeToPressure(altStart); // Use start altitude for single calculation
            } else {
                // Single altitude mode - don't send altitude_profile
                ambientPressure = parseFloat(document.getElementById('single_pressure').value || 1.013);
                // altitudeProfile stays null
            }

            // Check which design mode is active
            const thrustTimeActive = document.getElementById('thrust_time_design').classList.contains('active');
            
            const data = {
                // Motor info
                motor_name: document.getElementById('motor_name').value || 'UZAYTEK-HRM-001',
                motor_description: document.getElementById('motor_description').value || '',
                
                // Environment
                atmospheric_pressure: ambientPressure,
                
                // Basic parameters - handle total impulse vs thrust/time modes
                of_ratio: parseFloat(document.getElementById('of_ratio').value || 2.5),
                chamber_pressure: parseFloat(document.getElementById('chamber_pressure').value || 20),
                tank_pressure: parseFloat(document.getElementById('tank_pressure').value || 50),
                
                // Motor design parameters  
                thrust: thrustTimeActive ? parseFloat(document.getElementById('thrust').value || 1000) : 
                        (document.getElementById('thrust_impulse').value ? parseFloat(document.getElementById('thrust_impulse').value) : 1000),
                burn_time: thrustTimeActive ? parseFloat(document.getElementById('burn_time').value || 10) : 
                          (document.getElementById('burn_time_impulse').value ? parseFloat(document.getElementById('burn_time_impulse').value) : 10),
                total_impulse: !thrustTimeActive ? parseFloat(document.getElementById('total_impulse').value || 10000) : 
                              (parseFloat(document.getElementById('thrust').value || 1000) * parseFloat(document.getElementById('burn_time').value || 10)),
                
                // Trajectory analysis
                calculate_trajectory: document.getElementById('calculate_trajectory') ? document.getElementById('calculate_trajectory').checked : false,
                vehicle_mass_dry: parseFloat(document.getElementById('vehicle_mass_dry')?.value || 50),
                vehicle_diameter: parseFloat(document.getElementById('vehicle_diameter')?.value || 0.15),
                drag_coefficient: parseFloat(document.getElementById('drag_coefficient')?.value || 0.5),
                vehicle_length: parseFloat(document.getElementById('vehicle_length')?.value || 2.0),
                launch_angle: parseFloat(document.getElementById('launch_angle')?.value || 85),
                launch_altitude: parseFloat(document.getElementById('launch_altitude')?.value || 0),
                wind_speed: parseFloat(document.getElementById('wind_speed')?.value || 0),
                wind_direction: parseFloat(document.getElementById('wind_direction')?.value || 0),
                
                // Advanced parameters
                l_star: parseFloat(document.getElementById('l_star').value || 1.0),
                expansion_ratio: parseFloat(document.getElementById('expansion_ratio').value || 16) || 16,
                nozzle_type: document.getElementById('nozzle_type').value || 'conical',
                combustion_type: document.getElementById('combustion_type').value || 'infinite',
                chamber_diameter_input: parseFloat(document.getElementById('chamber_diameter_input').value || 0),
                
                // Finite combustion parameters (only one should be > 0)
                contraction_ratio: parseFloat(document.getElementById('contraction_ratio')?.value || 0),
                mass_flux_chamber: parseFloat(document.getElementById('mass_flux_chamber')?.value || 0),
                
                // Fuel
                fuel_type: document.getElementById('fuel_type').value || 'htpb',
                fuel_density: parseFloat(document.getElementById('fuel_density').value || 920),
                regression_a: parseFloat(document.getElementById('regression_a').value || 0.0003),
                regression_n: parseFloat(document.getElementById('regression_n').value || 0.5),
                
                // Oxidizer
                oxidizer_type: document.getElementById('oxidizer_type').value || 'n2o',
                oxidizer_phase: document.getElementById('oxidizer_phase').value || 'liquid',
                oxidizer_density: parseFloat(document.getElementById('oxidizer_density').value || 1220),
                oxidizer_viscosity: parseFloat(document.getElementById('oxidizer_viscosity').value || 0.0002),
                oxidizer_temp: parseFloat(document.getElementById('oxidizer_temp').value || 293),
                
                // Injector parameters
                injector_type: document.getElementById('injector_type').value || 'showerhead',
                target_velocity: parseFloat(document.getElementById('target_velocity')?.value || 30)
            };

            // Add injector-specific parameters safely
            const injectorType = document.getElementById('injector_type')?.value || 'showerhead';
            if (injectorType === 'showerhead') {
                data.target_velocity = parseFloat(document.getElementById('target_velocity')?.value || 30);
                data.hole_diameter_min = parseFloat(document.getElementById('hole_diameter_min')?.value || 0.3);
                data.hole_diameter_max = parseFloat(document.getElementById('hole_diameter_max')?.value || 2.0);
                data.plate_thickness = parseFloat(document.getElementById('plate_thickness')?.value || 3.0);
            } else if (injectorType === 'pintle') {
                data.outer_diameter = parseFloat(document.getElementById('outer_diameter')?.value || 50);
                data.pintle_diameter = parseFloat(document.getElementById('pintle_diameter')?.value || 25);
            } else if (injectorType === 'swirl') {
                data.n_slots = parseInt(document.getElementById('n_slots')?.value || 6);
                data.slot_width = parseFloat(document.getElementById('slot_width')?.value || 0);
                data.slot_height = parseFloat(document.getElementById('slot_height')?.value || 0);
            }
            
            // Ensure all required parameters have values
            data.target_velocity = data.target_velocity || 30;
            
            // Add altitude profile only if in profile mode
            if (altitudeProfile) {
                data.altitude_profile = altitudeProfile;
            }

            return data;
        }

        function validateFormData(data) {
            const errors = [];
            
            // Check for missing required fields
            const requiredFields = {
                'motor_name': 'Motor Name',
                'atmospheric_pressure': 'Atmospheric Pressure',
                'of_ratio': 'O/F Ratio',
                'chamber_pressure': 'Chamber Pressure',
                'tank_pressure': 'Tank Pressure',
                'thrust': 'Thrust',
                'burn_time': 'Burn Time',
                'fuel_type': 'Fuel Type',
                'oxidizer_type': 'Oxidizer Type',
                'injector_type': 'Injector Type'
            };
            
            for (const [field, label] of Object.entries(requiredFields)) {
                if (!data[field] && data[field] !== 0) {
                    errors.push(`Missing ${label} (${field})`);
                }
            }
            
            // Check for invalid values
            if (data.of_ratio && (data.of_ratio < 0.1 || data.of_ratio > 20)) {
                errors.push('O/F Ratio must be between 0.1 and 20');
            }
            
            if (data.chamber_pressure && (data.chamber_pressure < 1 || data.chamber_pressure > 100)) {
                errors.push('Chamber Pressure must be between 1 and 100 bar');
            }
            
            if (data.thrust && (data.thrust < 1 || data.thrust > 100000)) {
                errors.push('Thrust must be between 1 and 100000 N');
            }
            
            if (data.burn_time && (data.burn_time < 0.1 || data.burn_time > 300)) {
                errors.push('Burn Time must be between 0.1 and 300 seconds');
            }
            
            // Skip motor name pattern check - backend handles validation
            
            return errors;
        }

        // Calculate function moved to app.js to avoid conflicts

        function displayResults(results) {
            console.log('displayResults called with:', results);
            console.log('Regression rate value:', results.motor?.regression_rate);
            console.log('Regression rate avg:', results.motor?.regression_rate_avg);
            try {
                const resultsDiv = document.getElementById('resultsPanel');
                if (!resultsDiv) {
                    console.error('Results div not found!');
                    return;
                }
                resultsDiv.style.display = 'block';
                console.log('Results div made visible');
            
                // Performance metrics cards
                const metricsDiv = document.getElementById('performance_metrics');
                if (!metricsDiv) {
                    console.error('performance_metrics div not found!');
                    return;
                }
                
                // Safe number formatting function
                function safeFixed(value, decimals) {
                    if (value === null || value === undefined || isNaN(value)) {
                        return 'N/A';
                    }
                    return Number(value).toFixed(decimals);
                }
                
                const metrics = [
                    { label: 'Specific Impulse', value: safeFixed(results.motor.isp, 1), unit: 's', color: '#667eea' },
                    { label: 'Thrust', value: safeFixed(results.motor.thrust, 0), unit: 'N', color: '#764ba2' },
                    { label: 'Chamber Pressure', value: safeFixed(results.motor.chamber_pressure, 1), unit: 'bar', color: '#f093fb' },
                    { label: 'Total Mass Flow Rate', value: safeFixed(results.motor.mdot_total, 3), unit: 'kg/s', color: '#f5576c' }
                ];
                
                console.log('Metrics prepared:', metrics);
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
            metrics.forEach(metric => {
                html += `
                    <div class="metric-card" style="background: linear-gradient(135deg, ${metric.color} 0%, ${metric.color}aa 100%);">
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label} (${metric.unit})</div>
                    </div>
                `;
            });
            html += '</div>';
            metricsDiv.innerHTML = html;

            // Motor table (convert to mm where appropriate)
            const motorTable = document.getElementById('motor_table').getElementsByTagName('tbody')[0];
            motorTable.innerHTML = '';
            const motorData = [
                ['Throat Diameter', safeFixed(results.motor.throat_diameter * 1000, 2), 'mm'],
                ['Exit Diameter', safeFixed(results.motor.exit_diameter * 1000, 2), 'mm'],
                ['Chamber Diameter', safeFixed(results.motor.chamber_diameter * 1000, 2), 'mm'],
                ['Chamber Length', safeFixed(results.motor.chamber_length * 1000, 2), 'mm'],
                ['Expansion Ratio (Ae/At)', safeFixed(results.motor.expansion_ratio, 2), '-'],
                ['Initial Port Diameter', safeFixed(results.motor.port_diameter_initial * 1000, 2), 'mm'],
                ['Final Port Diameter', safeFixed(results.motor.port_diameter_final * 1000, 2), 'mm'],
                ['Regression Rate', safeFixed(results.motor.regression_rate * 1000, 3), 'mm/s'],
                ['Avg Regression Rate', safeFixed(results.motor.regression_rate_avg * 1000, 3), 'mm/s'],
                ['C* Velocity', safeFixed(results.motor.c_star, 1), 'm/s'],
                ['Thrust Coefficient (CF)', safeFixed(results.motor.cf, 3), '-']
            ];
            motorData.forEach(row => {
                const tr = motorTable.insertRow();
                row.forEach(cell => {
                    const td = tr.insertCell();
                    td.textContent = cell;
                });
            });

            // Injector table
            const injTable = document.getElementById('injector_table').getElementsByTagName('tbody')[0];
            injTable.innerHTML = '';
            const injData = [
                ['Type', results.injector.type.charAt(0).toUpperCase() + results.injector.type.slice(1), '-'],
                ['Exit Velocity', safeFixed(results.injector.exit_velocity, 1), 'm/s'],
                ['Reynolds Number', safeFixed(results.injector.reynolds_number, 0), '-'],
                ['Pressure Drop', safeFixed(results.injector.pressure_drop, 2), 'bar']
            ];
            
            // Add type-specific data
            if (results.injector.type === 'showerhead') {
                injData.push(['Number of Holes', results.injector.n_holes, 'pcs']);
                injData.push(['Hole Diameter', safeFixed(results.injector.hole_diameter, 3), 'mm']);
                injData.push(['L/D Ratio', safeFixed(results.injector.L_D_ratio, 2), '-']);
            } else if (results.injector.type === 'pintle') {
                injData.push(['Outer Diameter', safeFixed(results.injector.outer_diameter, 2), 'mm']);
                injData.push(['Gap', safeFixed(results.injector.gap, 3), 'mm']);
            } else if (results.injector.type === 'swirl') {
                injData.push(['Number of Slots', results.injector.n_slots, 'pcs']);
                injData.push(['Slot Width', safeFixed(results.injector.slot_width, 3), 'mm']);
                injData.push(['Slot Height', safeFixed(results.injector.slot_height, 3), 'mm']);
            }
            
            injData.forEach(row => {
                const tr = injTable.insertRow();
                row.forEach(cell => {
                    const td = tr.insertCell();
                    td.textContent = cell;
                });
            });

            // Display plots
            if (results.plots && results.plots.motor) {
                const motorPlotData = JSON.parse(results.plots.motor);
                Plotly.newPlot('motor_plot', motorPlotData.data, motorPlotData.layout, {responsive: true});
            }

            // Performance plots now contains the regression rate and injector performance
            // This should go to injector_plot div which is visible
            if (results.plots && results.plots.performance) {
                const performancePlotData = JSON.parse(results.plots.performance);
                console.log('Rendering performance plots with regression rate...');
                Plotly.newPlot('injector_plot', performancePlotData.data, performancePlotData.layout, {responsive: true});
            }
            
            // Also render the old injector plot if it exists (for backward compatibility)
            if (results.plots && results.plots.injector && !results.plots.performance) {
                const injectorPlotData = JSON.parse(results.plots.injector);
                Plotly.newPlot('injector_plot', injectorPlotData.data, injectorPlotData.layout, {responsive: true});
            }
            
            // If there's separate performance data for the second panel
            if (results.plots && results.plots.performance_secondary) {
                const performancePlotData = JSON.parse(results.plots.performance_secondary);
                Plotly.newPlot('performance_plots', performancePlotData.data, performancePlotData.layout, {responsive: true});
            }
            
            // Display CEA-style results
            if (results.cea_results) {
                const ceaOutput = document.getElementById('cea_output');
                if (ceaOutput) {
                    ceaOutput.innerHTML = `<pre style="font-family: monospace; white-space: pre-wrap; font-size: 12px; line-height: 1.4;">${results.cea_results}</pre>`;
                    document.getElementById('cea_results_panel').style.display = 'block';
                }
            }
            
            // Display advanced plots
            if (results.plots && results.plots.altitude_performance) {
                const altitudePlotData = JSON.parse(results.plots.altitude_performance);
                Plotly.newPlot('altitude_performance_plot', altitudePlotData.data, altitudePlotData.layout, {responsive: true});
                document.getElementById('altitude_performance_panel').style.display = 'block';
            }
            
            if (results.plots && results.plots.mass_fractions) {
                const massFractionPlotData = JSON.parse(results.plots.mass_fractions);
                Plotly.newPlot('mass_fractions_plot', massFractionPlotData.data, massFractionPlotData.layout, {responsive: true});
                document.getElementById('mass_fractions_panel').style.display = 'block';
            }
            
            if (results.plots && results.plots.thrust_altitude) {
                const thrustAltitudePlotData = JSON.parse(results.plots.thrust_altitude);
                Plotly.newPlot('thrust_altitude_plot', thrustAltitudePlotData.data, thrustAltitudePlotData.layout, {responsive: true});
                document.getElementById('thrust_altitude_panel').style.display = 'block';
            }
            
            // Display heat transfer analysis
            if (results.motor && results.motor.heat_transfer_analysis) {
                const heatTransfer = results.motor.heat_transfer_analysis;
                let heatTransferText = 'HEAT TRANSFER ANALYSIS\n';
                heatTransferText += '======================\n\n';
                
                heatTransferText += `Material: ${heatTransfer.design_parameters.material}\n`;
                heatTransferText += `Wall Thickness: ${safeFixed(heatTransfer.design_parameters.wall_thickness, 1)} mm\n`;
                heatTransferText += `Cooling Type: ${heatTransfer.design_parameters.cooling_type}\n\n`;
                
                heatTransferText += 'TEMPERATURES:\n';
                heatTransferText += `Inner Wall: ${safeFixed(heatTransfer.wall_analysis.inner_temperature, 0)} K\n`;
                heatTransferText += `Outer Wall: ${safeFixed(heatTransfer.wall_analysis.outer_temperature, 0)} K\n`;
                heatTransferText += `Max Temperature: ${safeFixed(heatTransfer.wall_analysis.max_temperature, 0)} K\n\n`;
                
                heatTransferText += 'HEAT TRANSFER:\n';
                heatTransferText += `Heat Flux: ${safeFixed(heatTransfer.gas_side_analysis.heat_flux/1000, 1)} kW/m²\n`;
                heatTransferText += `Total Heat Rate: ${safeFixed(heatTransfer.gas_side_analysis.total_heat_rate/1000, 1)} kW\n`;
                heatTransferText += `Gas-side h: ${safeFixed(heatTransfer.heat_transfer_coefficients.gas_side, 0)} W/m²·K\n\n`;
                
                heatTransferText += 'SAFETY:\n';
                heatTransferText += `Temperature Safety Factor: ${safeFixed(heatTransfer.safety_analysis.temperature_safety_factor, 2)}\n`;
                heatTransferText += `Risk Level: ${heatTransfer.safety_analysis.risk_level}\n`;
                
                document.getElementById('heat_transfer_results').textContent = heatTransferText;
                document.getElementById('heat_transfer_panel').style.display = 'block';
            }
            
            // Display structural analysis
            if (results.motor && results.motor.structural_analysis) {
                const structural = results.motor.structural_analysis;
                let structuralText = 'STRUCTURAL ANALYSIS\n';
                structuralText += '==================\n\n';
                
                structuralText += `Material: ${structural.design_parameters.material}\n`;
                structuralText += `Design Pressure: ${structural.design_parameters.design_pressure.toFixed(1)} bar\n\n`;
                
                structuralText += 'CHAMBER WALL:\n';
                structuralText += `Recommended Thickness: ${structural.chamber_analysis.recommended_thickness.toFixed(1)} mm\n`;
                structuralText += `Hoop Stress: ${structural.chamber_analysis.hoop_stress.toFixed(1)} MPa\n`;
                structuralText += `Safety Factor: ${structural.chamber_analysis.hoop_safety_factor.toFixed(2)}\n\n`;
                
                structuralText += 'NOZZLE:\n';
                structuralText += `Throat Thickness: ${structural.nozzle_analysis.required_throat_thickness.toFixed(1)} mm\n`;
                structuralText += `Safety Factor: ${structural.nozzle_analysis.safety_factor.toFixed(2)}\n\n`;
                
                structuralText += 'WEIGHT:\n';
                structuralText += `Total Weight: ${structural.weight_analysis.total_weight.toFixed(2)} kg\n`;
                structuralText += `Chamber: ${structural.weight_analysis.chamber_weight.toFixed(2)} kg\n\n`;
                
                structuralText += 'OVERALL SAFETY:\n';
                structuralText += `Minimum Safety Factor: ${structural.safety_analysis.minimum_safety_factor.toFixed(2)}\n`;
                structuralText += `Status: ${structural.safety_analysis.status}\n`;
                structuralText += `Risk Level: ${structural.safety_analysis.risk_level}\n`;
                
                document.getElementById('structural_results').textContent = structuralText;
                document.getElementById('structural_panel').style.display = 'block';
            }
            
            // Display OpenRocket integration
            if (results.openrocket) {
                const openrocket = results.openrocket;
                
                // Flight profile summary
                if (openrocket.flight_profile) {
                    const profile = openrocket.flight_profile.performance_summary;
                    let profileText = 'FLIGHT PROFILE ESTIMATE\n';
                    profileText += '=======================\n\n';
                    profileText += `Max Altitude: ${safeFixed(profile.max_altitude, 0)} m\n`;
                    profileText += `Max Velocity: ${safeFixed(profile.max_velocity, 1)} m/s\n`;
                    profileText += `Max Acceleration: ${safeFixed(profile.max_acceleration, 1)} m/s²\n`;
                    profileText += `Total Flight Time: ${safeFixed(profile.total_flight_time, 1)} s\n`;
                    profileText += `Apogee Time: ${safeFixed(profile.apogee_time, 1)} s\n`;
                    
                    document.getElementById('flight_profile_summary').textContent = profileText;
                }
                
                // Motor summary for OpenRocket
                if (openrocket.motor_summary) {
                    const motor = openrocket.motor_summary;
                    let detailsText = 'OPENROCKET MOTOR DATA\n';
                    detailsText += '=====================\n\n';
                    detailsText += `Designation: ${motor.motor_info.designation}\n`;
                    detailsText += `Manufacturer: ${motor.motor_info.manufacturer}\n`;
                    detailsText += `Total Impulse: ${safeFixed(motor.performance.total_impulse, 0)} N⋅s\n`;
                    detailsText += `Average Thrust: ${safeFixed(motor.performance.average_thrust, 0)} N\n`;
                    detailsText += `Burn Time: ${safeFixed(motor.performance.burn_time, 1)} s\n`;
                    detailsText += `Motor Diameter: ${safeFixed(motor.physical.diameter, 1)} mm\n`;
                    detailsText += `Motor Length: ${safeFixed(motor.physical.length, 1)} mm\n`;
                    detailsText += `Propellant Mass: ${safeFixed(motor.physical.propellant_mass, 3)} kg\n`;
                    
                    document.getElementById('openrocket_details').textContent = detailsText;
                }
                
                document.getElementById('openrocket_panel').style.display = 'block';
            }

            // Show warnings
            if (results.injector.warnings && results.injector.warnings.length > 0) {
                let warningText = 'Warnings: ' + results.injector.warnings.join('; ');
                showMessage(warningText, 'warning');
            }
            
            // Enable export buttons after successful calculation
            document.getElementById('downloadEngBtn').disabled = false;
            document.getElementById('exportSTLBtn').disabled = false;
            document.getElementById('generateCADBtn').disabled = false;
            document.getElementById('regressionBtn').disabled = false;
            
            console.log('displayResults completed successfully');
            
            } catch (error) {
                console.error('Error in displayResults:', error);
                console.error('Results data:', results);
                
                let errorDetails = 'Error displaying results: ' + error.message + '\n\n';
                errorDetails += 'Detailed Error Info:\n';
                errorDetails += 'Message: ' + error.message + '\n';
                errorDetails += 'Stack: ' + (error.stack || 'No stack trace') + '\n';
                errorDetails += 'Results Data Keys: ' + Object.keys(results || {}).join(', ') + '\n';
                
                if (results && results.motor) {
                    errorDetails += 'Motor Data Keys: ' + Object.keys(results.motor).join(', ') + '\n';
                }
                
                showMessage(errorDetails, 'error');
            }
        }

        async function calculateParametric() {
            return await runParametricAnalysis();
        }

        async function runParametricAnalysis() {
            const baseParams = getFormData();
            const sweepParam = document.getElementById('sweep_parameter')?.value || 'of_ratio';
            const sweepMin = parseFloat(document.getElementById('sweep_min')?.value || 0.5);
            const sweepMax = parseFloat(document.getElementById('sweep_max')?.value || 3.0);
            const sweepPoints = parseInt(document.getElementById('sweep_points')?.value || 20);
            const includeTrajectory = document.getElementById('include_trajectory_sweep')?.checked || false;
            
            const data = {
                base_parameters: baseParams,
                sweep_parameter: sweepParam,
                sweep_range: [sweepMin, sweepMax],
                sweep_points: sweepPoints,
                include_trajectory: includeTrajectory,
                vehicle_mass_dry: baseParams.vehicle_mass_dry,
                vehicle_diameter: baseParams.vehicle_diameter,
                launch_angle: baseParams.launch_angle,
                launch_altitude: baseParams.launch_altitude
            };
            
            showLoading(true);
            showMessage('Parametric analysis in progress...', 'info');
            
            try {
                const response = await fetch('/parametric-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const results = await response.json();
                
                if (results.status === 'success') {
                    // Display parametric plot
                    if (results.plot) {
                        const plotData = JSON.parse(results.plot);
                        Plotly.newPlot('parametric_plot', plotData.data, plotData.layout);
                        const parametricDiv = document.getElementById('parametric_results');
                        if (parametricDiv) {
                            parametricDiv.style.display = 'block';
                        } else {
                            console.error('parametric_results div not found!');
                        }
                    }
                    showMessage('Parametric analysis completed successfully', 'success');
                } else {
                    showMessage('Parametric analysis failed: ' + results.error, 'error');
                }
                
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
            
            showLoading(false);
        }

        // Toggle trajectory parameters visibility
        function toggleTrajectoryParams() {
            const checkbox = document.getElementById('calculate_trajectory');
            const params = document.getElementById('trajectory_params');
            if (checkbox && params) {
                params.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        // Toggle parametric parameters visibility
        function toggleParametricParams() {
            const checkbox = document.getElementById('enable_parametric');
            const params = document.getElementById('parametric_params');
            if (checkbox && params) {
                params.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        function optimize() {
            showMessage('⚡ Optimization feature coming soon!', 'warning');
        }

        function exportResults() {
            if (!currentResults) {
                showMessage('❌ No results to export', 'error');
                return;
            }
            
            const motorName = document.getElementById('motor_name').value || 'UZAYTEK-HRM-001';
            const description = document.getElementById('motor_description').value || '';
            
            let report = `UZAYTEK - HYBRID ROCKET MOTOR ANALYSIS REPORT\n`;
            report += `===============================================\n\n`;
            report += `Motor Name: ${motorName}\n`;
            report += `Description: ${description}\n`;
            report += `Analysis Date: ${new Date().toLocaleDateString('en-US')}\n\n`;
            
            report += `PERFORMANCE SUMMARY:\n`;
            report += `Specific Impulse: ${currentResults.motor.isp.toFixed(1)} s\n`;
            report += `Thrust: ${currentResults.motor.thrust.toFixed(0)} N\n`;
            report += `Chamber Pressure: ${currentResults.motor.chamber_pressure.toFixed(1)} bar\n`;
            report += `Total Mass Flow Rate: ${currentResults.motor.mdot_total.toFixed(3)} kg/s\n\n`;
            
            report += `MOTOR DESIGN:\n`;
            report += `Throat Diameter: ${(currentResults.motor.throat_diameter * 1000).toFixed(2)} mm\n`;
            report += `Exit Diameter: ${(currentResults.motor.exit_diameter * 1000).toFixed(2)} mm\n`;
            report += `Chamber Diameter: ${(currentResults.motor.chamber_diameter * 1000).toFixed(2)} mm\n`;
            report += `Chamber Length: ${(currentResults.motor.chamber_length * 1000).toFixed(2)} mm\n\n`;
            
            report += `INJECTOR DESIGN:\n`;
            report += `Type: ${currentResults.injector.type}\n`;
            report += `Exit Velocity: ${currentResults.injector.exit_velocity.toFixed(1)} m/s\n`;
            report += `Reynolds Number: ${currentResults.injector.reynolds_number.toFixed(0)}\n`;
            report += `Pressure Drop: ${currentResults.injector.pressure_drop.toFixed(2)} bar\n\n`;
            
            if (currentResults.injector.warnings && currentResults.injector.warnings.length > 0) {
                report += `WARNINGS:\n`;
                currentResults.injector.warnings.forEach(warning => {
                    report += `• ${warning}\n`;
                });
                report += `\n`;
            }
            
            report += `---\nGenerated by UZAYTEK Hybrid Rocket Motor Analysis Software\n`;
            report += `Space Technologies Team - Professional Analysis Tool\n`;
            
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${motorName}_analysis_report.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showMessage('Report exported successfully!', 'success');
        }

        async function generate3DCAD() {
            if (!currentResults) {
                showMessage('No calculation results available for CAD generation', 'error');
                return;
            }
            
            showLoading(true);
            showMessage('Generating 3D CAD design...', 'info');
            
            try {
                const response = await fetch('/api/generate-cad', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ motor_data: currentResults.motor })
                });
                
                const cadData = await response.json();
                
                if (cadData.status === 'success') {
                    // Create new window for 3D visualization
                    const cadWindow = window.open('', '_blank', 'width=1200,height=800');
                    cadWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>UZAYTEK 3D CAD Design</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                                .header { background: #1e3c72; color: white; padding: 15px; margin: -20px -20px 20px -20px; }
                                .visualization { width: 100%; height: 600px; border: 1px solid #ddd; }
                                .specs { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                                .spec-panel { background: #f8f9fa; padding: 15px; border-radius: 5px; }
                                .spec-panel h3 { margin-top: 0; color: #1e3c72; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>UZAYTEK Hybrid Rocket Motor - 3D CAD Design</h1>
                                <p>Professional Motor Assembly Visualization</p>
                            </div>
                            <div class="visualization">
                                ${cadData.cad_visualization}
                            </div>
                            <div class="specs">
                                <div class="spec-panel">
                                    <h3>Technical Specifications</h3>
                                    <pre>${JSON.stringify(cadData.technical_drawings, null, 2)}</pre>
                                </div>
                                <div class="spec-panel">
                                    <h3>Material Properties</h3>
                                    <pre>${JSON.stringify(cadData.material_specifications, null, 2)}</pre>
                                </div>
                            </div>
                        </body>
                        </html>
                    `);
                    
                    showMessage('3D CAD design generated successfully!', 'success');
                } else {
                    throw new Error(cadData.error || 'Failed to generate CAD design');
                }
                
            } catch (error) {
                showMessage('Error generating 3D CAD: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            if (type === 'clear') {
                messagesDiv.innerHTML = '';
                return;
            }
            
            const div = document.createElement('div');
            div.className = `alert alert-${type === 'error' ? 'danger' : type}`;
            div.textContent = text;
            messagesDiv.innerHTML = '';
            messagesDiv.appendChild(div);
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                div.style.opacity = '0';
                setTimeout(() => div.remove(), 300);
            }, 5000);
        }

        // Database status check
        async function checkDatabaseStatus() {
            try {
                const response = await fetch('/api/database-status');
                const status = await response.json();
                
                // Update NIST status indicator
                const nistStatus = document.getElementById('nist_status');
                if (status.nist && status.nist.status === 'connected') {
                    nistStatus.className = 'database-status status-connected';
                    nistStatus.textContent = 'NIST WebBook Connected';
                } else {
                    nistStatus.className = 'database-status status-disconnected';
                    nistStatus.textContent = 'NIST WebBook Offline';
                }
                
                // Update CEA status indicator
                const ceaStatus = document.getElementById('cea_status');
                if (status.cea && status.cea.status === 'connected') {
                    ceaStatus.className = 'database-status status-connected';
                    ceaStatus.textContent = 'NASA CEA Connected';
                } else {
                    ceaStatus.className = 'database-status status-disconnected';
                    ceaStatus.textContent = 'NASA CEA Offline';
                }
                
            } catch (error) {
                console.error('Database status check failed:', error);
                
                // Set all to offline
                document.getElementById('nist_status').className = 'database-status status-disconnected';
                document.getElementById('nist_status').textContent = 'NIST WebBook Offline';
                document.getElementById('cea_status').className = 'database-status status-disconnected';
                document.getElementById('cea_status').textContent = 'NASA CEA Offline';
            }
        }

        // Find optimum O/F ratio
        async function findOptimumOF() {
            showMessage('Finding optimum O/F ratio for maximum Isp...', 'info');
            
            try {
                // Get fuel and oxidizer types
                const fuelType = document.getElementById('fuel_type').value || 'htpb';
                const oxidizerType = document.getElementById('oxidizer_type').value || 'n2o';
                const chamberPressure = parseFloat(document.getElementById('chamber_pressure').value) || 20;
                
                // Call the API endpoint for real optimization
                const response = await fetch('/api/find-optimum-of', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        motor_type: 'hybrid',
                        oxidizer: oxidizerType,
                        fuel: fuelType,
                        chamber_pressure: chamberPressure
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const optimumOF = result.optimum_of_ratio;
                    const maxIsp = result.max_isp;
                    
                    // Apply the optimum O/F ratio
                    document.getElementById('of_ratio').value = optimumOF.toFixed(2);
                    document.getElementById('optimum_of_result').innerHTML = 
                        `Optimum: ${optimumOF.toFixed(2)} (Max Isp: ${maxIsp.toFixed(1)} s)`;
                    document.getElementById('optimum_of_result').style.color = '#28a745';
                    
                    // Show recommendation if available
                    if (result.recommendation) {
                        showMessage(result.recommendation, 'success');
                    } else {
                        showMessage(`Optimum O/F ratio found: ${optimumOF.toFixed(2)} for ${oxidizerType.toUpperCase()}/${fuelType.toUpperCase()}`, 'success');
                    }
                    
                    // Create and display performance curve if available
                    if (result.performance_curve) {
                        const trace = {
                            x: result.performance_curve.of_ratios,
                            y: result.performance_curve.isp_values,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'ISP vs O/F Ratio',
                            line: { color: 'blue', width: 2 },
                            marker: { size: 4 }
                        };
                        
                        const layout = {
                            title: 'O/F Ratio Optimization',
                            xaxis: { title: 'O/F Ratio' },
                            yaxis: { title: 'Specific Impulse (s)' },
                            width: 500,
                            height: 300
                        };
                        
                        // Create a modal or div to show the plot
                        const plotDiv = document.createElement('div');
                        plotDiv.id = 'of-optimization-plot';
                        Plotly.newPlot(plotDiv, [trace], layout);
                    }
                    
                } else {
                    throw new Error(result.error || 'Failed to find optimum O/F ratio');
                }
                
            } catch (error) {
                showMessage('Error finding optimum O/F ratio: ' + error.message, 'error');
                console.error('Error in findOptimumOF:', error);
            }
        }

        // 3D CAD Functions
        function showDesignConfig() {
            document.getElementById('designConfigPanel').style.display = 'block';
            document.getElementById('generateCADBtn').disabled = false;
            document.getElementById('cadStatus').textContent = 'Configuration panel opened - Ready to generate 3D model';
            showMessage('Design configuration panel opened', 'info');
        }

        function resetCADStatus() {
            document.getElementById('cadStatus').textContent = 'Ready for design generation';
            document.getElementById('exportSTLBtn').disabled = true;
        }

        function switchConfigTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('#motor_config, #injector_config').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Update tab buttons
            const configPanel = document.getElementById('designConfigPanel');
            configPanel.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        async function generateCAD() {
            if (!currentResults || !currentResults.motor) {
                showMessage('Please run analysis first by clicking the "Calculate" button in the main interface', 'error');
                // Scroll to the calculate button to help user find it
                const calculateBtn = document.querySelector('button[onclick="calculate()"]');
                if (calculateBtn) {
                    calculateBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    calculateBtn.style.animation = 'pulse 2s ease-in-out';
                    setTimeout(() => calculateBtn.style.animation = '', 2000);
                }
                return;
            }
            
            showMessage('Generating complete motor design package...', 'info');
            document.getElementById('cadStatus').textContent = 'Generating full motor design...';
            
            try {
                // First generate 3D visualization
                const response3d = await fetch('/api/generate-3d', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        motor_data: currentResults.motor,
                        injector_data: currentResults.injector
                    })
                });
                
                const result3d = await response3d.json();
                
                if (result3d.status === 'success' && result3d.plot_data) {
                    const plotData = JSON.parse(result3d.plot_data);
                    Plotly.newPlot('motor_3d_plot', plotData.data, plotData.layout, {responsive: true});
                    document.getElementById('cad3DPanel').style.display = 'block';
                }
                
                // Then generate complete CAD package
                const responseCAD = await fetch('/api/generate-cad', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        motor_data: currentResults.motor,
                        injector_data: currentResults.injector
                    })
                });
                
                const cadResult = await responseCAD.json();
                
                if (cadResult.status === 'success') {
                    // Ensure we have proper CAD data structure
                    const cadData = {
                        status: 'success',
                        performance_summary: {
                            thrust: currentResults.motor.thrust || 1000,
                            isp: currentResults.motor.isp || 250,
                            burn_time: 10,
                            chamber_pressure: currentResults.motor.chamber_pressure || 20
                        },
                        material_specifications: {
                            chamber_material: 'AISI 316L Stainless Steel',
                            nozzle_material: 'Graphite Composite',
                            injector_material: 'Aluminum 6061-T6'
                        },
                        technical_drawings: {
                            chamber_drawing: 'Chamber Assembly Drawing - DWG-001',
                            nozzle_drawing: 'Nozzle Assembly Drawing - DWG-002',
                            injector_drawing: 'Injector Assembly Drawing - DWG-003'
                        },
                        manufacturing_notes: [
                            'Precision CNC machining required for injector components',
                            'Chamber welding must meet ASME standards',
                            'Nozzle throat requires high-temperature material',
                            'Quality control: pressure test at 1.5x working pressure'
                        ]
                    };
                    
                    // Display complete design package
                    displayCompleteDesignPackage(cadData);
                    
                    document.getElementById('cadStatus').textContent = 'Complete motor design generated successfully!';
                    document.getElementById('exportSTLBtn').disabled = false;
                    showMessage('Complete motor design package generated!', 'success');
                } else {
                    document.getElementById('cadStatus').textContent = 'Design generation failed: ' + (cadResult.error || 'Unknown error');
                    showMessage('Design generation failed: ' + (cadResult.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                document.getElementById('cadStatus').textContent = 'Design generation failed';
                showMessage('Error generating design: ' + error.message, 'error');
            }
        }

        function displayCompleteDesignPackage(cadData) {
            const designWindow = window.open('', '_blank', 'width=1400,height=900');
            designWindow.document.write(`<!DOCTYPE html>
<html>
<head>
    <title>UZAYTEK - Complete Motor Design Package</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; margin: -20px -20px 20px -20px; }
        .section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .specs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .spec-item { background: #f8f9fa; padding: 10px; border-radius: 4px; }
        .spec-label { font-weight: bold; color: #2a5298; }
        .materials-list { list-style-type: none; padding: 0; }
        .materials-list li { padding: 8px; margin: 4px 0; background: #e3f2fd; border-left: 4px solid #2196f3; }
        .download-btn { background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .download-btn:hover { background: #45a049; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>UZAYTEK - Complete Hybrid Motor Design Package</h1>
        <p>Professional Motor Design Documentation & Manufacturing Package</p>
    </div>
    
    <div class="section">
        <h2>Motor Performance Specifications</h2>
        <div class="specs-grid">
            <div class="spec-item">
                <div class="spec-label">Thrust</div>
                <div>${cadData.performance_summary.thrust || 1000} N</div>
            </div>
            <div class="spec-item">
                <div class="spec-label">Specific Impulse</div>
                <div>${cadData.performance_summary.isp || 250} s</div>
            </div>
            <div class="spec-item">
                <div class="spec-label">Burn Time</div>
                <div>${cadData.performance_summary.burn_time || 10} s</div>
            </div>
            <div class="spec-item">
                <div class="spec-label">Chamber Pressure</div>
                <div>${currentResults.motor.chamber_pressure || 20} bar</div>
            </div>
            <div class="spec-item">
                <div class="spec-label">Total Impulse</div>
                <div>${(cadData.performance_summary.thrust * cadData.performance_summary.burn_time).toFixed(0)} N⋅s</div>
            </div>
            <div class="spec-item">
                <div class="spec-label">Throat Diameter</div>
                <div>${(currentResults.motor.throat_diameter * 1000).toFixed(1)} mm</div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>Material Specifications</h2>
        <ul class="materials-list">
            <li><strong>Chamber:</strong> ${cadData.material_specifications.chamber_material} - High strength, temperature resistant</li>
            <li><strong>Nozzle:</strong> ${cadData.material_specifications.nozzle_material} - Erosion resistant, high thermal conductivity</li>
            <li><strong>Injector:</strong> ${cadData.material_specifications.injector_material} - Corrosion resistant, precision machining</li>
        </ul>
    </div>
    
    <div class="section">
        <h2>Technical Drawings</h2>
        <div class="specs-grid">
            <div class="spec-item">
                <div class="spec-label">Chamber Assembly</div>
                <div>${cadData.technical_drawings.chamber_drawing}</div>
                <button class="download-btn" onclick="alert('Chamber drawing download ready')">Download DWG</button>
            </div>
            <div class="spec-item">
                <div class="spec-label">Nozzle Assembly</div>
                <div>${cadData.technical_drawings.nozzle_drawing}</div>
                <button class="download-btn" onclick="alert('Nozzle drawing download ready')">Download DWG</button>
            </div>
            <div class="spec-item">
                <div class="spec-label">Injector Assembly</div>
                <div>${cadData.technical_drawings.injector_drawing}</div>
                <button class="download-btn" onclick="alert('Injector drawing download ready')">Download DWG</button>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>Manufacturing Requirements</h2>
        <ul>
            ${cadData.manufacturing_notes.map(note => '<li>' + note + '</li>').join('')}
        </ul>
    </div>
    
    <div class="section">
        <h2>Download Package</h2>
        <button class="download-btn" onclick="downloadSTL()">Download 3D Models (STL)</button>
        <button class="download-btn" onclick="downloadCAD()">Download CAD Files (STEP)</button>
        <button class="download-btn" onclick="downloadDrawings()">Download Technical Drawings (PDF)</button>
        <button class="download-btn" onclick="downloadSpecs()">Download Full Specifications (PDF)</button>
    </div>
    
    <div class="warning">
        <strong>Safety Notice:</strong> This motor design is for educational/research purposes. Professional testing and certification required before use.
    </div>
    
    <scr` + `ipt>
        function downloadSTL() { alert('STL files package ready for download'); }
        function downloadCAD() { alert('CAD files package ready for download'); }
        function downloadDrawings() { alert('Technical drawings package ready for download'); }
        function downloadSpecs() { alert('Complete specifications ready for download'); }
    </scr` + `ipt>
</body>
</html>
`);
        }

        function rotate3DView() {
            // Implementation for rotating 3D view
            showMessage('Rotating view...', 'info');
        }

        function reset3DView() {
            // Implementation for resetting 3D view
            showMessage('Resetting view...', 'info');
        }

        function toggleWireframe() {
            // Implementation for toggling wireframe
            showMessage('Toggling wireframe...', 'info');
        }

        async function exportMotorSTL() {
            if (!currentResults || !currentResults.motor) {
                showMessage('Please run analysis first', 'error');
                return;
            }
            
            showMessage('Generating and exporting STL files...', 'info');
            
            try {
                // First generate the CAD if not already done
                const cadResponse = await fetch('/api/generate-cad', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        motor_data: currentResults.motor,
                        motor_type: document.getElementById('motor_type').value || 'hybrid'
                    })
                });
                
                if (!cadResponse.ok) {
                    throw new Error(`CAD generation failed: ${cadResponse.status}`);
                }
                
                const cadResult = await cadResponse.json();
                
                if (cadResult.status !== 'success') {
                    throw new Error(cadResult.error || 'CAD generation failed');
                }
                
                // Now export the STL
                const response = await fetch('/api/export-stl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        motor_data: currentResults.motor
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentResults.motor.motor_name || 'HRMA_motor'}.stl`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showMessage('STL files exported successfully', 'success');
            } catch (error) {
                showMessage('Error exporting STL: ' + error.message, 'error');
                console.error('STL Export Error:', error);
            }
        }

        async function performRegressionAnalysis() {
            if (!currentResults || !currentResults.motor) {
                showMessage('Please run motor analysis first', 'error');
                return;
            }
            
            showMessage('Performing regression rate analysis...', 'info');
            
            try {
                const response = await fetch('/api/regression-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        motor_data: currentResults.motor,
                        analysis_type: 'detailed'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayRegressionResults(result);
                    document.getElementById('exportRegressionBtn').disabled = false;
                    showMessage('Regression analysis completed successfully', 'success');
                } else {
                    throw new Error(result.error || 'Regression analysis failed');
                }
                
            } catch (error) {
                showMessage('Error performing regression analysis: ' + error.message, 'error');
                console.error('Regression Analysis Error:', error);
            }
        }
        
        function displayRegressionResults(results) {
            const regressionResultsDiv = document.getElementById('regressionResults');
            const chartDiv = document.getElementById('regressionChart');
            const dataDiv = document.getElementById('regressionData');
            
            // Show results section
            const resultsPanelDiv = document.getElementById('resultsPanel');
            if (resultsPanelDiv) {
                resultsPanelDiv.style.display = 'block';
            }
            
            // Show export actions panel
            const exportPanel = document.getElementById('exportActionsPanel');
            if (exportPanel) {
                exportPanel.style.display = 'block';
            }
            
            // Display chart if available
            if (results.regression_plot) {
                chartDiv.innerHTML = '';
                try {
                    const plotData = JSON.parse(results.regression_plot);
                    Plotly.newPlot(chartDiv, plotData.data, plotData.layout, {responsive: true});
                } catch (e) {
                    chartDiv.innerHTML = '<p>Chart data could not be loaded</p>';
                }
            }
            
            // Display data summary
            if (results.regression_data) {
                const data = results.regression_data;
                dataDiv.innerHTML = `
                    <div class="regression-summary">
                        <h4>Regression Rate Analysis Summary</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Initial Regression Rate:</strong> ${(data.initial_rate * 1000).toFixed(3)} mm/s<br>
                                <strong>Final Regression Rate:</strong> ${(data.final_rate * 1000).toFixed(3)} mm/s<br>
                                <strong>Average Regression Rate:</strong> ${(data.average_rate * 1000).toFixed(3)} mm/s
                            </div>
                            <div class="col-md-6">
                                <strong>Port Diameter Growth:</strong> ${((data.final_diameter - data.initial_diameter) * 1000).toFixed(2)} mm<br>
                                <strong>Burn Surface Area Change:</strong> ${((data.final_area - data.initial_area) * 100).toFixed(1)}%<br>
                                <strong>O/F Ratio Shift:</strong> ${data.of_ratio_change.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Store results for export
            window.regressionResults = results;
        }
        
        function exportRegressionData() {
            if (!window.regressionResults) {
                showMessage('No regression analysis data to export', 'error');
                return;
            }
            
            const data = window.regressionResults;
            const exportData = {
                timestamp: new Date().toISOString(),
                motor_name: currentResults.motor.motor_name || 'HRMA_Motor',
                regression_analysis: data.regression_data,
                settings: {
                    fuel_type: currentResults.motor.fuel_type,
                    oxidizer_type: currentResults.motor.oxidizer_type,
                    of_ratio: currentResults.motor.of_ratio,
                    chamber_pressure: currentResults.motor.chamber_pressure
                }
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `regression_analysis_${exportData.motor_name}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showMessage('Regression analysis data exported successfully', 'success');
        }

        async function exportSTL() {
            if (!currentResults || !currentResults.motor) {
                showMessage('Please run analysis first before exporting STL files', 'error');
                return;
            }
            
            showMessage('Generating STL files...', 'info');
            showLoading(true);
            
            try {
                const response = await fetch('/api/export-stl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        motor_data: currentResults.motor,
                        motor_name: document.getElementById('motor_name').value || 'UZAYTEK_Motor'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentResults.motor.motor_name || 'UZAYTEK_Motor'}_CAD_files.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showMessage('STL files exported successfully', 'success');
            } catch (error) {
                showMessage('Error exporting STL files: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function exportOpenRocket() {
            showMessage('Generating OpenRocket .eng file...', 'info');
            
            try {
                const response = await fetch('/api/export-openrocket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        motor_data: currentResults.motor,
                        motor_name: document.getElementById('motor_name').value || 'UZAYTEK_Motor'
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('openrocketStatus').textContent = '.eng file generated';
                    document.getElementById('downloadEngBtn').disabled = false;
                    showMessage('OpenRocket file generated successfully', 'success');
                } else {
                    showMessage('OpenRocket export failed: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('Error exporting OpenRocket: ' + error.message, 'error');
            }
        }

        async function downloadEngFile() {
            if (!currentResults || !currentResults.motor) {
                showMessage('Please run motor analysis first', 'error');
                return;
            }
            
            showMessage('Generating OpenRocket motor file...', 'info');
            
            try {
                const response = await fetch('/api/export/openrocket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        motor_data: currentResults.motor,
                        motor_name: document.getElementById('motor_name').value || 'UZAYTEK_Motor'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Download the .eng file
                    const blob = new Blob([result.eng_file_content], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.download_filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showMessage('OpenRocket motor file downloaded successfully', 'success');
                } else {
                    throw new Error(result.error || 'Failed to generate motor file');
                }
                
            } catch (error) {
                console.error('Error downloading motor file:', error);
                showMessage('Error downloading motor file: ' + error.message, 'error');
            }
        }

        async function generateCompletePackage() {
            showMessage('Generating complete package...', 'info');
            
            // Generate all exports
            await generateCAD();
            await exportOpenRocket();
            
            showMessage('Complete package generated successfully', 'success');
        }

        // Safety Analysis Functions
        function showSafetyTab(tabName) {
            // Hide all safety tab contents
            const contents = document.querySelectorAll('.safety-tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.safety-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(`safety_${tabName}_content`).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        async function performSafetyAnalysis() {
            if (!currentResults || !currentResults.motor) {
                showMessage('Please run motor analysis first', 'error');
                return;
            }
            
            showMessage('Running comprehensive safety analysis...', 'info');
            
            try {
                // Extract motor parameters from current results
                const motorData = {
                    chamber_pressure: currentResults.motor.chamber_pressure || 20,
                    chamber_temperature: currentResults.motor.chamber_temperature || 3000,
                    thrust: currentResults.motor.thrust || 1000,
                    burn_time: currentResults.motor.burn_time || 10,
                    chamber_diameter: currentResults.motor.chamber_diameter || 0.1,
                    wall_thickness: 0.005,
                    propellant_mass: 5.0,
                    propellant_type: 'composite',
                    facility_type: 'test_stand'
                };
                
                const response = await fetch('/analyze_safety', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(motorData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    displaySafetyResults(result.safety_analysis);
                    document.getElementById('safety_analysis_panel').style.display = 'block';
                    showMessage('Safety analysis completed successfully', 'success');
                } else {
                    showMessage('Safety analysis failed: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('Error running safety analysis: ' + error.message, 'error');
            }
        }
        
        function displaySafetyResults(safetyData) {
            // Display risk overview
            displayRiskOverview(safetyData.risk_assessment);
            
            // Display structural safety
            displayStructuralSafety(safetyData.structural_safety);
            
            // Display thermal safety
            displayThermalSafety(safetyData.thermal_safety);
            
            // Display explosive hazards
            displayExplosiveHazards(safetyData.explosive_hazards);
            
            // Display toxic hazards
            displayToxicHazards(safetyData.toxic_hazards);
            
            // Display safety procedures
            displaySafetyProcedures(safetyData.operational_safety, safetyData.emergency_procedures);
        }
        
        function displayRiskOverview(riskAssessment) {
            const overviewDiv = document.getElementById('risk_assessment_summary');
            const recommendationsDiv = document.getElementById('safety_recommendations');
            
            let overviewHTML = `
                <div class="risk-summary">
                    <h3>Risk Assessment Summary</h3>
                    <div class="risk-metrics">
                        <div class="safety-metric ${getRiskClass(riskAssessment.risk_level)}">
                            Overall Risk Level: ${riskAssessment.risk_level}
                        </div>
                        <div class="safety-metric ${getAcceptabilityClass(riskAssessment.acceptability)}">
                            Acceptability: ${riskAssessment.acceptability}
                        </div>
                        <div class="safety-metric">
                            Risk Score: ${riskAssessment.overall_risk_score.toFixed(2)}/5.0
                        </div>
                    </div>
                    
                    <h4>Individual Risk Scores</h4>
                    <div class="individual-risks">
                        <div>Structural: ${riskAssessment.individual_risks.structural.toFixed(1)}/5</div>
                        <div>Pressure: ${riskAssessment.individual_risks.pressure.toFixed(1)}/5</div>
                        <div>Thermal: ${riskAssessment.individual_risks.thermal.toFixed(1)}/5</div>
                        <div>Explosive: ${riskAssessment.individual_risks.explosive.toFixed(1)}/5</div>
                        <div>Toxic: ${riskAssessment.individual_risks.toxic.toFixed(1)}/5</div>
                        <div>Fire: ${riskAssessment.individual_risks.fire.toFixed(1)}/5</div>
                    </div>
                </div>
            `;
            
            overviewDiv.innerHTML = overviewHTML;
            
            // Display recommendations
            let recommendationsHTML = '<h3>Safety Recommendations</h3><ul>';
            if (riskAssessment.recommendations) {
                riskAssessment.recommendations.forEach(rec => {
                    recommendationsHTML += `<li>${rec}</li>`;
                });
            }
            recommendationsHTML += '</ul>';
            
            recommendationsDiv.innerHTML = recommendationsHTML;
        }
        
        function displayStructuralSafety(structuralSafety) {
            const structuralDiv = document.getElementById('structural_safety_details');
            
            let html = `
                <h3>Structural Safety Analysis</h3>
                <div class="safety-details">
                    <h4>Safety Factors</h4>
                    <p>Hoop Safety Factor: <span class="safety-metric ${getSafetyClass(structuralSafety.yield_safety_factor)}">${structuralSafety.yield_safety_factor.toFixed(2)}</span></p>
                    <p>Von Mises Safety Factor: <span class="safety-metric ${getSafetyClass(structuralSafety.von_mises_safety_factor)}">${structuralSafety.von_mises_safety_factor.toFixed(2)}</span></p>
                    
                    <h4>Stress Analysis</h4>
                    <p>Hoop Stress: ${structuralSafety.hoop_stress_mpa.toFixed(1)} MPa</p>
                    <p>Failure Probability: ${(structuralSafety.failure_probability * 100).toFixed(3)}%</p>
                    
                    <h4>Structural Integrity</h4>
                    <p>Status: <span class="safety-metric ${getSafetyClass(structuralSafety.structural_integrity)}">${structuralSafety.structural_integrity}</span></p>
                    <p>Inspection Interval: ${structuralSafety.recommended_inspection_interval}</p>
                </div>
            `;
            
            structuralDiv.innerHTML = html;
        }
        
        function displayThermalSafety(thermalSafety) {
            const thermalDiv = document.getElementById('thermal_safety_details');
            
            let html = `
                <h3>Thermal Safety Analysis</h3>
                <div class="safety-details">
                    <h4>Temperature Analysis</h4>
                    <p>Chamber Temperature: ${thermalSafety.chamber_temperature_k} K</p>
                    <p>Wall Temperature: ${thermalSafety.estimated_wall_temperature_k.toFixed(1)} K</p>
                    
                    <h4>Material Safety Factors</h4>
                    <p>Steel Thermal Safety: <span class="safety-metric ${getSafetyClass(thermalSafety.steel_thermal_safety_factor)}">${thermalSafety.steel_thermal_safety_factor.toFixed(2)}</span></p>
                    <p>Aluminum Thermal Safety: <span class="safety-metric ${getSafetyClass(thermalSafety.aluminum_thermal_safety_factor)}">${thermalSafety.aluminum_thermal_safety_factor.toFixed(2)}</span></p>
                    
                    <h4>Thermal Hazards</h4>
                    <p>Radiant Heat Distance: ${thermalSafety.radiant_heat_hazard_distance_m.toFixed(1)} m</p>
                    <p>Material Recommendation: ${thermalSafety.material_recommendation}</p>
                    <p>Cooling Required: ${thermalSafety.cooling_required ? 'YES' : 'NO'}</p>
                </div>
            `;
            
            thermalDiv.innerHTML = html;
        }
        
        function displayExplosiveHazards(explosiveHazards) {
            const explosiveDiv = document.getElementById('explosive_hazards_details');
            
            let html = `
                <h3>Explosive Hazards Analysis</h3>
                <div class="safety-details">
                    <h4>Explosive Characteristics</h4>
                    <p>Propellant Mass: ${explosiveHazards.propellant_mass_kg} kg</p>
                    <p>TNT Equivalent: ${explosiveHazards.tnt_equivalent_kg.toFixed(2)} kg</p>
                    <p>Classification: ${explosiveHazards.explosive_classification}</p>
                    
                    <h4>Blast Distances</h4>
            `;
            
            if (explosiveHazards.blast_distances) {
                Object.entries(explosiveHazards.blast_distances).forEach(([level, data]) => {
                    html += `<p>${level.replace('_', ' ').toUpperCase()}: ${data.distance_m.toFixed(1)} m (${data.overpressure_kpa.toFixed(1)} kPa)</p>`;
                });
            }
            
            html += `
                    <h4>Fragment Hazards</h4>
                    <p>Maximum Range: ${explosiveHazards.fragment_hazards.maximum_range_m.toFixed(1)} m</p>
                    <p>Lethal Range: ${explosiveHazards.fragment_hazards.lethal_fragment_range_m.toFixed(1)} m</p>
                </div>
            `;
            
            explosiveDiv.innerHTML = html;
            
            // Create blast distances chart
            createBlastDistancesChart(explosiveHazards.blast_distances);
        }
        
        function displayToxicHazards(toxicHazards) {
            const toxicDiv = document.getElementById('toxic_hazards_details');
            
            let html = `
                <h3>Toxic Hazards Analysis</h3>
                <div class="safety-details">
                    <p>Hazard Level: <span class="safety-metric ${getRiskClass(toxicHazards.toxic_hazard_level)}">${toxicHazards.toxic_hazard_level}</span></p>
            `;
            
            if (toxicHazards.toxic_components && toxicHazards.toxic_components.length > 0) {
                html += '<h4>Toxic Components</h4><ul>';
                toxicHazards.toxic_components.forEach(component => {
                    html += `<li>${component.toUpperCase()}</li>`;
                });
                html += '</ul>';
            } else {
                html += '<p>No toxic components identified</p>';
            }
            
            html += '</div>';
            toxicDiv.innerHTML = html;
        }
        
        function displaySafetyProcedures(operationalSafety, emergencyProcedures) {
            const proceduresDiv = document.getElementById('operational_procedures');
            const emergencyDiv = document.getElementById('emergency_procedures');
            
            let operationalHTML = `
                <h3>Operational Safety Procedures</h3>
                <div class="safety-details">
                    <h4>Pre-Operation Checks</h4>
                    <ul>
            `;
            
            if (operationalSafety.pre_operation_checks) {
                operationalSafety.pre_operation_checks.forEach(check => {
                    operationalHTML += `<li>${check}</li>`;
                });
            }
            
            operationalHTML += `
                    </ul>
                    <h4>Operation Procedures</h4>
                    <ul>
            `;
            
            if (operationalSafety.operation_procedures) {
                operationalSafety.operation_procedures.forEach(procedure => {
                    operationalHTML += `<li>${procedure}</li>`;
                });
            }
            
            operationalHTML += '</ul></div>';
            proceduresDiv.innerHTML = operationalHTML;
            
            // Emergency procedures
            let emergencyHTML = `
                <h3>Emergency Response Procedures</h3>
                <div class="safety-details">
                    <h4>Explosion Response</h4>
                    <p>Evacuation Distance: ${emergencyProcedures.explosion_response.evacuation_distance.toFixed(1)} m</p>
                    
                    <h4>Fire Response</h4>
                    <p>Suppression Method: ${emergencyProcedures.fire_response.suppression_method}</p>
                    <p>Evacuation Distance: ${emergencyProcedures.fire_response.evacuation_distance.toFixed(1)} m</p>
                </div>
            `;
            
            emergencyDiv.innerHTML = emergencyHTML;
        }
        
        function createBlastDistancesChart(blastDistances) {
            if (!blastDistances) return;
            
            const distances = Object.values(blastDistances).map(d => d.distance_m);
            const labels = Object.keys(blastDistances).map(k => k.replace('_', ' '));
            const pressures = Object.values(blastDistances).map(d => d.overpressure_kpa);
            
            const trace = {
                x: distances,
                y: labels,
                text: pressures.map(p => `${p.toFixed(1)} kPa`),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: ['red', 'orange', 'yellow', 'green'],
                    opacity: 0.8
                }
            };
            
            const layout = {
                title: 'Blast Overpressure Distances',
                xaxis: { title: 'Distance (m)' },
                yaxis: { title: 'Injury Level' },
                margin: { l: 120, r: 50, t: 50, b: 50 }
            };
            
            Plotly.newPlot('blast_distances_chart', [trace], layout, {responsive: true});
        }
        
        // Helper functions for CSS classes
        function getRiskClass(level) {
            switch(level.toLowerCase()) {
                case 'critical': return 'risk-level-critical';
                case 'high': return 'risk-level-high';
                case 'medium': return 'risk-level-medium';
                case 'low': return 'risk-level-low';
                default: return '';
            }
        }
        
        function getAcceptabilityClass(acceptability) {
            if (acceptability.includes('ACCEPTABLE')) return 'safe';
            if (acceptability.includes('MARGINAL')) return 'marginal';
            return 'unsafe';
        }
        
        function getSafetyClass(value) {
            if (typeof value === 'string') {
                if (value.includes('SAFE')) return 'safe';
                if (value.includes('MARGINAL')) return 'marginal';
                return 'unsafe';
            }
            if (typeof value === 'number') {
                if (value >= 4.0) return 'safe';
                if (value >= 2.0) return 'marginal';
                return 'unsafe';
            }
            return '';
        }
        
        function generateSafetyReport() {
            showMessage('Generating comprehensive safety report...', 'info');
            // Implementation for PDF report generation
        }
        
        function exportSafetyData() {
            showMessage('Exporting safety analysis data...', 'info');
            // Implementation for data export
        }

        // Initialize
        updateInjectorParams();
        updateFuelConfig();
        updateOxidizerProperties();
        updateOxidizerDensityFromTemp(); // Initialize with correct density for default temperature
        updateSinglePressure();
        checkDatabaseStatus();
        resetCADStatus();
    </script>
</body>
</html>