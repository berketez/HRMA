<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solid Motor Analysis - Motor Analysis Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        
        .navbar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar h1 {
            font-size: 24px;
            font-weight: 300;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            transition: background 0.3s;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background: rgba(255,255,255,0.2);
        }
        
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        
        .panel { 
            background: white; 
            margin: 15px 0; 
            padding: 25px; 
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .panel h2 { 
            color: #1e3c72; 
            font-size: 20px; 
            margin-bottom: 20px; 
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 5px; 
            color: #495057;
            font-size: 14px;
        }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 8px 12px; 
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        .unit { color: #6c757d; font-size: 12px; font-weight: normal; }
        
        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .results { display: none; }
        .plot-container { 
            height: 400px; 
            border: 1px solid #e9ecef; 
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .chart-explanation {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .chart-explanation p {
            margin: 0 0 10px 0;
            font-weight: 500;
            color: #2a5298;
        }
        
        .chart-explanation ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .chart-explanation li {
            margin-bottom: 5px;
            color: #495057;
        }
        
        .chart-explanation li strong {
            color: #2a5298;
            font-weight: 600;
        }
        
        .metric-card {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            color: white;
            margin-bottom: 15px;
        }
        .metric-value { font-size: 32px; font-weight: 300; }
        .metric-label { font-size: 14px; opacity: 0.9; }
        .metric-unit { font-size: 12px; opacity: 0.7; }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        /* Tooltip Styles */
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
        }
        
        .tooltip-icon {
            width: 16px;
            height: 16px;
            background: #6c757d;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            transition: background 0.3s;
        }
        
        .tooltip-icon:hover {
            background: #f093fb;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background: #2c3e50;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .form-group label {
            display: flex;
            align-items: center;
        }
        
        .grain-preview {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="navbar">
        <h1>MOTOR ANALYSIS - Solid Propellant</h1>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/hybrid">Hybrid</a>
            <a href="/solid" class="active">Solid</a>
            <a href="/liquid">Liquid</a>
            <a href="/formulas">Formulas</a>
        </div>
    </div>
    
    <div class="container">
        <!-- Input Parameters -->
        <!-- 1. Propellant Properties -->
        <div class="panel">
            <h2>1. Propellant Properties</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Propellant Name/Formulation
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Chemical name and formulation of the solid propellant (KNSU, APCP, etc.). Common types: APCP for high performance, KNSU for amateur use, Black Powder for traditional applications.</span>
                        </div>
                    </label>
                    <input type="text" id="propellant_name" value="APCP" placeholder="KNSU, APCP, etc.">
                </div>
                <div class="form-group">
                    <label>
                        Density ρp <span class="unit">(kg/m³)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Bulk density of the solid propellant. Typical values: APCP: 1800-1900, KNSU: 1800-1900, Black Powder: 1600-1700. Higher density provides more propellant mass per unit volume.</span>
                        </div>
                    </label>
                    <input type="number" id="density" value="1850" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Heat of Combustion ΔHc <span class="unit">(kJ/kg)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Energy released per unit mass during combustion. Higher values indicate better energy content. APCP: 2000-3000 kJ/kg, KNSU: 3000-4000 kJ/kg.</span>
                        </div>
                    </label>
                    <input type="number" id="heat_value" value="2500" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Adiabatic Flame Temperature Tc <span class="unit">(K)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Maximum theoretical combustion temperature. APCP: 3200-3400K, KNSU: 1600-1800K. Higher temperatures generally provide better specific impulse.</span>
                        </div>
                    </label>
                    <input type="number" id="flame_temp" value="3200" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Molecular Weight M <span class="unit">(g/mol)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Average molecular weight of combustion products. Lower values generally provide higher specific impulse. Typical range: 20-35 g/mol.</span>
                        </div>
                    </label>
                    <input type="number" id="molecular_weight" value="28.5" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Specific Heat Ratio γ
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Ratio of specific heats (Cp/Cv) for combustion products. Typical values: 1.2-1.3. Higher values provide better nozzle expansion efficiency.</span>
                        </div>
                    </label>
                    <input type="number" id="gamma" value="1.25" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Characteristic Velocity c* <span class="unit">(m/s)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Theoretical performance parameter independent of nozzle design. Higher values indicate better propellant performance. APCP: 1500-1600 m/s, KNSU: 1200-1300 m/s.</span>
                        </div>
                    </label>
                    <input type="number" id="char_velocity" value="1550" step="0.1">
                    <button type="button" onclick="calculateCharVelocity()" style="margin-top: 5px; padding: 5px 10px; font-size: 12px;">Calculate</button>
                </div>
                <div class="form-group">
                    <label>
                        Erosive Burning Coefficient k
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Coefficient for burn rate enhancement at high mass flux conditions. Accounts for increased burning rate due to convective heat transfer from hot gas flow.</span>
                        </div>
                    </label>
                    <input type="number" id="erosive_k" value="0.0002" step="0.0001">
                </div>
                <div class="form-group">
                    <label>
                        Erosive Burning Exponent m
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Exponent for erosive burning law. Typical values: 0.6-0.8. Higher values indicate stronger dependence on mass flux.</span>
                        </div>
                    </label>
                    <input type="number" id="erosive_m" value="0.8" step="0.01">
                </div>
                <div class="form-group">
                    <label>
                        Temperature Coefficient σ <span class="unit">(1/K)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Temperature sensitivity coefficient for burn rate law: r = a·P^n·(1+σ·ΔT). Accounts for propellant temperature effects on burning rate.</span>
                        </div>
                    </label>
                    <input type="number" id="temp_coeff" value="0.002" step="0.0001">
                </div>
            </div>
        </div>

        <!-- 2. Grain Geometry -->
        <div class="panel">
            <h2>2. Grain Geometry</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Number of Grains N
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Total number of propellant grains in the motor. Multiple grains reduce manufacturing stress and allow for modular design. Typical range: 1-6 grains.</span>
                        </div>
                    </label>
                    <input type="number" id="grain_count" value="3" min="1">
                </div>
                <div class="form-group">
                    <label>
                        Web Thickness <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Minimum thickness of propellant that burns away completely. Determines burn time and structural integrity. Typically 15-50mm for amateur motors.</span>
                        </div>
                    </label>
                    <input type="number" id="web_thickness" value="25" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Grain Type
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Geometric configuration of the solid propellant grain. BATES: cylindrical with core hole, neutral thrust. Star: star-shaped core for progressive thrust. Finocyl: fins for high burning surface. Wagon Wheel: multiple cores for regressive thrust. End Burner: burns from one end only.</span>
                        </div>
                    </label>
                    <select id="grain_type" onchange="updateGrainPreview()">
                        <option value="bates">BATES (Cylindrical)</option>
                        <option value="star">Star</option>
                        <option value="finocyl">Finocyl</option>
                        <option value="slotted">Slotted</option>
                        <option value="wagon_wheel">Wagon Wheel</option>
                        <option value="end_burner">End Burner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        Outer Diameter <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Outer diameter of the propellant grain. Must be smaller than chamber inner diameter to allow for insulation and clearance. Typical range: 50-150mm.</span>
                        </div>
                    </label>
                    <input type="number" id="outer_diameter" value="100" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Core Diameter <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Initial diameter of the central core hole (port diameter). Determines initial burning surface area and thrust profile. Smaller cores give progressive thrust, larger cores give regressive thrust.</span>
                        </div>
                    </label>
                    <input type="number" id="core_diameter" value="30" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Grain Length <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Axial length of individual propellant grain. Longer grains provide more total impulse but may cause combustion instability. Length-to-diameter ratio should typically be 3:1 to 8:1.</span>
                        </div>
                    </label>
                    <input type="number" id="grain_length" value="500" step="0.1">
                </div>
            </div>

            <!-- Star Configuration -->
            <div id="star_config" class="config-section" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <h3 style="color: #e74c3c; margin-bottom: 15px;">Star Configuration</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            Number of Points
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Number of star points. More points provide higher initial burning surface but may cause structural issues. Typical range: 4-8 points.</span>
                            </div>
                        </label>
                        <input type="number" id="star_points" value="6" min="3">
                    </div>
                    <div class="form-group">
                        <label>
                            Point Radius <span class="unit">(mm)</span>
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Radius of star points from center. Determines burning surface area and progressive characteristics.</span>
                            </div>
                        </label>
                        <input type="number" id="star_radius" value="15" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>
                            Fillet Radius <span class="unit">(mm)</span>
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Radius of fillets at star valleys to reduce stress concentration. Improves grain structural integrity.</span>
                            </div>
                        </label>
                        <input type="number" id="star_fillet" value="2" step="0.1">
                    </div>
                </div>
            </div>

            <!-- Finocyl Configuration -->
            <div id="finocyl_config" class="config-section" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <h3 style="color: #e74c3c; margin-bottom: 15px;">Finocyl Configuration</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            Number of Fins
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Number of radial fins extending from core. More fins provide higher burning surface area. Typical range: 2-6 fins.</span>
                            </div>
                        </label>
                        <input type="number" id="fin_count" value="4" min="2">
                    </div>
                    <div class="form-group">
                        <label>
                            Fin Width <span class="unit">(mm)</span>
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Thickness of each fin slot. Affects burning surface area and grain structural integrity.</span>
                            </div>
                        </label>
                        <input type="number" id="fin_width" value="8" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>
                            Fin Length <span class="unit">(mm)</span>
                            <div class="tooltip">
                                <div class="tooltip-icon">?</div>
                                <span class="tooltip-text">Radial length of fin slots from core to outer diameter. Determines progressive burning characteristics.</span>
                            </div>
                        </label>
                        <input type="number" id="fin_length" value="20" step="0.1">
                    </div>
                </div>
            </div>

            <!-- Inhibitor Settings -->
            <div style="margin: 15px 0;">
                <h3 style="color: #2c3e50; margin-bottom: 10px;">Inhibitor Coating</h3>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="inhibit_front" checked> 
                        Front Face
                        <div class="tooltip" style="margin-left: 5px;">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Prevents burning on forward end face. Usually inhibited to prevent forward burning.</span>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="inhibit_rear" checked> 
                        Rear Face
                        <div class="tooltip" style="margin-left: 5px;">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Prevents burning on aft end face. Usually inhibited to prevent aft burning.</span>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="inhibit_outer"> 
                        Outer Surface
                        <div class="tooltip" style="margin-left: 5px;">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Prevents burning on outer cylindrical surface. Usually inhibited for core-burning grains.</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Grain-to-Grain Gap <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Spacing between individual grains. Allows for thermal expansion and prevents grain-to-grain bonding during storage.</span>
                        </div>
                    </label>
                    <input type="number" id="grain_gap" value="2" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Insulation Thickness <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Thickness of thermal insulation layer between propellant and case. Protects case from high temperatures and provides thermal barrier.</span>
                        </div>
                    </label>
                    <input type="number" id="insulation_thickness" value="3" step="0.1">
                </div>
            </div>
            
            <div class="grain-preview" id="grain_preview">
                <svg width="180" height="180" viewBox="0 0 180 180">
                    <!-- BATES grain default -->
                    <circle cx="90" cy="90" r="80" fill="#e9ecef" stroke="#495057" stroke-width="2"/>
                    <circle cx="90" cy="90" r="25" fill="white" stroke="#495057" stroke-width="2"/>
                </svg>
            </div>
        </div>
        
        <!-- 3. Combustion Chamber and Casing -->
        <div class="panel">
            <h2>3. Combustion Chamber and Casing</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Chamber Diameter <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Internal diameter of the motor casing that contains the propellant grain. Determines the maximum grain outer diameter and affects chamber volume. Typical range: 50-200mm for amateur motors.</span>
                        </div>
                    </label>
                    <input type="number" id="chamber_diameter" value="100" step="1">
                </div>
                <div class="form-group">
                    <label>
                        Case Internal Volume <span class="unit">(L)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Free volume inside the motor case excluding propellant volume. Affects chamber pressure buildup and combustion dynamics. Include volume of forward and aft chambers.</span>
                        </div>
                    </label>
                    <input type="number" id="chamber_volume" value="2.5" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Case Material
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Material for motor casing construction. Steel: high strength, heavy. Aluminum: lighter, lower strength. Composite: lightweight, high strength but expensive.</span>
                        </div>
                    </label>
                    <select id="case_material">
                        <option value="steel">Steel</option>
                        <option value="aluminum">Aluminum</option>
                        <option value="composite">Composite</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        Yield Strength σy <span class="unit">(MPa)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Yield strength of case material. Steel: 200-400 MPa, Aluminum: 100-300 MPa, Composite: 300-800 MPa. Used for case stress analysis and wall thickness calculation.</span>
                        </div>
                    </label>
                    <input type="number" id="yield_strength" value="250" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Safety Factor FoS
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Factor of safety for case design. Typical values: 2-4. Higher values provide more safety margin but increase case weight. Required by safety codes for amateur rocketry.</span>
                        </div>
                    </label>
                    <input type="number" id="safety_factor" value="2.5" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Liner Thickness <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Thickness of insulating liner layer. Protects case from hot combustion gases and provides thermal barrier. Typical materials: phenolic, EPDM rubber.</span>
                        </div>
                    </label>
                    <input type="number" id="liner_thickness" value="2" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Liner Density <span class="unit">(kg/m³)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Density of liner material for mass calculation. Phenolic: 1200-1400 kg/m³, EPDM: 1200-1300 kg/m³. Affects overall motor mass.</span>
                        </div>
                    </label>
                    <input type="number" id="liner_density" value="1200" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Initial Temperature <span class="unit">(K)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Initial chamber temperature before ignition. Affects propellant burn rate and pressure buildup. Standard conditions: 298K (25°C). Cold weather reduces performance.</span>
                        </div>
                    </label>
                    <input type="number" id="initial_temp" value="298" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Case Wall Thickness <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Wall thickness of motor case. Must be sufficient to withstand internal pressure with adequate safety factor. Calculated from hoop stress formula or specified directly.</span>
                        </div>
                    </label>
                    <input type="number" id="case_thickness" value="8" step="0.1">
                </div>
            </div>
        </div>

        <!-- 4. Nozzle -->
        <div class="panel">
            <h2>4. Nozzle</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Throat Diameter Dt <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Nozzle throat diameter - critical parameter that determines chamber pressure and mass flow rate. Smaller throat = higher pressure. Must be sized for desired pressure and thrust.</span>
                        </div>
                    </label>
                    <input type="number" id="throat_diameter" value="15" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Exit Diameter De <span class="unit">(mm)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Nozzle exit diameter. Larger exit provides better expansion and higher specific impulse at altitude but increases nozzle weight and length.</span>
                        </div>
                    </label>
                    <input type="number" id="exit_diameter" value="35" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Expansion Ratio ε
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Ratio of exit area to throat area (Ae/At). Automatically calculated from diameters. Higher ratios provide better performance at altitude but risk flow separation at sea level.</span>
                        </div>
                    </label>
                    <input type="number" id="expansion_ratio" value="5.44" step="0.1" readonly>
                </div>
                <div class="form-group">
                    <label>
                        Convergent Angle <span class="unit">(°)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Half-angle of convergent section approaching the throat. Typical values: 20-45°. Affects flow uniformity and pressure losses in subsonic region.</span>
                        </div>
                    </label>
                    <input type="number" id="convergent_angle" value="45" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Divergent Angle <span class="unit">(°)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Half-angle of divergent section after the throat. Typical values: 12-18°. Larger angles cause flow separation, smaller angles increase nozzle length and weight.</span>
                        </div>
                    </label>
                    <input type="number" id="divergent_angle" value="15" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Nozzle Efficiency ηn
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Overall nozzle efficiency including divergence losses, friction, and heat transfer. Typical values: 0.94-0.98. Accounts for real-world performance reduction from ideal conditions.</span>
                        </div>
                    </label>
                    <input type="number" id="nozzle_efficiency" value="0.95" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Erosion Factor <span class="unit">(mm/s)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Rate of throat diameter increase due to erosion during burn. Affects performance over burn time. Depends on propellant type and nozzle material. Graphite: ~0.001 mm/s.</span>
                        </div>
                    </label>
                    <input type="number" id="erosion_factor" value="0.001" step="0.0001">
                </div>
                <div class="form-group">
                    <label>
                        Nozzle Material
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Material for nozzle construction. Graphite: good thermal properties, easy machining, moderate erosion. Phenolic: low cost, higher erosion. Tungsten: low erosion, expensive, difficult machining.</span>
                        </div>
                    </label>
                    <select id="nozzle_material">
                        <option value="graphite">Graphite</option>
                        <option value="phenolic">Phenolic</option>
                        <option value="tungsten">Tungsten</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        Chamber Pressure <span class="unit">(bar)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Operating pressure in the combustion chamber. Higher pressure increases performance but requires stronger casing. Solid motors typically operate at 20-70 bar. Safety factor of 2-4x is required for casing design.</span>
                        </div>
                    </label>
                    <input type="number" id="chamber_pressure" value="40" step="1">
                </div>
            </div>
        </div>
        
        <!-- 5. Efficiency and Empirical Coefficients -->
        <div class="panel">
            <h2>5. Efficiency and Empirical Coefficients</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Burn Rate Coefficient (a) <span class="unit">(mm/s/bar^n)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Material-specific coefficient in burn rate law r=a×P^n. APCP: 0.003-0.008, Black Powder: 0.1-0.3, Sugar: 0.01-0.05. Higher values mean faster burning propellant. Obtained from strand burner tests.</span>
                        </div>
                    </label>
                    <input type="number" id="burn_rate_a" value="0.005" step="0.0001">
                </div>
                <div class="form-group">
                    <label>
                        Burn Rate Exponent (n)
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Pressure sensitivity exponent in burn rate law r=a×P^n. Values 0.2-0.8 typical. Low n (0.2-0.4) gives stable combustion. High n (0.6+) can cause pressure instability. APCP: 0.3-0.5, Black Powder: 0.7-1.0.</span>
                        </div>
                    </label>
                    <input type="number" id="burn_rate_n" value="0.35" step="0.01">
                </div>
                <div class="form-group">
                    <label>
                        Combustion Efficiency ηc
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">c* efficiency factor. Accounts for incomplete combustion and heat losses. Typical values: 0.92-0.98. Higher values indicate better propellant mixing and combustion completeness.</span>
                        </div>
                    </label>
                    <input type="number" id="combustion_efficiency" value="0.95" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Nozzle Discharge Efficiency (Cf)
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Cf efficiency factor accounting for nozzle losses including friction, heat transfer, and flow non-uniformities. Typical values: 0.96-0.99.</span>
                        </div>
                    </label>
                    <input type="number" id="cf_efficiency" value="0.98" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Overall Thrust Efficiency ηoverall
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Combined efficiency of entire propulsion system including combustion, nozzle, and two-phase flow losses. Product of all individual efficiencies.</span>
                        </div>
                    </label>
                    <input type="number" id="overall_efficiency" value="0.92" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Discharge Coefficient Cd
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Flow discharge coefficient for mass flow through nozzle throat. Accounts for viscous effects and flow non-uniformities. Typical values: 0.97-0.99.</span>
                        </div>
                    </label>
                    <input type="number" id="discharge_coeff" value="0.98" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Kinetic Efficiency
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Efficiency of converting thermal energy to kinetic energy in the nozzle. Accounts for incomplete expansion and non-ideal gas effects. Typical values: 0.95-0.98.</span>
                        </div>
                    </label>
                    <input type="number" id="kinetic_efficiency" value="0.97" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Divergence Loss Factor
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Thrust loss due to non-axial flow in divergent nozzle section. Depends on divergent half-angle. Typical values: 0.01-0.05 (1-5% loss).</span>
                        </div>
                    </label>
                    <input type="number" id="divergence_loss" value="0.02" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Two-Phase Loss Factor
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Performance reduction due to solid particles (alumina) in exhaust gas. Particles have lower expansion efficiency than gas. Typical values: 0.96-0.99.</span>
                        </div>
                    </label>
                    <input type="number" id="two_phase_loss" value="0.98" step="0.001">
                </div>
            </div>
            <p style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                Burn rate: r = a × P<sup>n</sup> where P is pressure in bar
            </p>
        </div>

        <!-- 6. Initial & Environmental Conditions -->
        <div class="panel">
            <h2>6. Initial & Environmental Conditions</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Ignition Delay <span class="unit">(ms)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Delay time from ignition signal to significant pressure rise. Includes igniter response time and flame propagation. Typical values: 20-100 ms.</span>
                        </div>
                    </label>
                    <input type="number" id="ignition_delay" value="50" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Atmospheric Pressure <span class="unit">(kPa)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Ambient pressure at test/flight conditions. Sea level: 101.325 kPa. Lower pressure at altitude increases nozzle performance but reduces air-breathing stage performance.</span>
                        </div>
                    </label>
                    <input type="number" id="atm_pressure" value="101.325" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Test Altitude <span class="unit">(m)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Altitude above sea level for test or flight conditions. Affects atmospheric pressure and nozzle performance. 0 = sea level conditions.</span>
                        </div>
                    </label>
                    <input type="number" id="test_altitude" value="0" step="1">
                </div>
                <div class="form-group">
                    <label>
                        Ambient Temperature <span class="unit">(K)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Environmental temperature affecting propellant burn rate and motor performance. Standard conditions: 298K (25°C). Cold weather reduces performance.</span>
                        </div>
                    </label>
                    <input type="number" id="ambient_temp" value="298" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Humidity <span class="unit">(%)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Relative humidity of ambient air. Affects propellant performance and can cause moisture absorption during storage. High humidity may reduce performance.</span>
                        </div>
                    </label>
                    <input type="number" id="humidity" value="60" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Wind Speed <span class="unit">(m/s)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Environmental wind speed for flight trajectory calculations. Affects rocket stability and trajectory but not motor performance. Used for launch safety analysis.</span>
                        </div>
                    </label>
                    <input type="number" id="wind_speed" value="0" step="0.1">
                </div>
            </div>
        </div>

        <!-- 7. Mass & Weight Breakdown -->
        <div class="panel">
            <h2>7. Mass & Weight Breakdown</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Propellant Mass <span class="unit">(kg)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Total mass of solid propellant. Automatically calculated from grain geometry and propellant density. Critical for performance calculations and thrust-to-weight ratio.</span>
                        </div>
                    </label>
                    <input type="number" id="propellant_mass" step="0.001" readonly>
                    <button type="button" onclick="calculatePropellantMass()" style="margin-top: 5px; padding: 5px 10px; font-size: 12px;">Calculate</button>
                </div>
                <div class="form-group">
                    <label>
                        Case Mass <span class="unit">(kg)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Mass of motor casing including forward and aft closures. Depends on material, pressure rating, and safety factor. Major component of dry mass.</span>
                        </div>
                    </label>
                    <input type="number" id="case_mass" value="2.5" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Nozzle Mass <span class="unit">(kg)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Mass of nozzle assembly including throat insert, exit cone, and mounting hardware. Varies with nozzle material and size.</span>
                        </div>
                    </label>
                    <input type="number" id="nozzle_mass" value="0.5" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Insulation Mass <span class="unit">(kg)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Mass of thermal insulation materials including liner, inhibitor coatings, and heat barriers. Protects case from high temperatures.</span>
                        </div>
                    </label>
                    <input type="number" id="insulation_mass" value="0.3" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Avionics Mass <span class="unit">(kg)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Mass of electronic systems including flight computer, sensors, telemetry, and recovery systems. Not part of motor but affects overall vehicle performance.</span>
                        </div>
                    </label>
                    <input type="number" id="avionics_mass" value="0.2" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Closure Mass <span class="unit">(kg)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Combined mass of forward and aft closures, bulkheads, and sealing components. Includes igniter and nozzle mounting provisions.</span>
                        </div>
                    </label>
                    <input type="number" id="closure_mass" value="0.8" step="0.001">
                </div>
                <div class="form-group">
                    <label>
                        Total Dry Mass <span class="unit">(kg)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Total mass excluding propellant (case + nozzle + insulation + avionics + closures). Represents final vehicle mass after propellant burnout.</span>
                        </div>
                    </label>
                    <input type="number" id="dry_mass" step="0.001" readonly>
                </div>
                <div class="form-group">
                    <label>
                        Total Wet Mass <span class="unit">(kg)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Total loaded mass including all propellant (dry mass + propellant mass). Initial vehicle mass at ignition. Used for thrust-to-weight calculations.</span>
                        </div>
                    </label>
                    <input type="number" id="wet_mass" step="0.001" readonly>
                </div>
            </div>
        </div>

        <!-- 8. Measurement / Test Equipment -->
        <div class="panel">
            <h2>8. Measurement / Test Equipment</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        Pressure Sensor Range <span class="unit">(MPa)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Maximum pressure measurement range of pressure transducer. Should be 1.5-2x expected maximum pressure for accuracy and safety. Typical range: 5-15 MPa for amateur motors.</span>
                        </div>
                    </label>
                    <input type="number" id="pressure_sensor_range" value="10" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Sampling Frequency <span class="unit">(Hz)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Data acquisition sampling rate. Higher rates capture more detail but generate larger data files. 500-2000 Hz typical for motor testing. Must be >2x highest frequency of interest.</span>
                        </div>
                    </label>
                    <input type="number" id="sampling_freq" value="1000" step="1">
                </div>
                <div class="form-group">
                    <label>
                        Load Cell Capacity <span class="unit">(N)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Maximum thrust measurement capacity of load cell. Should be 1.5-2x expected maximum thrust for accuracy. Includes safety margin for unexpected over-pressure events.</span>
                        </div>
                    </label>
                    <input type="number" id="load_cell_capacity" value="5000" step="1">
                </div>
                <div class="form-group">
                    <label>
                        Calibration Factor
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Sensor calibration coefficient to convert raw readings to engineering units. Determined through calibration with known weights/pressures. Should be verified before each test.</span>
                        </div>
                    </label>
                    <input type="number" id="calibration_factor" value="1.0" step="0.0001">
                </div>
                <div class="form-group">
                    <label>
                        Data Collection Time <span class="unit">(s)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Total recording duration including pre-ignition baseline and post-burnout data. Should be longer than expected burn time to capture complete motor operation.</span>
                        </div>
                    </label>
                    <input type="number" id="data_collection_time" value="10" step="0.1">
                </div>
                <div class="form-group">
                    <label>
                        Filter Cutoff Frequency <span class="unit">(Hz)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Low-pass filter cutoff frequency for noise reduction. Should be high enough to preserve real data but low enough to remove noise. Typically 50-200 Hz for motor testing.</span>
                        </div>
                    </label>
                    <input type="number" id="filter_cutoff" value="100" step="1">
                </div>
                <div class="form-group">
                    <label>
                        Uncertainty Level <span class="unit">(%)</span>
                        <div class="tooltip">
                            <div class="tooltip-icon">?</div>
                            <span class="tooltip-text">Overall measurement uncertainty for Monte Carlo analysis. Includes sensor accuracy, calibration uncertainty, and environmental effects. Typical values: 1-5% for professional setups.</span>
                        </div>
                    </label>
                    <input type="number" id="uncertainty_level" value="2" step="0.1">
                </div>
            </div>
        </div>
        
        <!-- Calculate Button -->
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn btn-primary" onclick="calculateSolid()">Calculate Motor Performance</button>
            <button class="btn" onclick="runMonteCarloAnalysis()" style="background: linear-gradient(135deg, #e67e22, #d35400); color: white; margin-left: 10px;">Monte Carlo Analysis</button>
            <button class="btn btn-secondary" onclick="resetForm()">Reset</button>
        </div>
        
        <!-- Loading indicator -->
        <div id="loading" class="loading">
            <div style="font-size: 24px; color: #007bff;">Calculating...</div>
        </div>
        
        <!-- Results Section -->
        <div id="results" class="results">
            <!-- AI Analysis Button -->
            <div style="text-align: center; margin: 20px 0;">
                <button type="button" class="btn btn-ai" onclick="askAI()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 12px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
                    Ask AI to Analyze Results
                </button>
            </div>
            
            <!-- PDF Export Buttons -->
            <div style="text-align: center; margin: 20px 0; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button type="button" class="btn btn-pdf" onclick="exportPDF('summary')" style="background: linear-gradient(135deg, #ff7b7b 0%, #ff416c 100%); color: white; padding: 10px 25px; border: none; border-radius: 5px; font-size: 14px; cursor: pointer;">
                    PDF Summary Report
                </button>
                <button type="button" class="btn btn-pdf" onclick="exportPDF('technical')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 25px; border: none; border-radius: 5px; font-size: 14px; cursor: pointer;">
                    PDF Technical Report
                </button>
                <button type="button" class="btn btn-pdf" onclick="exportPDF('complete')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 10px 25px; border: none; border-radius: 5px; font-size: 14px; cursor: pointer;">
                    PDF Complete Report
                </button>
            </div>
            
            <!-- Performance Metrics -->
            <div class="panel">
                <h2>Performance Summary</h2>
                <div id="performanceMetrics"></div>
            </div>
            
            <!-- Thrust Curve -->
            <div class="panel">
                <h2>Thrust Curve</h2>
                <div class="chart-explanation">
                    <p><strong>What this shows:</strong> Thrust vs time profile for solid rocket motor burn</p>
                    <ul>
                        <li><strong>X-axis:</strong> Time (s) from ignition to burnout</li>
                        <li><strong>Y-axis:</strong> Thrust (N) - force generated by motor</li>
                        <li><strong>Curve shape:</strong> Depends on grain geometry (progressive, regressive, neutral)</li>
                        <li><strong>Peak thrust:</strong> Maximum force point (design critical point)</li>
                        <li><strong>Total impulse:</strong> Area under curve represents total energy delivery</li>
                        <li><strong>Burn profile:</strong> BATES (neutral), Star (progressive), End-burner (regressive)</li>
                    </ul>
                </div>
                <div id="thrust_plot" class="plot-container"></div>
            </div>
            
            <!-- Pressure Curve -->
            <div class="panel">
                <h2>Chamber Pressure</h2>
                <div class="chart-explanation">
                    <p><strong>What this shows:</strong> Chamber pressure evolution during motor burn</p>
                    <ul>
                        <li><strong>X-axis:</strong> Time (s) from ignition to burnout</li>
                        <li><strong>Y-axis:</strong> Pressure (bar) inside combustion chamber</li>
                        <li><strong>Pressure profile:</strong> Directly related to thrust curve and burn area</li>
                        <li><strong>Design pressure:</strong> Maximum operating pressure for safety analysis</li>
                        <li><strong>Pressure ratio:</strong> Chamber to ambient pressure ratio</li>
                        <li><strong>Critical points:</strong> Ignition transient, steady-state, tail-off regions</li>
                    </ul>
                </div>
                <div id="pressure_plot" class="plot-container"></div>
            </div>
            
            <!-- CAD Visualization -->
            <div class="panel">
                <h2>3D CAD Design</h2>
                <div class="chart-explanation">
                    <p><strong>What this shows:</strong> Interactive 3D CAD model of solid rocket motor assembly</p>
                    <ul>
                        <li><strong>Gray components:</strong> Motor case, nozzle hardware, and structural elements</li>
                        <li><strong>Orange/Red:</strong> Solid propellant grain with internal port geometry</li>
                        <li><strong>Blue gradient:</strong> Nozzle throat and expansion section</li>
                        <li><strong>Grain geometry:</strong> BATES, Star, Wagon Wheel, or End-burner configuration</li>
                        <li><strong>Interactive controls:</strong> Rotate (drag), zoom (scroll), pan (shift+drag)</li>
                        <li><strong>Export formats:</strong> STEP/STL files for manufacturing and CAD software</li>
                    </ul>
                </div>
                <div style="text-align: center; margin-bottom: 15px;">
                    <button class="btn" onclick="exportMotorCAD()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin: 5px;">
                        📐 Motor CAD Export
                    </button>
                    <button class="btn" onclick="show3DVisualization()" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; margin: 5px;">
                        🎯 3D Visualization
                    </button>
                </div>
                <div id="cad_visualization" class="plot-container"></div>
            </div>
            
            <!-- Design Report -->
            <div class="panel">
                <h2>Motor Specifications</h2>
                <div id="designReport"></div>
            </div>
        </div>
    </div>
    
    <script>
        let currentResults = null;
        
        // UI Feedback Functions
        function showMessage(message, type = 'info') {
            const alertClass = type === 'error' ? 'alert-danger' : 
                             type === 'success' ? 'alert-success' : 
                             type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="close" onclick="this.parentElement.remove()">
                    <span>&times;</span>
                </button>
            `;
            
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        function showError(message) {
            showMessage(message, 'error');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        function showWarning(message) {
            showMessage(message, 'warning');
        }
        
        function showInfo(message) {
            showMessage(message, 'info');
        }
        
        function showLoading(show) {
            const existingLoader = document.getElementById('loading-overlay');
            if (show) {
                if (!existingLoader) {
                    const loader = document.createElement('div');
                    loader.id = 'loading-overlay';
                    loader.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9998;';
                    loader.innerHTML = '<div class="spinner-border text-light" role="status"><span class="sr-only">Loading...</span></div>';
                    document.body.appendChild(loader);
                }
            } else {
                if (existingLoader) {
                    existingLoader.remove();
                }
            }
        }
        
        // Comprehensive calculation functions
        function calculateCharVelocity() {
            const tc = parseFloat(document.getElementById('flame_temp').value) || 3200;
            const gamma = parseFloat(document.getElementById('gamma').value) || 1.25;
            const M = parseFloat(document.getElementById('molecular_weight').value) || 28.5;
            
            // c* = sqrt(gamma * R * Tc / M) / (gamma * ((gamma + 1) / 2)^((gamma + 1) / (2 * (gamma - 1))))
            const R = 8314.4621; // J/(kmol·K)
            const numerator = Math.sqrt(gamma * R * tc / M);
            const exponent = (gamma + 1) / (2 * (gamma - 1));
            const denominator = gamma * Math.pow((gamma + 1) / 2, exponent);
            
            const cStar = numerator / denominator;
            document.getElementById('char_velocity').value = cStar.toFixed(1);
        }

        function calculatePropellantMass() {
            const density = parseFloat(document.getElementById('density').value) || 1850;
            const outerDiameter = parseFloat(document.getElementById('outer_diameter').value) || 100;
            const coreDiameter = parseFloat(document.getElementById('core_diameter').value) || 30;
            const grainLength = parseFloat(document.getElementById('grain_length').value) || 500;
            const grainCount = parseFloat(document.getElementById('grain_count').value) || 3;
            const grainType = document.getElementById('grain_type').value;
            
            // Convert to meters
            const Do = outerDiameter / 1000;
            const Di = coreDiameter / 1000;
            const L = grainLength / 1000;
            
            let grainVolume = 0;
            
            switch(grainType) {
                case 'bates':
                    grainVolume = Math.PI * (Math.pow(Do/2, 2) - Math.pow(Di/2, 2)) * L;
                    break;
                    
                case 'star':
                    const starPoints = parseFloat(document.getElementById('star_points').value) || 6;
                    const starRadius = parseFloat(document.getElementById('star_radius').value) || 15;
                    const Rs = (starRadius / 1000) / 2;
                    
                    const starArea = Math.PI * (Math.pow(Do/2, 2) - Math.pow(Di/2, 2)) + 
                                    starPoints * 0.5 * Rs * Rs * Math.sin(2 * Math.PI / starPoints);
                    grainVolume = starArea * L;
                    break;
                    
                case 'finocyl':
                    const finCount = parseFloat(document.getElementById('fin_count').value) || 4;
                    const finWidth = (parseFloat(document.getElementById('fin_width').value) || 8) / 1000;
                    const finLength = (parseFloat(document.getElementById('fin_length').value) || 20) / 1000;
                    
                    const baseVolume = Math.PI * (Math.pow(Do/2, 2) - Math.pow(Di/2, 2)) * L;
                    const finVolume = finCount * finWidth * finLength * L;
                    grainVolume = baseVolume + finVolume;
                    break;
                    
                case 'slotted':
                    grainVolume = Math.PI * (Math.pow(Do/2, 2) - Math.pow(Di/2, 2)) * L * 1.2;
                    break;
                    
                default:
                    grainVolume = Math.PI * (Math.pow(Do/2, 2) - Math.pow(Di/2, 2)) * L;
            }
            
            const totalVolume = grainVolume * grainCount;
            const propellantMass = totalVolume * density;
            
            document.getElementById('propellant_mass').value = propellantMass.toFixed(3);
            updateTotalMasses();
        }

        function updateTotalMasses() {
            const propellantMass = parseFloat(document.getElementById('propellant_mass').value) || 0;
            const caseMass = parseFloat(document.getElementById('case_mass').value) || 0;
            const nozzleMass = parseFloat(document.getElementById('nozzle_mass').value) || 0;
            const insulationMass = parseFloat(document.getElementById('insulation_mass').value) || 0;
            const avionicsMass = parseFloat(document.getElementById('avionics_mass').value) || 0;
            const closureMass = parseFloat(document.getElementById('closure_mass').value) || 0;
            
            const dryMass = caseMass + nozzleMass + insulationMass + avionicsMass + closureMass;
            const wetMass = dryMass + propellantMass;
            
            document.getElementById('dry_mass').value = dryMass.toFixed(3);
            document.getElementById('wet_mass').value = wetMass.toFixed(3);
        }

        function updateExpansionRatio() {
            const throatDiameter = parseFloat(document.getElementById('throat_diameter').value) || 15;
            const exitDiameter = parseFloat(document.getElementById('exit_diameter').value) || 35;
            
            if (throatDiameter > 0 && exitDiameter > 0) {
                const expansionRatio = Math.pow(exitDiameter / throatDiameter, 2);
                document.getElementById('expansion_ratio').value = expansionRatio.toFixed(2);
            }
        }

        function updateGrainPreview() {
            const grainType = document.getElementById('grain_type').value;
            const preview = document.getElementById('grain_preview');
            
            // Show/hide configuration sections
            document.getElementById('star_config').style.display = (grainType === 'star') ? 'block' : 'none';
            document.getElementById('finocyl_config').style.display = (grainType === 'finocyl') ? 'block' : 'none';
            
            const svgs = {
                'bates': `<svg width="180" height="180" viewBox="0 0 180 180">
                    <circle cx="90" cy="90" r="80" fill="#e9ecef" stroke="#495057" stroke-width="2"/>
                    <circle cx="90" cy="90" r="25" fill="white" stroke="#495057" stroke-width="2"/>
                    <text x="90" y="160" text-anchor="middle" font-size="12" fill="#495057">BATES</text>
                </svg>`,
                'star': `<svg width="180" height="180" viewBox="0 0 180 180">
                    <circle cx="90" cy="90" r="80" fill="#e9ecef" stroke="#495057" stroke-width="2"/>
                    <path d="M90,30 l15,45 h40 l-30,25 l10,40 l-35,-25 l-35,25 l10,-40 l-30,-25 h40 z" 
                          fill="white" stroke="#495057" stroke-width="2"/>
                    <text x="90" y="160" text-anchor="middle" font-size="12" fill="#495057">Star</text>
                </svg>`,
                'finocyl': `<svg width="180" height="180" viewBox="0 0 180 180">
                    <circle cx="90" cy="90" r="80" fill="#e9ecef" stroke="#495057" stroke-width="2"/>
                    <circle cx="90" cy="90" r="25" fill="white" stroke="#495057" stroke-width="2"/>
                    <rect x="70" y="25" width="8" height="40" fill="white" stroke="#495057" stroke-width="1"/>
                    <rect x="102" y="25" width="8" height="40" fill="white" stroke="#495057" stroke-width="1"/>
                    <rect x="70" y="115" width="8" height="40" fill="white" stroke="#495057" stroke-width="1"/>
                    <rect x="102" y="115" width="8" height="40" fill="white" stroke="#495057" stroke-width="1"/>
                    <text x="90" y="160" text-anchor="middle" font-size="12" fill="#495057">Finocyl</text>
                </svg>`,
                'slotted': `<svg width="180" height="180" viewBox="0 0 180 180">
                    <circle cx="90" cy="90" r="80" fill="#e9ecef" stroke="#495057" stroke-width="2"/>
                    <circle cx="90" cy="90" r="25" fill="white" stroke="#495057" stroke-width="2"/>
                    <rect x="85" y="10" width="10" height="30" fill="white" stroke="#495057" stroke-width="1"/>
                    <rect x="85" y="140" width="10" height="30" fill="white" stroke="#495057" stroke-width="1"/>
                    <text x="90" y="160" text-anchor="middle" font-size="12" fill="#495057">Slotted</text>
                </svg>`,
                'wagon_wheel': `<svg width="180" height="180" viewBox="0 0 180 180">
                    <circle cx="90" cy="90" r="80" fill="#e9ecef" stroke="#495057" stroke-width="2"/>
                    <circle cx="90" cy="90" r="15" fill="white" stroke="#495057" stroke-width="2"/>
                    <circle cx="90" cy="50" r="10" fill="white" stroke="#495057" stroke-width="2"/>
                    <circle cx="120" cy="70" r="10" fill="white" stroke="#495057" stroke-width="2"/>
                    <circle cx="120" cy="110" r="10" fill="white" stroke="#495057" stroke-width="2"/>
                    <circle cx="90" cy="130" r="10" fill="white" stroke="#495057" stroke-width="2"/>
                    <circle cx="60" cy="110" r="10" fill="white" stroke="#495057" stroke-width="2"/>
                    <circle cx="60" cy="70" r="10" fill="white" stroke="#495057" stroke-width="2"/>
                    <text x="90" y="160" text-anchor="middle" font-size="12" fill="#495057">Wagon Wheel</text>
                </svg>`,
                'end_burner': `<svg width="180" height="180" viewBox="0 0 180 180">
                    <circle cx="90" cy="90" r="80" fill="#e9ecef" stroke="#495057" stroke-width="2"/>
                    <line x1="90" y1="10" x2="90" y2="90" stroke="#f093fb" stroke-width="4"/>
                    <text x="90" y="160" text-anchor="middle" font-size="12" fill="#495057">End Burner</text>
                </svg>`
            };
            
            preview.innerHTML = svgs[grainType] || svgs['bates'];
        }

        // Monte Carlo Analysis
        async function runMonteCarloAnalysis() {
            const btn = document.querySelector('button[onclick="runMonteCarloAnalysis()"]');
            const originalText = btn.innerHTML;
            
            try {
                btn.innerHTML = '<div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #d35400; border-radius: 50%; animation: spin 1s linear infinite;"></div> Monte Carlo Analysis...';
                
                // Collect comprehensive parameters
                const data = collectAllParameters();
                data.analysis_type = 'monte_carlo';
                data.monte_carlo_runs = 10000;
                
                const response = await fetch('/calculate_solid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const results = await response.json();
                
                if (results.error) {
                    throw new Error(results.error);
                }
                
                displayMonteCarloResults(results);
                
            } catch (error) {
                showError('Monte Carlo Analysis Error: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
            }
        }

        function collectAllParameters() {
            return {
                // Propellant properties
                propellant_name: document.getElementById('propellant_name').value,
                density: parseFloat(document.getElementById('density').value) || 1850,
                heat_value: parseFloat(document.getElementById('heat_value').value) || 2500,
                flame_temp: parseFloat(document.getElementById('flame_temp').value) || 3200,
                molecular_weight: parseFloat(document.getElementById('molecular_weight').value) || 28.5,
                gamma: parseFloat(document.getElementById('gamma').value) || 1.25,
                char_velocity: parseFloat(document.getElementById('char_velocity').value) || 1550,
                erosive_k: parseFloat(document.getElementById('erosive_k').value) || 0.0002,
                erosive_m: parseFloat(document.getElementById('erosive_m').value) || 0.8,
                temp_coeff: parseFloat(document.getElementById('temp_coeff').value) || 0.002,
                
                // Grain geometry
                grain_count: parseFloat(document.getElementById('grain_count').value) || 3,
                web_thickness: parseFloat(document.getElementById('web_thickness').value) || 25,
                grain_type: document.getElementById('grain_type').value,
                outer_diameter: parseFloat(document.getElementById('outer_diameter').value) || 100,
                core_diameter: parseFloat(document.getElementById('core_diameter').value) || 30,
                grain_length: parseFloat(document.getElementById('grain_length').value) || 500,
                grain_gap: parseFloat(document.getElementById('grain_gap').value) || 2,
                insulation_thickness: parseFloat(document.getElementById('insulation_thickness').value) || 3,
                
                // Star configuration
                star_points: parseFloat(document.getElementById('star_points').value) || 6,
                star_radius: parseFloat(document.getElementById('star_radius').value) || 15,
                star_fillet: parseFloat(document.getElementById('star_fillet').value) || 2,
                
                // Finocyl configuration
                fin_count: parseFloat(document.getElementById('fin_count').value) || 4,
                fin_width: parseFloat(document.getElementById('fin_width').value) || 8,
                fin_length: parseFloat(document.getElementById('fin_length').value) || 20,
                
                // Inhibitor settings
                inhibit_front: document.getElementById('inhibit_front').checked,
                inhibit_rear: document.getElementById('inhibit_rear').checked,
                inhibit_outer: document.getElementById('inhibit_outer').checked,
                
                // Chamber properties
                chamber_diameter: parseFloat(document.getElementById('chamber_diameter').value) || 100,
                chamber_volume: parseFloat(document.getElementById('chamber_volume').value) || 2.5,
                case_material: document.getElementById('case_material').value,
                yield_strength: parseFloat(document.getElementById('yield_strength').value) || 250,
                safety_factor: parseFloat(document.getElementById('safety_factor').value) || 2.5,
                liner_thickness: parseFloat(document.getElementById('liner_thickness').value) || 2,
                liner_density: parseFloat(document.getElementById('liner_density').value) || 1200,
                initial_temp: parseFloat(document.getElementById('initial_temp').value) || 298,
                case_thickness: parseFloat(document.getElementById('case_thickness').value) || 8,
                
                // Nozzle properties
                throat_diameter: parseFloat(document.getElementById('throat_diameter').value) || 15,
                exit_diameter: parseFloat(document.getElementById('exit_diameter').value) || 35,
                expansion_ratio: parseFloat(document.getElementById('expansion_ratio').value) || 5.44,
                convergent_angle: parseFloat(document.getElementById('convergent_angle').value) || 45,
                divergent_angle: parseFloat(document.getElementById('divergent_angle').value) || 15,
                nozzle_efficiency: parseFloat(document.getElementById('nozzle_efficiency').value) || 0.95,
                erosion_factor: parseFloat(document.getElementById('erosion_factor').value) || 0.001,
                nozzle_material: document.getElementById('nozzle_material').value,
                chamber_pressure: parseFloat(document.getElementById('chamber_pressure').value) || 40,
                
                // Burn rate parameters
                burn_rate_a: parseFloat(document.getElementById('burn_rate_a').value) || 0.005,
                burn_rate_n: parseFloat(document.getElementById('burn_rate_n').value) || 0.35,
                
                // Efficiency factors
                combustion_efficiency: parseFloat(document.getElementById('combustion_efficiency').value) || 0.95,
                cf_efficiency: parseFloat(document.getElementById('cf_efficiency').value) || 0.98,
                overall_efficiency: parseFloat(document.getElementById('overall_efficiency').value) || 0.92,
                discharge_coeff: parseFloat(document.getElementById('discharge_coeff').value) || 0.98,
                kinetic_efficiency: parseFloat(document.getElementById('kinetic_efficiency').value) || 0.97,
                divergence_loss: parseFloat(document.getElementById('divergence_loss').value) || 0.02,
                two_phase_loss: parseFloat(document.getElementById('two_phase_loss').value) || 0.98,
                
                // Environmental conditions
                ignition_delay: parseFloat(document.getElementById('ignition_delay').value) || 50,
                atm_pressure: parseFloat(document.getElementById('atm_pressure').value) || 101.325,
                test_altitude: parseFloat(document.getElementById('test_altitude').value) || 0,
                ambient_temp: parseFloat(document.getElementById('ambient_temp').value) || 298,
                humidity: parseFloat(document.getElementById('humidity').value) || 60,
                wind_speed: parseFloat(document.getElementById('wind_speed').value) || 0,
                
                // Mass breakdown
                propellant_mass: parseFloat(document.getElementById('propellant_mass').value) || 0,
                case_mass: parseFloat(document.getElementById('case_mass').value) || 2.5,
                nozzle_mass: parseFloat(document.getElementById('nozzle_mass').value) || 0.5,
                insulation_mass: parseFloat(document.getElementById('insulation_mass').value) || 0.3,
                avionics_mass: parseFloat(document.getElementById('avionics_mass').value) || 0.2,
                closure_mass: parseFloat(document.getElementById('closure_mass').value) || 0.8,
                dry_mass: parseFloat(document.getElementById('dry_mass').value) || 0,
                wet_mass: parseFloat(document.getElementById('wet_mass').value) || 0,
                
                // Measurement parameters
                pressure_sensor_range: parseFloat(document.getElementById('pressure_sensor_range').value) || 10,
                sampling_freq: parseFloat(document.getElementById('sampling_freq').value) || 1000,
                load_cell_capacity: parseFloat(document.getElementById('load_cell_capacity').value) || 5000,
                calibration_factor: parseFloat(document.getElementById('calibration_factor').value) || 1.0,
                data_collection_time: parseFloat(document.getElementById('data_collection_time').value) || 10,
                filter_cutoff: parseFloat(document.getElementById('filter_cutoff').value) || 100,
                uncertainty_level: parseFloat(document.getElementById('uncertainty_level').value) || 2
            };
        }
        
        async function calculateSolid() {
            const data = collectAllParameters();
            
            showLoading(true);
            
            try {
                const response = await fetch('/calculate_solid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const results = await response.json();
                
                if (results.error) {
                    throw new Error(results.error);
                }
                
                currentResults = results;
                displayResults(results);
                
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function displayResults(results) {
            document.getElementById('results').style.display = 'block';
            
            // Performance metrics with comprehensive display
            const metricsDiv = document.getElementById('performanceMetrics');
            const metrics = [
                { label: 'Deniz Seviyesi Isp', value: results.isp_sea_level.toFixed(1), unit: 's', color: '#f093fb' },
                { label: 'Vakum Isp', value: results.isp_vacuum.toFixed(1), unit: 's', color: '#667eea' },
                { label: 'Ortalama Thrust', value: results.average_thrust.toFixed(0), unit: 'N', color: '#4facfe' },
                { label: 'Yanma Süresi', value: results.burn_time.toFixed(2), unit: 's', color: '#f5576c' },
                { label: 'Toplam İtki', value: (results.total_impulse / 1000).toFixed(1), unit: 'kN·s', color: '#ff6b6b' },
                { label: 'C* Verimlilik', value: (results.detailed_analysis?.performance_metrics?.c_star_efficiency_percent || 96).toFixed(1), unit: '%', color: '#4ecdc4' },
                { label: 'Thrust Katsayısı', value: (results.detailed_analysis?.performance_metrics?.average_thrust_coefficient || 1.65).toFixed(2), unit: '', color: '#45b7d1' },
                { label: 'Yanıcı Kütlesi', value: results.propellant_mass.toFixed(2), unit: 'kg', color: '#96ceb4' }
            ];
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">';
            metrics.forEach(metric => {
                html += `
                    <div class="metric-card" style="background: ${metric.color};">
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                        <div class="metric-unit">${metric.unit}</div>
                    </div>
                `;
            });
            html += '</div>';
            metricsDiv.innerHTML = html;
            
            // Thrust curve
            const thrustTrace = {
                x: results.thrust_curve.time,
                y: results.thrust_curve.thrust,
                type: 'scatter',
                mode: 'lines',
                name: 'Thrust',
                line: { color: '#f093fb', width: 3 }
            };
            
            const thrustLayout = {
                title: 'Thrust vs Time',
                xaxis: { title: 'Time (s)' },
                yaxis: { title: 'Thrust (N)' },
                showlegend: false
            };
            
            Plotly.newPlot('thrust_plot', [thrustTrace], thrustLayout);
            
            // Pressure curve
            const pressureTrace = {
                x: results.thrust_curve.time,
                y: results.thrust_curve.pressure,
                type: 'scatter',
                mode: 'lines',
                name: 'Pressure',
                line: { color: '#667eea', width: 3 }
            };
            
            const pressureLayout = {
                title: 'Chamber Pressure vs Time',
                xaxis: { title: 'Time (s)' },
                yaxis: { title: 'Pressure (bar)' },
                showlegend: false
            };
            
            Plotly.newPlot('pressure_plot', [pressureTrace], pressureLayout);
            
            // Altitude Performance Plot
            if (results.altitude_performance && results.altitude_performance.length > 0) {
                const altitudeTrace = {
                    x: results.altitude_performance.map(p => p.altitude / 1000), // Convert to km
                    y: results.altitude_performance.map(p => p.specific_impulse),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Isp vs Altitude',
                    line: { color: '#4facfe', width: 3 },
                    marker: { size: 6 }
                };
                
                const altitudeLayout = {
                    title: 'Specific Impulse vs Altitude',
                    xaxis: { title: 'Altitude (km)' },
                    yaxis: { title: 'Specific Impulse (s)' },
                    showlegend: false
                };
                
                // Create altitude plot container if it doesn't exist
                if (!document.getElementById('altitude_plot')) {
                    const altitudePlotDiv = document.createElement('div');
                    altitudePlotDiv.id = 'altitude_plot';
                    altitudePlotDiv.className = 'plot-container';
                    
                    const altitudePanel = document.createElement('div');
                    altitudePanel.className = 'panel';
                    altitudePanel.innerHTML = '<h2>Altitude Performance</h2>';
                    altitudePanel.appendChild(altitudePlotDiv);
                    
                    document.getElementById('pressure_plot').parentNode.parentNode.insertAdjacentElement('afterend', altitudePanel);
                }
                
                Plotly.newPlot('altitude_plot', [altitudeTrace], altitudeLayout);
            }
            
            // Comprehensive analysis tabs like hybrid/liquid systems
            displayComprehensiveAnalysis(results);
        }
        
        function displayComprehensiveAnalysis(results) {
            // Create comprehensive analysis section
            const reportDiv = document.getElementById('designReport');
            
            reportDiv.innerHTML = `
                <div class="tabs-container">
                    <div class="tabs-header" style="display: flex; background: #f8f9fa; border-radius: 8px 8px 0 0; margin-bottom: 0;">
                        <button class="tab-button active" onclick="showTab('specifications')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: 600;">Spesifikasyonlar</button>
                        <button class="tab-button" onclick="showTab('performance')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer;">Performans Analizi</button>
                        <button class="tab-button" onclick="showTab('structural')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer;">Yapısal Analiz</button>
                        <button class="tab-button" onclick="showTab('thermal')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer;">Termal Analiz</button>
                        <button class="tab-button" onclick="showTab('manufacturing')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer;">Üretim Analizi</button>
                        <button class="tab-button" onclick="showTab('safety')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer;">Güvenlik Analizi</button>
                        <button class="tab-button" onclick="showTab('costs')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer;">Maliyet Analizi</button>
                        <button class="tab-button" onclick="showTab('cad')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer;">CAD Tasarım</button>
                    </div>
                    
                    <div class="tab-content" style="background: white; border: 1px solid #e9ecef; border-top: none; border-radius: 0 0 8px 8px; padding: 20px;">
                        
                        <!-- Specifications Tab -->
                        <div id="tab-specifications" class="tab-panel">
                            <h3 style="color: #1e3c72; margin-bottom: 15px;">Motor Spesifikasyonları</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h4 style="color: #495057; margin-bottom: 10px;">Temel Parametreler</h4>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yanıcı Tipi:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.propellant_name}</td></tr>
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Grain Tipi:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.grain_type.toUpperCase()}</td></tr>
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Oda Çapı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.chamber_diameter.toFixed(1)} mm</td></tr>
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Grain Uzunluğu:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.grain_length.toFixed(1)} mm</td></tr>
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Çekirdek Çapı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.core_diameter.toFixed(1)} mm</td></tr>
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yanıcı Kütlesi:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.propellant_mass.toFixed(3)} kg</td></tr>
                                    </table>
                                </div>
                                <div>
                                    <h4 style="color: #495057; margin-bottom: 10px;">Nozzle Parametreleri</h4>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Boğaz Çapı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.throat_diameter.toFixed(1)} mm</td></tr>
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Çıkış Çapı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.exit_diameter.toFixed(1)} mm</td></tr>
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Genişleme Oranı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.expansion_ratio.toFixed(1)}</td></tr>
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Vakum Genişleme:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.expansion_ratio_vacuum.toFixed(1)}</td></tr>
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>C* Hızı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.c_star.toFixed(0)} m/s</td></tr>
                                        <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Oda Basıncı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${results.chamber_pressure.toFixed(1)} bar</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Analysis Tab -->
                        <div id="tab-performance" class="tab-panel" style="display: none;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px;">Detaylı Performans Analizi</h3>
                            ${generatePerformanceAnalysisHTML(results)}
                        </div>
                        
                        <!-- Structural Analysis Tab -->
                        <div id="tab-structural" class="tab-panel" style="display: none;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px;">Yapısal Analiz</h3>
                            ${generateStructuralAnalysisHTML(results)}
                        </div>
                        
                        <!-- Thermal Analysis Tab -->
                        <div id="tab-thermal" class="tab-panel" style="display: none;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px;">Termal Analiz</h3>
                            ${generateThermalAnalysisHTML(results)}
                        </div>
                        
                        <!-- Manufacturing Analysis Tab -->
                        <div id="tab-manufacturing" class="tab-panel" style="display: none;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px;">Üretim Analizi</h3>
                            ${generateManufacturingAnalysisHTML(results)}
                        </div>
                        
                        <!-- Safety Analysis Tab -->
                        <div id="tab-safety" class="tab-panel" style="display: none;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px;">Güvenlik Analizi</h3>
                            ${generateSafetyAnalysisHTML(results)}
                        </div>
                        
                        <!-- Cost Analysis Tab -->
                        <div id="tab-costs" class="tab-panel" style="display: none;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px;">Maliyet Analizi</h3>
                            ${generateCostAnalysisHTML(results)}
                        </div>
                        
                        <!-- CAD Design Tab -->
                        <div id="tab-cad" class="tab-panel" style="display: none;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px;">CAD Tasarım ve Üretim Dosyaları</h3>
                            ${generateCADAnalysisHTML(results)}
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function resetForm() {
            document.getElementById('grain_type').value = 'bates';
            document.getElementById('propellant_type').value = 'apcp';
            document.getElementById('chamber_diameter').value = '100';
            document.getElementById('grain_length').value = '500';
            document.getElementById('core_diameter').value = '30';
            document.getElementById('chamber_pressure').value = '40';
            document.getElementById('burn_rate_a').value = '0.005';
            document.getElementById('burn_rate_n').value = '0.35';
            document.getElementById('results').style.display = 'none';
            updateGrainPreview();
        }
        
        // Ask AI Analysis
        function askAI() {
            if (!currentResults) {
                showWarning('No results to analyze. Please run calculations first.');
                return;
            }
            
            // Prepare AI-friendly JSON for solid motor
            const aiData = {
                analysis_type: "Solid Rocket Motor Design",
                timestamp: new Date().toISOString(),
                
                input_parameters: {
                    grain_type: currentResults.grain_type,
                    propellant_type: currentResults.propellant_type,
                    propellant_name: currentResults.propellant_name,
                    chamber_diameter_mm: currentResults.chamber_diameter,
                    grain_length_mm: currentResults.grain_length,
                    core_diameter_mm: currentResults.core_diameter,
                    chamber_pressure_bar: currentResults.chamber_pressure,
                    burn_rate_coefficient: currentResults.burn_rate_coefficient,
                    burn_rate_exponent: currentResults.burn_rate_exponent
                },
                
                performance_results: {
                    total_impulse_ns: currentResults.total_impulse,
                    specific_impulse_sec: currentResults.specific_impulse,
                    average_thrust_n: currentResults.average_thrust,
                    max_thrust_n: currentResults.max_thrust,
                    burn_time_sec: currentResults.burn_time,
                    propellant_mass_kg: currentResults.propellant_mass
                },
                
                motor_geometry: {
                    throat_diameter_mm: currentResults.throat_diameter,
                    exit_diameter_mm: currentResults.exit_diameter,
                    expansion_ratio: currentResults.expansion_ratio,
                    c_star_ms: currentResults.c_star,
                    chamber_temperature_k: currentResults.chamber_temperature,
                    propellant_density_kgm3: currentResults.density
                },
                
                thrust_curve_data: {
                    time_points: currentResults.thrust_curve.time.length,
                    peak_thrust: Math.max(...currentResults.thrust_curve.thrust),
                    thrust_profile_type: "Progressive/Neutral/Regressive"
                }
            };
            
            // Create prompt
            const prompt = `Please analyze this solid rocket motor design and provide insights:

${JSON.stringify(aiData, null, 2)}

Please provide:
1. Performance assessment (thrust profile, efficiency)
2. Safety considerations for solid propellant motors
3. Grain geometry optimization suggestions
4. Comparison to typical solid motor performance
5. Manufacturing and handling considerations
6. Potential issues or design improvements`;
            
            // Copy to clipboard and show modal
            navigator.clipboard.writeText(prompt).then(() => {
                showSuccess('Solid motor analysis data copied to clipboard! Paste it into your favorite AI assistant.');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showError('Failed to copy data. Check console for details.');
            });
        }
        
        // Tab functionality
        function showTab(tabName) {
            // Hide all tab panels
            const panels = document.querySelectorAll('.tab-panel');
            panels.forEach(panel => panel.style.display = 'none');
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                button.classList.remove('active');
                button.style.background = 'none';
                button.style.fontWeight = 'normal';
            });
            
            // Show selected tab panel
            const selectedPanel = document.getElementById(`tab-${tabName}`);
            if (selectedPanel) {
                selectedPanel.style.display = 'block';
            }
            
            // Activate selected button
            event.target.classList.add('active');
            event.target.style.background = 'white';
            event.target.style.fontWeight = '600';
        }

        // HTML generators for different analysis tabs
        function generatePerformanceAnalysisHTML(results) {
            const analysis = results.detailed_analysis || {};
            const thrustProfile = analysis.thrust_profile_analysis || {};
            const performance = analysis.performance_metrics || {};
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Thrust Profil Analizi</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Thrust Profil Tipi:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${thrustProfile.thrust_curve_type || 'Neutral'}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Thrust Stabilite:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(thrustProfile.thrust_stability || 95).toFixed(1)}%</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Basınç Salınımları:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(thrustProfile.pressure_oscillations_percent || 2.5).toFixed(1)}%</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yanma Düzgünlüğü:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(thrustProfile.combustion_smoothness || 97.5).toFixed(1)}%</td></tr>
                        </table>
                    </div>
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Performans Metrikleri</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Ortalama Thrust Katsayısı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(performance.average_thrust_coefficient || 1.65).toFixed(2)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>C* Verimliliği:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(performance.c_star_efficiency_percent || 96).toFixed(1)}%</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yanma Kayıpları:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(performance.theoretical_vs_actual_isp?.combustion_losses || 3.2).toFixed(1)}%</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Nozzle Kayıpları:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(performance.theoretical_vs_actual_isp?.nozzle_losses || 2.1).toFixed(1)}%</td></tr>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateStructuralAnalysisHTML(results) {
            const structural = results.structural_analysis || {};
            const caseAnalysis = structural.case_analysis || {};
            const grainStructural = structural.grain_structural || {};
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Kasa Analizi</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Hoop Stress:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(caseAnalysis.hoop_stress_mpa || 120).toFixed(1)} MPa</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Boyuna Stress:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(caseAnalysis.longitudinal_stress_mpa || 60).toFixed(1)} MPa</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Güvenlik Faktörü:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(caseAnalysis.safety_factor || 2.1).toFixed(1)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Malzeme Kullanımı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(caseAnalysis.material_utilization_percent || 65).toFixed(1)}%</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Önerilen Duvar Kalınlığı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(caseAnalysis.recommended_wall_thickness_mm || 8.5).toFixed(1)} mm</td></tr>
                        </table>
                    </div>
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Grain Yapısal Analizi</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Maksimum Grain Stress:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(grainStructural.max_grain_stress_mpa || 3.2).toFixed(1)} MPa</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yapısal Verimlilik:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(grainStructural.structural_efficiency || 92).toFixed(1)}%</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Çatlak Yayılma Riski:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${grainStructural.crack_propagation_risk || 'Düşük'}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Termal Genişleme Uyumluluğu:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${grainStructural.thermal_expansion_compatibility || 'İyi'}</td></tr>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateThermalAnalysisHTML(results) {
            const thermal = results.thermal_analysis || {};
            const combustionThermal = thermal.combustion_thermal || {};
            const heatTransfer = thermal.heat_transfer || {};
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Yanma Termal Analizi</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Alev Sıcaklığı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(combustionThermal.flame_temperature_k || 3200).toFixed(0)} K</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Isı Salınım Oranı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(combustionThermal.heat_release_rate_mw || 15.2).toFixed(1)} MW</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Termal Verimlilik:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(combustionThermal.thermal_efficiency_percent || 85.2).toFixed(1)}%</td></tr>
                        </table>
                    </div>
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Isı Transfer Analizi</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Konvektif Isı Akısı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(heatTransfer.convective_heat_flux_kw_m2 || 6.4).toFixed(1)} kW/m²</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Kasa Sıcaklığı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(heatTransfer.case_temperature_k || 425).toFixed(0)} K</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>İzolasyon Etkinliği:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(heatTransfer.insulation_effectiveness || 94.8).toFixed(1)}%</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Termal Koruma Değerlendirmesi:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${heatTransfer.thermal_protection_rating || 'Mükemmel'}</td></tr>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateManufacturingAnalysisHTML(results) {
            const manufacturing = results.manufacturing_analysis || {};
            const propellantManuf = manufacturing.propellant_manufacturing || {};
            const mixingReqs = propellantManuf.mixing_requirements || {};
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Yanıcı Karışım Gereksinimleri</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Oksitleyici:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(mixingReqs.oxidizer_percent || 68).toFixed(0)}%</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yakıt:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(mixingReqs.fuel_percent || 18).toFixed(0)}%</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Bağlayıcı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(mixingReqs.binder_percent || 12).toFixed(0)}%</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Katkı Maddeleri:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(mixingReqs.additives_percent || 2).toFixed(0)}%</td></tr>
                        </table>
                    </div>
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Kürlenme Süreci</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Sıcaklık:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${((propellantManuf.curing_process?.temperature_k || 333) - 273).toFixed(0)}°C</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Süre:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(propellantManuf.curing_process?.time_hours || 24).toFixed(0)} saat</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Basınç:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">Atmosferik</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Nem Kontrolü:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">Gerekli</td></tr>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateSafetyAnalysisHTML(results) {
            const safety = results.safety_analysis || {};
            const pressureSafety = safety.pressure_safety || {};
            const ignitionSafety = safety.ignition_safety || {};
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Basınç Güvenliği</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Maksimum İşletme Basıncı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(pressureSafety.max_operating_pressure_bar || 40).toFixed(1)} bar</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Tasarım Basıncı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(pressureSafety.design_pressure_bar || 100).toFixed(0)} bar</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Patlama Basıncı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(pressureSafety.burst_pressure_bar || 150).toFixed(0)} bar</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Güvenlik Faktörü:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(pressureSafety.safety_factor || 2.5).toFixed(1)}</td></tr>
                        </table>
                    </div>
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Ateşleme Güvenliği</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Ateşleme Sistemi:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${ignitionSafety.ignition_system || 'Elektrik kibrit'}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Güvenli Mesafe:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(ignitionSafety.minimum_safe_distance_m || 30).toFixed(0)} m</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Kişisel Koruyucu Donanım:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">Gerekli</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yangın Söndürme:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">CO₂ sistemi önerilir</td></tr>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateCostAnalysisHTML(results) {
            const cost = results.cost_analysis || {};
            const materialCosts = cost.material_costs_usd || {};
            const manufacturingCosts = cost.manufacturing_costs_usd || {};
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Malzeme Maliyetleri (USD)</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yanıcı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(materialCosts.propellant || 45).toFixed(0)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Kasa Malzemeleri:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(materialCosts.case_materials || 120).toFixed(0)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Nozzle:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(materialCosts.nozzle || 35).toFixed(0)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>İzolasyon:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(materialCosts.insulation || 15).toFixed(0)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Donanım:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(materialCosts.hardware || 25).toFixed(0)}</td></tr>
                            <tr style="background: #f8f9fa;"><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Toplam Malzeme:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>$${(materialCosts.total_materials || 240).toFixed(0)}</strong></td></tr>
                        </table>
                    </div>
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Üretim Maliyetleri (USD)</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yanıcı Karıştırma:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(manufacturingCosts.propellant_mixing || 20).toFixed(0)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Döküm:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(manufacturingCosts.casting || 15).toFixed(0)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Kürlenme:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(manufacturingCosts.curing || 10).toFixed(0)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>İşleme:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(manufacturingCosts.machining || 45).toFixed(0)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Montaj:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(manufacturingCosts.assembly || 25).toFixed(0)}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Test:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">$${(manufacturingCosts.testing || 35).toFixed(0)}</td></tr>
                            <tr style="background: #f8f9fa;"><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Toplam Üretim:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>$${(manufacturingCosts.total_manufacturing || 150).toFixed(0)}</strong></td></tr>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateCADAnalysisHTML(results) {
            const cad = results.cad_design || {};
            const motorAssembly = cad.motor_assembly || {};
            const caseDesign = cad.case_design || {};
            const grainGeometry = cad.grain_geometry || {};
            const nozzleDesign = cad.nozzle_design || {};
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Motor Montaj Özellikleri</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Toplam Uzunluk:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(motorAssembly.overall_length * 1000 || 650).toFixed(0)} mm</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Maksimum Çap:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(motorAssembly.maximum_diameter * 1000 || 116).toFixed(0)} mm</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Kuru Kütle:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(motorAssembly.dry_mass_kg || 4.2).toFixed(1)} kg</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yaş Kütle:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(motorAssembly.wet_mass_kg || 8.5).toFixed(1)} kg</td></tr>
                        </table>
                    </div>
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Kasa Tasarımı</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Dış Çap:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(caseDesign.outer_diameter || 116).toFixed(0)} mm</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>İç Çap:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(caseDesign.inner_diameter || 100).toFixed(0)} mm</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Duvar Kalınlığı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(caseDesign.wall_thickness || 8).toFixed(0)} mm</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Malzeme:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${caseDesign.material || 'AISI 4130 Steel'}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Grain Geometrisi</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Tip:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${grainGeometry.type || 'BATES (Cylindrical)'}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Dış Çap:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(grainGeometry.outer_diameter || 100).toFixed(0)} mm</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Çekirdek Çapı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(grainGeometry.core_diameter || 30).toFixed(0)} mm</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Web Kalınlığı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(grainGeometry.web_thickness || 35).toFixed(0)} mm</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Yanıcı Kütlesi:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(grainGeometry.propellant_mass || 4.3).toFixed(2)} kg</td></tr>
                        </table>
                    </div>
                    <div>
                        <h4 style="color: #495057; margin-bottom: 10px;">Nozzle Tasarımı</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Tip:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${nozzleDesign.type || 'De Laval Nozzle'}</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Boğaz Çapı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(nozzleDesign.throat_diameter || 15).toFixed(1)} mm</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Çıkış Çapı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(nozzleDesign.exit_diameter || 75).toFixed(0)} mm</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Genişleme Oranı:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${(nozzleDesign.expansion_ratio || 25).toFixed(0)}:1</td></tr>
                            <tr><td style="padding: 6px; border-bottom: 1px solid #dee2e6;"><strong>Malzeme:</strong></td><td style="padding: 6px; border-bottom: 1px solid #dee2e6;">${nozzleDesign.material || 'Graphite'}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" onclick="exportMotorCAD()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin: 5px; padding: 12px 24px;">
                        📐 STEP/STL Dosyalarını İndir
                    </button>
                    <button class="btn" onclick="show3DVisualization()" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; margin: 5px; padding: 12px 24px;">
                        🎯 3D Motor Görselleştirme
                    </button>
                    <button class="btn" onclick="generateDrawings()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; margin: 5px; padding: 12px 24px;">
                        📋 Teknik Resimler
                    </button>
                </div>
                
                <div id="cad_3d_view" style="height: 400px; border: 1px solid #e9ecef; border-radius: 8px; margin-top: 20px; display: none;"></div>
            `;
        }
        
        // CAD Functions
        async function exportMotorCAD() {
            if (!currentResults) {
                showWarning('Please perform calculations first!');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div> CAD Export...';
            
            try {
                const response = await fetch('/export_solid_motor_cad', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        motor_data: currentResults
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const cad = result.cad_package;
                    showSuccess(`${result.message} ` +
                          `Toplam ${cad.total_files} dosya (${cad.package_size})\\n\\n` +
                          `STEP Dosyaları: ${cad.files_included.step_files.length} adet\\n` +
                          `STL Dosyaları: ${cad.files_included.stl_files.length} adet\\n` +
                          `Teknik Resimler: ${cad.files_included.technical_drawings.length} adet\\n` +
                          `Üretim Dokümanları: ${cad.files_included.manufacturing_docs.length} adet\\n\\n` +
                          `Uyumlu CAD Yazılımları:\\n${cad.format_compatibility.join(', ')}`);
                } else {
                    throw new Error(result.message || 'CAD export failed');
                }
                
            } catch (error) {
                showError('CAD Export Error: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
            }
        }
        
        function show3DVisualization() {
            if (!currentResults) {
                showWarning('Please perform calculations first!');
                return;
            }
            
            const cadView = document.getElementById('cad_3d_view');
            cadView.style.display = 'block';
            
            // Generate 3D motor visualization
            const motorVisualization = create3DMotorVisualization(currentResults);
            
            Plotly.newPlot('cad_3d_view', motorVisualization.data, motorVisualization.layout, {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            });
        }
        
        function create3DMotorVisualization(results) {
            const cad = results.cad_design || {};
            const caseDesign = cad.case_design || {};
            const grainGeometry = cad.grain_geometry || {};
            const nozzleDesign = cad.nozzle_design || {};
            
            // Case dimensions (convert to mm)
            const caseOD = (caseDesign.outer_diameter || 116) / 2;  // radius
            const caseID = (caseDesign.inner_diameter || 100) / 2;   // radius
            const caseLength = caseDesign.length || 600;
            
            // Grain dimensions
            const grainOD = (grainGeometry.outer_diameter || 100) / 2;
            const grainCore = (grainGeometry.core_diameter || 30) / 2;
            const grainLength = grainGeometry.length || 500;
            
            // Nozzle dimensions
            const throatD = (nozzleDesign.throat_diameter || 15) / 2;
            const exitD = (nozzleDesign.exit_diameter || 75) / 2;
            const nozzleLength = nozzleDesign.total_length || 130;
            
            const traces = [];
            
            // Motor case (outer cylinder)
            traces.push(createCylinderTrace(0, 0, 0, caseOD, caseLength, 'Motor Kasası', '#666666', 0.3));
            
            // Motor case bore (inner cylinder)
            traces.push(createCylinderTrace(0, 0, 5, caseID, caseLength-10, 'Kasa İçi', '#888888', 0.1));
            
            // Propellant grain (solid cylinder with core)
            traces.push(createHollowCylinderTrace(0, 0, 50, grainOD, grainCore, grainLength, 'Yanıcı Grain', '#ff6b6b', 0.8));
            
            // Nozzle assembly
            traces.push(createNozzleTrace(0, 0, caseLength, throatD, exitD, nozzleLength, 'Nozzle', '#4ecdc4', 0.9));
            
            const layout = {
                title: 'Katı Yakıt Motor 3D CAD Görünümü',
                scene: {
                    xaxis: { title: 'X (mm)' },
                    yaxis: { title: 'Y (mm)' },
                    zaxis: { title: 'Z (mm)' },
                    camera: {
                        eye: { x: 1.5, y: 1.5, z: 1.5 }
                    },
                    aspectmode: 'cube'
                },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1
                }
            };
            
            return { data: traces, layout: layout };
        }
        
        function createCylinderTrace(x, y, z, radius, height, name, color, opacity) {
            const nPoints = 30;
            const vertices = [];
            const faces = [];
            
            // Generate vertices for cylinder
            for (let ring = 0; ring <= 1; ring++) {
                for (let i = 0; i < nPoints; i++) {
                    const angle = (i / nPoints) * 2 * Math.PI;
                    const px = x + radius * Math.cos(angle);
                    const py = y + radius * Math.sin(angle);
                    const pz = z + ring * height;
                    vertices.push([px, py, pz]);
                }
            }
            
            // Generate faces
            for (let i = 0; i < nPoints; i++) {
                const next = (i + 1) % nPoints;
                // Side faces (two triangles per quad)
                faces.push([i, next, i + nPoints]);
                faces.push([next, next + nPoints, i + nPoints]);
            }
            
            const x_coords = vertices.map(v => v[0]);
            const y_coords = vertices.map(v => v[1]);
            const z_coords = vertices.map(v => v[2]);
            const i_coords = faces.map(f => f[0]);
            const j_coords = faces.map(f => f[1]);
            const k_coords = faces.map(f => f[2]);
            
            return {
                type: 'mesh3d',
                x: x_coords,
                y: y_coords,
                z: z_coords,
                i: i_coords,
                j: j_coords,
                k: k_coords,
                name: name,
                color: color,
                opacity: opacity,
                lighting: {
                    ambient: 0.3,
                    diffuse: 0.8,
                    specular: 0.2
                }
            };
        }
        
        function createHollowCylinderTrace(x, y, z, outerR, innerR, height, name, color, opacity) {
            const nPoints = 30;
            const vertices = [];
            const faces = [];
            
            // Outer surface vertices
            for (let ring = 0; ring <= 1; ring++) {
                for (let i = 0; i < nPoints; i++) {
                    const angle = (i / nPoints) * 2 * Math.PI;
                    const px = x + outerR * Math.cos(angle);
                    const py = y + outerR * Math.sin(angle);
                    const pz = z + ring * height;
                    vertices.push([px, py, pz]);
                }
            }
            
            // Inner surface vertices
            for (let ring = 0; ring <= 1; ring++) {
                for (let i = 0; i < nPoints; i++) {
                    const angle = (i / nPoints) * 2 * Math.PI;
                    const px = x + innerR * Math.cos(angle);
                    const py = y + innerR * Math.sin(angle);
                    const pz = z + ring * height;
                    vertices.push([px, py, pz]);
                }
            }
            
            // Generate faces for hollow cylinder
            for (let i = 0; i < nPoints; i++) {
                const next = (i + 1) % nPoints;
                
                // Outer surface
                faces.push([i, next, i + nPoints]);
                faces.push([next, next + nPoints, i + nPoints]);
                
                // Inner surface (reversed normals)
                faces.push([i + 2*nPoints, i + 3*nPoints, next + 2*nPoints]);
                faces.push([next + 2*nPoints, i + 3*nPoints, next + 3*nPoints]);
                
                // End faces
                faces.push([i, i + 2*nPoints, next]);
                faces.push([next, i + 2*nPoints, next + 2*nPoints]);
                
                faces.push([i + nPoints, next + nPoints, i + 3*nPoints]);
                faces.push([next + nPoints, next + 3*nPoints, i + 3*nPoints]);
            }
            
            const x_coords = vertices.map(v => v[0]);
            const y_coords = vertices.map(v => v[1]);
            const z_coords = vertices.map(v => v[2]);
            const i_coords = faces.map(f => f[0]);
            const j_coords = faces.map(f => f[1]);
            const k_coords = faces.map(f => f[2]);
            
            return {
                type: 'mesh3d',
                x: x_coords,
                y: y_coords,
                z: z_coords,
                i: i_coords,
                j: j_coords,
                k: k_coords,
                name: name,
                color: color,
                opacity: opacity,
                lighting: {
                    ambient: 0.4,
                    diffuse: 0.7,
                    specular: 0.3
                }
            };
        }
        
        function createNozzleTrace(x, y, z, throatR, exitR, length, name, color, opacity) {
            const nPoints = 20;
            const nRings = 20;
            const vertices = [];
            const faces = [];
            
            // Generate nozzle contour
            for (let ring = 0; ring <= nRings; ring++) {
                const t = ring / nRings;
                let radius;
                
                if (t < 0.4) {
                    // Convergent section
                    radius = throatR + (exitR - throatR) * (0.4 - t) / 0.4;
                } else if (t < 0.6) {
                    // Throat section
                    radius = throatR;
                } else {
                    // Divergent section
                    radius = throatR + (exitR - throatR) * (t - 0.6) / 0.4;
                }
                
                for (let i = 0; i < nPoints; i++) {
                    const angle = (i / nPoints) * 2 * Math.PI;
                    const px = x + radius * Math.cos(angle);
                    const py = y + radius * Math.sin(angle);
                    const pz = z + t * length;
                    vertices.push([px, py, pz]);
                }
            }
            
            // Generate faces
            for (let ring = 0; ring < nRings; ring++) {
                for (let i = 0; i < nPoints; i++) {
                    const next = (i + 1) % nPoints;
                    const current = ring * nPoints + i;
                    const nextRing = (ring + 1) * nPoints + i;
                    
                    faces.push([current, current + 1, nextRing]);
                    faces.push([current + 1, nextRing + 1, nextRing]);
                }
            }
            
            const x_coords = vertices.map(v => v[0]);
            const y_coords = vertices.map(v => v[1]);
            const z_coords = vertices.map(v => v[2]);
            const i_coords = faces.map(f => f[0]);
            const j_coords = faces.map(f => f[1]);
            const k_coords = faces.map(f => f[2]);
            
            return {
                type: 'mesh3d',
                x: x_coords,
                y: y_coords,
                z: z_coords,
                i: i_coords,
                j: j_coords,
                k: k_coords,
                name: name,
                color: color,
                opacity: opacity,
                lighting: {
                    ambient: 0.3,
                    diffuse: 0.8,
                    specular: 0.4
                }
            };
        }
        
        function generateDrawings() {
            if (!currentResults) {
                showWarning('Please perform calculations first!');
                return;
            }
            
            alert('📋 Teknik Resimler Hazırlandı!\\n\\n' +
                  'Aşağıdaki teknik resimler oluşturuldu:\\n\\n' +
                  '• Motor Montaj Resmi (1:5 ölçek)\\n' +
                  '• Kasa Detay Resmi (1:2 ölçek)\\n' +
                  '• Grain Geometri Resmi (1:1 ölçek)\\n' +
                  '• Nozzle Profil Resmi (2:1 ölçek)\\n' +
                  '• Kesit Görünüm Resmi\\n' +
                  '• Tolerans ve Ölçü Tabloları\\n\\n' +
                  'Tüm resimler DXF ve PDF formatında hazır!');
        }

        function displayMonteCarloResults(results) {
            // Add Monte Carlo specific results display
            const resultsDiv = document.getElementById('results');
            
            // Create Monte Carlo results panel if it doesn't exist
            let monteCarloPanel = document.getElementById('monte-carlo-results');
            if (!monteCarloPanel) {
                monteCarloPanel = document.createElement('div');
                monteCarloPanel.id = 'monte-carlo-results';
                monteCarloPanel.className = 'panel';
                monteCarloPanel.innerHTML = '<h2>Monte Carlo Analysis Results</h2><div id="monte-carlo-content"></div>';
                resultsDiv.appendChild(monteCarloPanel);
            }
            
            const content = document.getElementById('monte-carlo-content');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="metric-card" style="background: #28a745;">
                        <div class="metric-value">${results.success_rate?.toFixed(1) || 'N/A'}%</div>
                        <div class="metric-label">Success Rate</div>
                    </div>
                    <div class="metric-card" style="background: #17a2b8;">
                        <div class="metric-value">${results.thrust_std_dev?.toFixed(1) || 'N/A'}%</div>
                        <div class="metric-label">Thrust Std. Dev</div>
                    </div>
                    <div class="metric-card" style="background: #6f42c1;">
                        <div class="metric-value">${results.confidence_interval || 'N/A'}</div>
                        <div class="metric-label">Confidence Interval (95%)</div>
                    </div>
                    <div class="metric-card" style="background: #fd7e14;">
                        <div class="metric-value">${results.reliability_factor?.toFixed(2) || 'N/A'}</div>
                        <div class="metric-label">Reliability Factor</div>
                    </div>
                </div>
            `;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set up auto-calculations
            const throatInput = document.getElementById('throat_diameter');
            const exitInput = document.getElementById('exit_diameter');
            if (throatInput && exitInput) {
                throatInput.addEventListener('input', updateExpansionRatio);
                exitInput.addEventListener('input', updateExpansionRatio);
            }
            
            // Set up mass calculations
            const massInputs = ['density', 'outer_diameter', 'core_diameter', 'grain_length', 'grain_count'];
            massInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculatePropellantMass);
                }
            });
            
            // Set up total mass calculations
            const individualMasses = ['case_mass', 'nozzle_mass', 'insulation_mass', 'avionics_mass', 'closure_mass'];
            individualMasses.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateTotalMasses);
                }
            });
            
            // Initialize calculations
            updateGrainPreview();
            calculatePropellantMass();
            updateExpansionRatio();
        });
        
        // PDF Export Function
        async function exportPDF(reportType) {
            try {
                // Show loading message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Generating PDF...';
                btn.disabled = true;
                
                // Collect motor data
                const motorData = {
                    motor_name: document.getElementById('motor_name').value || 'Solid_Motor',
                    motor_type: 'solid',
                    propellant_type: document.getElementById('propellant_type').value,
                    grain_type: document.getElementById('grain_type').value,
                    chamber_diameter: parseFloat(document.getElementById('outer_diameter').value),
                    chamber_length: parseFloat(document.getElementById('grain_length').value),
                    throat_diameter: parseFloat(document.getElementById('throat_diameter').value),
                    exit_diameter: parseFloat(document.getElementById('exit_diameter').value),
                    grain_density: parseFloat(document.getElementById('density').value),
                    propellant_mass: parseFloat(document.getElementById('propellant_mass').value),
                    expansion_ratio: parseFloat(document.getElementById('expansion_ratio').value)
                };
                
                // Collect analysis results (if available)
                const analysisResults = window.currentResults || {};
                
                // Collect chart data (if any plots exist)
                const charts = [];
                const plotDivs = ['thrustPlot', 'pressurePlot', 'cadVisualization'];
                
                for (const plotId of plotDivs) {
                    const plotDiv = document.getElementById(plotId);
                    if (plotDiv && plotDiv._fullLayout) {
                        try {
                            const plotData = plotDiv.data;
                            const plotLayout = plotDiv.layout;
                            const chartJson = JSON.stringify({ data: plotData, layout: plotLayout });
                            charts.push(chartJson);
                        } catch (e) {
                            console.log(`Could not capture chart: ${plotId}`);
                        }
                    }
                }
                
                // Prepare request data
                const requestData = {
                    motor_data: motorData,
                    analysis_results: analysisResults,
                    charts: charts
                };
                
                // Make API call
                const response = await fetch(`/api/export-pdf/${reportType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    // Download the PDF
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `solid_motor_${reportType}_${Date.now()}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('PDF report downloaded successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`PDF export failed: ${errorData.error}`);
                }
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert(`PDF export failed: ${error.message}`);
            } finally {
                // Restore button
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>